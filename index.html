<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>xiaohua&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="xiaohua&#39;blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="xiaohua&#39;blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="xiaohua">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="xiaohua&#39;blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xiaohua&#39;blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">每个微小的个体都有发光的权利</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/tags">tags</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Tomcat 专题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/Tomcat%20%E4%B8%93%E9%A2%98/" class="article-date">
  <time datetime="2020-03-18T14:35:16.999Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/Tomcat%20%E4%B8%93%E9%A2%98/">Tomcat 专题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Tomcat-专题"><a href="#Tomcat-专题" class="headerlink" title="Tomcat 专题"></a>Tomcat 专题</h1><h2 id="课程内容"><a href="#课程内容" class="headerlink" title="课程内容"></a>课程内容</h2><table>
<thead>
<tr>
<th align="center">序号</th>
<th>第一天</th>
<th>第二天</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td>Tomcat 基础</td>
<td>Web 应用配置</td>
</tr>
<tr>
<td align="center">2</td>
<td>Tomcat 架构</td>
<td>Tomcat管理配置</td>
</tr>
<tr>
<td align="center">3</td>
<td>Jasper</td>
<td>JVM配置</td>
</tr>
<tr>
<td align="center">4</td>
<td>Tomcat 服务器配置</td>
<td>Tomcat集群</td>
</tr>
<tr>
<td align="center">5</td>
<td></td>
<td>Tomcat安全</td>
</tr>
<tr>
<td align="center">6</td>
<td></td>
<td>Tomcat性能调优</td>
</tr>
<tr>
<td align="center">7</td>
<td></td>
<td>Tomcat 附件功能</td>
</tr>
</tbody></table>
<h2 id="1-Tomcat-基础"><a href="#1-Tomcat-基础" class="headerlink" title="1.Tomcat 基础"></a>1.Tomcat 基础</h2><h3 id="1-1-web-概念"><a href="#1-1-web-概念" class="headerlink" title="1.1 web 概念"></a>1.1 web 概念</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1）. 软件架构</span><br><span class="line"></span><br><span class="line">	1. C&#x2F;S： 客户端&#x2F;服务器端 ------------&gt; QQ , 360 ....</span><br><span class="line">	</span><br><span class="line">	2. B&#x2F;S： 浏览器&#x2F;服务器端 ------------&gt; 京东， 网易 ， 淘宝 ， 传智播客官网</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">2）. 资源分类</span><br><span class="line"></span><br><span class="line">	1. 静态资源： 所有用户访问后，得到的结果都是一样的，称为静态资源。静态资源可以直接被浏览器解析。</span><br><span class="line">		* 如： html,css,JavaScript，jpg</span><br><span class="line">		</span><br><span class="line">	2. 动态资源: 每个用户访问相同资源后，得到的结果可能不一样 , 称为动态资源。动态资源被访问后，需要先转换为静态资源，再返回给浏览器，通过浏览器进行解析。</span><br><span class="line">		* 如：servlet&#x2F;jsp,php,asp....</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">3）. 网络通信三要素</span><br><span class="line"></span><br><span class="line">	1. IP：电子设备(计算机)在网络中的唯一标识。</span><br><span class="line">	</span><br><span class="line">	2. 端口：应用程序在计算机中的唯一标识。 0~65536</span><br><span class="line">	</span><br><span class="line">	3. 传输协议：规定了数据传输的规则</span><br><span class="line">		</span><br><span class="line">		1. 基础协议：</span><br><span class="line">			</span><br><span class="line">			1. tcp : 安全协议，三次握手。 速度稍慢</span><br><span class="line">			</span><br><span class="line">			2. udp：不安全协议。 速度快</span><br></pre></td></tr></table></figure>



<h3 id="1-2-常见的web服务器"><a href="#1-2-常见的web服务器" class="headerlink" title="1.2 常见的web服务器"></a>1.2 常见的web服务器</h3><h4 id="1-2-1-概念"><a href="#1-2-1-概念" class="headerlink" title="1.2.1 概念"></a>1.2.1 概念</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1）. 服务器：安装了服务器软件的计算机</span><br><span class="line"></span><br><span class="line">2）. 服务器软件：接收用户的请求，处理请求，做出响应</span><br><span class="line"></span><br><span class="line">3）. web服务器软件：接收用户的请求，处理请求，做出响应。</span><br><span class="line"></span><br><span class="line">	在web服务器软件中，可以部署web项目，让用户通过浏览器来访问这些项目</span><br></pre></td></tr></table></figure>



<h4 id="1-2-2-常见web服务器软件"><a href="#1-2-2-常见web服务器软件" class="headerlink" title="1.2.2 常见web服务器软件"></a>1.2.2 常见web服务器软件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1). webLogic：oracle公司，大型的JavaEE服务器，支持所有的JavaEE规范，收费的。</span><br><span class="line"></span><br><span class="line">2). webSphere：IBM公司，大型的JavaEE服务器，支持所有的JavaEE规范，收费的。</span><br><span class="line"></span><br><span class="line">3). JBOSS：JBOSS公司的，大型的JavaEE服务器，支持所有的JavaEE规范，收费的。</span><br><span class="line"></span><br><span class="line">4). Tomcat：Apache基金组织，中小型的JavaEE服务器，仅仅支持少量的JavaEE规范servlet&#x2F;jsp。开源的，免费的。</span><br></pre></td></tr></table></figure>



<h3 id="1-3-Tomcat-历史"><a href="#1-3-Tomcat-历史" class="headerlink" title="1.3 Tomcat 历史"></a>1.3 Tomcat 历史</h3><p>1） Tomcat 最初由Sun公司的软件架构师 James Duncan Davidson 开发，名称为 “JavaWebServer”。</p>
<p>2） 1999年 ，在 Davidson 的帮助下，该项目于1999年于apache 软件基金会旗下的 JServ 项目合并，并发布第一个版本（3.x）, 即是现在的Tomcat，该版本实现了Servlet2.2 和 JSP 1.1 规范 。</p>
<p>3） 2001年，Tomcat 发布了4.0版本， 作为里程碑式的版本，Tomcat 完全重新设计了其架构，并实现了 Servlet 2.3 和 JSP1.2规范。</p>
<p>目前 Tomcat 已经更新到 9.0.x版本 ， 但是目前企业中的Tomcat服务器， 主流版本还是 7.x 和 8.x ， 所以本课程是基于 8.5 版本进行讲解。</p>
<h3 id="1-4-Tomcat-安装"><a href="#1-4-Tomcat-安装" class="headerlink" title="1.4 Tomcat 安装"></a>1.4 Tomcat 安装</h3><h4 id="1-4-1-下载"><a href="#1-4-1-下载" class="headerlink" title="1.4.1 下载"></a>1.4.1 下载</h4><p><a href="https://tomcat.apache.org/download-80.cgi" target="_blank" rel="noopener">https://tomcat.apache.org/download-80.cgi</a></p>
<p><img src="assets/1560579956706.png" alt="1560579956706"> </p>
<h4 id="1-4-2-安装"><a href="#1-4-2-安装" class="headerlink" title="1.4.2 安装"></a>1.4.2 安装</h4><p>将下载的 .zip 压缩包 ， 解压到系统的目录（建议是没有中文不带空格的目录）下即可。</p>
<h3 id="1-5-Tomcat-目录结构"><a href="#1-5-Tomcat-目录结构" class="headerlink" title="1.5 Tomcat 目录结构"></a>1.5 Tomcat 目录结构</h3><p>Tomcat 的主要目录文件如下 ：</p>
<table>
<thead>
<tr>
<th><strong>目录</strong></th>
<th><strong>目录下文件</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>bin</strong></td>
<td>/</td>
<td>存放Tomcat的启动、停止等批处理脚本文件</td>
</tr>
<tr>
<td></td>
<td>startup.bat , startup.sh</td>
<td>用于在windows和linux下的启动脚本</td>
</tr>
<tr>
<td></td>
<td>shutdown.bat , shutdown.sh</td>
<td>用于在windows和linux下的停止脚本</td>
</tr>
<tr>
<td><strong>conf</strong></td>
<td>/</td>
<td>用于存放Tomcat的相关配置文件</td>
</tr>
<tr>
<td></td>
<td>Catalina</td>
<td>用于存储针对每个虚拟机的Context配置</td>
</tr>
<tr>
<td></td>
<td>context.xml</td>
<td>用于定义所有web应用均需加载的Context配置，如果web应用指定了自己的context.xml ，该文件将被覆盖</td>
</tr>
<tr>
<td></td>
<td>catalina.properties</td>
<td>Tomcat 的环境变量配置</td>
</tr>
<tr>
<td></td>
<td>catalina.policy</td>
<td>Tomcat 运行的安全策略配置</td>
</tr>
<tr>
<td></td>
<td>logging.properties</td>
<td>Tomcat 的日志配置文件， 可以通过该文件修改Tomcat  的日志级别及日志路径等</td>
</tr>
<tr>
<td></td>
<td>server.xml</td>
<td>Tomcat 服务器的核心配置文件</td>
</tr>
<tr>
<td></td>
<td>tomcat-users.xml</td>
<td>定义Tomcat默认的用户及角色映射信息配置</td>
</tr>
<tr>
<td></td>
<td>web.xml</td>
<td>Tomcat 中所有应用默认的部署描述文件， 主要定义了基础Servlet和MIME映射。</td>
</tr>
<tr>
<td><strong>lib</strong></td>
<td>/</td>
<td>Tomcat 服务器的依赖包</td>
</tr>
<tr>
<td><strong>logs</strong></td>
<td>/</td>
<td>Tomcat 默认的日志存放目录</td>
</tr>
<tr>
<td><strong>webapps</strong></td>
<td>/</td>
<td>Tomcat 默认的Web应用部署目录</td>
</tr>
<tr>
<td><strong>work</strong></td>
<td>/</td>
<td>Web 应用JSP代码生成和编译的临时目录</td>
</tr>
</tbody></table>
<h3 id="1-6-Tomcat-启动停止"><a href="#1-6-Tomcat-启动停止" class="headerlink" title="1.6 Tomcat 启动停止"></a>1.6 Tomcat 启动停止</h3><p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">双击 bin&#x2F;startup.bat 文件 ；</span><br></pre></td></tr></table></figure>

<p>停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">双击 bin&#x2F;shutdown.bat 文件 ；</span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080</span><br></pre></td></tr></table></figure>

<p><img src="assets/1560583456498.png" alt="1560583456498"> </p>
<h3 id="1-7-Tomcat源码"><a href="#1-7-Tomcat源码" class="headerlink" title="1.7 Tomcat源码"></a>1.7 Tomcat源码</h3><h4 id="1-7-1-下载"><a href="#1-7-1-下载" class="headerlink" title="1.7.1 下载"></a>1.7.1 下载</h4><p>地址： <a href="https://tomcat.apache.org/download-80.cgi" target="_blank" rel="noopener">https://tomcat.apache.org/download-80.cgi</a></p>
<p><img src="assets/1561476556938.png" alt="1561476556938"> </p>
<h4 id="1-7-2-运行"><a href="#1-7-2-运行" class="headerlink" title="1.7.2 运行"></a>1.7.2 运行</h4><p>1） 解压zip压缩包</p>
<p>2） 进入解压目录，并创建一个目录，命名为home ， 并将conf、webapps目录移入home 目录中</p>
<p>3） 在当前目录下创建一个 pom.xml 文件，引入tomcat的依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apache-tomcat-8.5.42-src<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Tomcat8.5<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>Tomcat8.5<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- &lt;testSourceDirectory&gt;test&lt;/testSourceDirectory&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- &lt;testResources&gt;</span></span><br><span class="line"><span class="comment">           &lt;testResource&gt;</span></span><br><span class="line"><span class="comment">                &lt;directory&gt;test&lt;/directory&gt;</span></span><br><span class="line"><span class="comment">           &lt;/testResource&gt;</span></span><br><span class="line"><span class="comment">        &lt;/testResources&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.easymock<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easymock<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ant<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ant<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>wsdl4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wsdl4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxrpc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jdt.core.compiler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ecj<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4） 在idea中， 导入该工程。</p>
<p><img src="assets/1561477805695.png" alt="1561477805695"> </p>
<p>5） 配置idea的启动类， 配置 MainClass ， 并配置 VM 参数。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-Dcatalina.home</span>=<span class="string">D:/idea-workspace/itcast_project_tomcat/apache-tomcat-8.5.42-src/home</span></span><br><span class="line"><span class="meta">-Dcatalina.base</span>=<span class="string">D:/idea-workspace/itcast_project_tomcat/apache-tomcat-8.5.42-src/home</span></span><br><span class="line"><span class="meta">-Djava.util.logging.manager</span>=<span class="string">org.apache.juli.ClassLoaderLogManager</span></span><br><span class="line"><span class="meta">-Djava.util.logging.config.file</span>=<span class="string">D:/idea-workspace/itcast_project_tomcat/apache-tomcat-8.5.42-src/home/conf/logging.properties</span></span><br></pre></td></tr></table></figure>

<p><img src="assets/1561477911915.png" alt="1561477911915"> </p>
<p>6） 启动主方法， 运行Tomcat ， 访问Tomcat 。</p>
<p><img src="assets/1561478100639.png" alt="1561478100639"> </p>
<p>出现上述异常的原因，是我们直接启动org.apache.catalina.startup.Bootstrap的时候没有加载JasperInitializer，从而无法编译JSP。解决办法是在tomcat的源码ContextConfig中的configureStart函数中手动将JSP解析器初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.addServletContainerInitializer(new JasperInitializer(), null);</span><br></pre></td></tr></table></figure>

<p><img src="assets/1561478220305.png" alt="1561478220305"> </p>
<p>7） 重启tomcat就可以正常访问了。</p>
<p><img src="assets/1561478284441.png" alt="1561478284441"> </p>
<h2 id="2-Tomcat-架构"><a href="#2-Tomcat-架构" class="headerlink" title="2.Tomcat 架构"></a>2.Tomcat 架构</h2><h3 id="2-1-Http工作原理"><a href="#2-1-Http工作原理" class="headerlink" title="2.1 Http工作原理"></a>2.1 Http工作原理</h3><p>HTTP协议是浏览器与服务器之间的数据传送协议。作为应用层协议，HTTP是基于TCP/IP协议来传递数据的（HTML文件、图片、查询结果等），HTTP协议不涉及数据包（Packet）传输，主要规定了客户端和服务器之间的通信格式。</p>
<p><img src="assets/1560696193103.png" alt="1560696193103"> </p>
<p>从图上你可以看到，这个过程是：</p>
<p>1） 用户通过浏览器进行了一个操作，比如输入网址并回车，或者是点击链接，接着浏览器获取了这个事件。</p>
<p>2） 浏览器向服务端发出TCP连接请求。</p>
<p>3） 服务程序接受浏览器的连接请求，并经过TCP三次握手建立连接。</p>
<p>4） 浏览器将请求数据打包成一个HTTP协议格式的数据包。</p>
<p>5） 浏览器将该数据包推入网络，数据包经过网络传输，最终达到端服务程序。</p>
<p>6） 服务端程序拿到这个数据包后，同样以HTTP协议格式解包，获取到客户端的意图。</p>
<p>7） 得知客户端意图后进行处理，比如提供静态文件或者调用服务端程序获得动态结果。</p>
<p>8） 服务器将响应结果（可能是HTML或者图片等）按照HTTP协议格式打包。</p>
<p>9） 服务器将响应数据包推入网络，数据包经过网络传输最终达到到浏览器。</p>
<p>10） 浏览器拿到数据包后，以HTTP协议的格式解包，然后解析数据，假设这里的数据是HTML。</p>
<p>11） 浏览器将HTML文件展示在页面上。</p>
<p>那我们想要探究的Tomcat作为一个HTTP服务器，在这个过程中都做了些什么事情呢？主要是接受连接、解析请求数据、处理请求和发送响应这几个步骤。</p>
<h3 id="2-2-Tomcat整体架构"><a href="#2-2-Tomcat整体架构" class="headerlink" title="2.2 Tomcat整体架构"></a>2.2 Tomcat整体架构</h3><h4 id="2-2-1-Http服务器请求处理"><a href="#2-2-1-Http服务器请求处理" class="headerlink" title="2.2.1 Http服务器请求处理"></a>2.2.1 Http服务器请求处理</h4><p>浏览器发给服务端的是一个HTTP格式的请求，HTTP服务器收到这个请求后，需要调用服务端程序来处理，所谓的服务端程序就是你写的Java类，一般来说不同的请求需要由不同的Java类来处理。</p>
<p><img src="assets/1560697061415.png" alt="1560697061415">  </p>
<p>1） 图1 ， 表示HTTP服务器直接调用具体业务类，它们是紧耦合的。</p>
<p>2） 图2，HTTP服务器不直接调用业务类，而是把请求交给容器来处理，容器通过Servlet接口调用业务类。因此Servlet接口和Servlet容器的出现，达到了HTTP服务器与业务类解耦的目的。而Servlet接口和Servlet容器这一整套规范叫作Servlet规范。Tomcat按照Servlet规范的要求实现了Servlet容器，同时它们也具有HTTP服务器的功能。作为Java程序员，如果我们要实现新的业务功能，只需要实现一个Servlet，并把它注册到Tomcat（Servlet容器）中，剩下的事情就由Tomcat帮我们处理了。</p>
<h4 id="2-2-2-Servlet容器工作流程"><a href="#2-2-2-Servlet容器工作流程" class="headerlink" title="2.2.2 Servlet容器工作流程"></a>2.2.2 Servlet容器工作流程</h4><p>为了解耦，HTTP服务器不直接调用Servlet，而是把请求交给Servlet容器来处理，那Servlet容器又是怎么工作的呢？</p>
<p>当客户请求某个资源时，HTTP服务器会用一个ServletRequest对象把客户的请求信息封装起来，然后调用Servlet容器的service方法，Servlet容器拿到请求后，根据请求的URL和Servlet的映射关系，找到相应的Servlet，如果Servlet还没有被加载，就用反射机制创建这个Servlet，并调用Servlet的init方法来完成初始化，接着调用Servlet的service方法来处理请求，把ServletResponse对象返回给HTTP服务器，HTTP服务器会把响应发送给客户端。</p>
<p><img src="assets/1560833167711.png" alt="1560833167711"> </p>
<h4 id="2-2-3-Tomcat整体架构"><a href="#2-2-3-Tomcat整体架构" class="headerlink" title="2.2.3 Tomcat整体架构"></a>2.2.3 Tomcat整体架构</h4><p>我们知道如果要设计一个系统，首先是要了解需求，我们已经了解了Tomcat要实现两个核心功能：</p>
<p>1） 处理Socket连接，负责网络字节流与Request和Response对象的转化。<br>2） 加载和管理Servlet，以及具体处理Request请求。</p>
<p>因此Tomcat设计了两个核心组件连接器（Connector）和容器（Container）来分别做这两件事情。连接器负责对外交流，容器负责内部处理。</p>
<p><img src="assets/1560660827492.png" alt="1560660827492"> </p>
<h3 id="2-3-连接器-Coyote"><a href="#2-3-连接器-Coyote" class="headerlink" title="2.3 连接器 - Coyote"></a>2.3 连接器 - Coyote</h3><h4 id="2-3-1-架构介绍"><a href="#2-3-1-架构介绍" class="headerlink" title="2.3.1 架构介绍"></a>2.3.1 架构介绍</h4><p>Coyote 是Tomcat的连接器框架的名称 , 是Tomcat服务器提供的供客户端访问的外部接口。客户端通过Coyote与服务器建立连接、发送请求并接受响应 。</p>
<p>Coyote 封装了底层的网络通信（Socket 请求及响应处理），为Catalina 容器提供了统一的接口，使Catalina 容器与具体的请求协议及IO操作方式完全解耦。Coyote 将Socket 输入转换封装为 Request 对象，交由Catalina 容器进行处理，处理请求完成后, Catalina 通过Coyote 提供的Response 对象将结果写入输出流 。</p>
<p>Coyote 作为独立的模块，只负责具体协议和IO的相关操作， 与Servlet 规范实现没有直接关系，因此即便是 Request 和 Response 对象也并未实现Servlet规范对应的接口， 而是在Catalina 中将他们进一步封装为ServletRequest 和 ServletResponse 。</p>
<p><img src="assets/1561166229095.png" alt="1561166229095"> </p>
<h4 id="2-3-2-IO模型与协议"><a href="#2-3-2-IO模型与协议" class="headerlink" title="2.3.2 IO模型与协议"></a>2.3.2 IO模型与协议</h4><p>在Coyote中 ， Tomcat支持的多种I/O模型和应用层协议，具体包含哪些IO模型和应用层协议，请看下表：</p>
<p>Tomcat 支持的IO模型（自8.5/9.0 版本起，Tomcat 移除了 对 BIO 的支持）：</p>
<table>
<thead>
<tr>
<th>IO模型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>NIO</td>
<td>非阻塞I/O，采用Java NIO类库实现。</td>
</tr>
<tr>
<td>NIO2</td>
<td>异步I/O，采用JDK 7最新的NIO2类库实现。</td>
</tr>
<tr>
<td>APR</td>
<td>采用Apache可移植运行库实现，是C/C++编写的本地库。如果选择该方案，需要单独安装APR库。</td>
</tr>
</tbody></table>
<p>Tomcat 支持的应用层协议 ：</p>
<table>
<thead>
<tr>
<th>应用层协议</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP/1.1</td>
<td>这是大部分Web应用采用的访问协议。</td>
</tr>
<tr>
<td>AJP</td>
<td>用于和Web服务器集成（如Apache），以实现对静态资源的优化以及集群部署，当前支持AJP/1.3。</td>
</tr>
<tr>
<td>HTTP/2</td>
<td>HTTP 2.0大幅度的提升了Web性能。下一代HTTP协议 ， 自8.5以及9.0版本之后支持。</td>
</tr>
</tbody></table>
<p>协议分层 ： </p>
<p><img src="assets/1561170015860.png" alt="1561170015860"> </p>
<p>在 8.0 之前 ， Tomcat 默认采用的I/O方式为 BIO ， 之后改为 NIO。 无论 NIO、NIO2 还是 APR， 在性能方面均优于以往的BIO。 如果采用APR， 甚至可以达到 Apache HTTP Server 的影响性能。</p>
<p>Tomcat为了实现支持多种I/O模型和应用层协议，一个容器可能对接多个连接器，就好比一个房间有多个门。但是单独的连接器或者容器都不能对外提供服务，需要把它们组装起来才能工作，组装后这个整体叫作Service组件。这里请你注意，Service本身没有做什么重要的事情，只是在连接器和容器外面多包了一层，把它们组装在一起。Tomcat内可能有多个Service，这样的设计也是出于灵活性的考虑。通过在Tomcat中配置多个Service，可以实现通过不同的端口号来访问同一台机器上部署的不同应用。</p>
<h4 id="2-3-3-连接器组件"><a href="#2-3-3-连接器组件" class="headerlink" title="2.3.3 连接器组件"></a>2.3.3 连接器组件</h4><p><img src="assets/1560661868721.png" alt="1560661868721"> </p>
<p>连接器中的各个组件的作用如下：</p>
<p><strong>EndPoint</strong></p>
<p>1） EndPoint ： Coyote 通信端点，即通信监听的接口，是具体Socket接收和发送处理器，是对传输层的抽象，因此EndPoint用来实现TCP/IP协议的。</p>
<p>2） Tomcat 并没有EndPoint 接口，而是提供了一个抽象类AbstractEndpoint ， 里面定义了两个内部类：Acceptor和SocketProcessor。Acceptor用于监听Socket连接请求。SocketProcessor用于处理接收到的Socket请求，它实现Runnable接口，在Run方法里调用协议处理组件Processor进行处理。为了提高处理能力，SocketProcessor被提交到线程池来执行。而这个线程池叫作执行器（Executor)，我在后面的专栏会详细介绍Tomcat如何扩展原生的Java线程池。</p>
<p><strong>Processor</strong></p>
<p>Processor ： Coyote 协议处理接口 ，如果说EndPoint是用来实现TCP/IP协议的，那么Processor用来实现HTTP协议，Processor接收来自EndPoint的Socket，读取字节流解析成Tomcat Request和Response对象，并通过Adapter将其提交到容器处理，Processor是对应用层协议的抽象。</p>
<p><strong>ProtocolHandler</strong></p>
<p>ProtocolHandler： Coyote 协议接口， 通过Endpoint 和 Processor ， 实现针对具体协议的处理能力。Tomcat 按照协议和I/O 提供了6个实现类 ： AjpNioProtocol ， AjpAprProtocol， AjpNio2Protocol ， Http11NioProtocol ，Http11Nio2Protocol ，Http11AprProtocol。我们在配置tomcat/conf/server.xml 时 ， 至少要指定具体的ProtocolHandler , 当然也可以指定协议名称 ， 如 ： HTTP/1.1 ，如果安装了APR，那么将使用Http11AprProtocol ， 否则使用 Http11NioProtocol 。</p>
<p><strong>Adapter</strong></p>
<p>由于协议不同，客户端发过来的请求信息也不尽相同，Tomcat定义了自己的Request类来“存放”这些请求信息。ProtocolHandler接口负责解析请求并生成Tomcat Request类。但是这个Request对象不是标准的ServletRequest，也就意味着，不能用Tomcat Request作为参数来调用容器。Tomcat设计者的解决方案是引入CoyoteAdapter，这是适配器模式的经典运用，连接器调用CoyoteAdapter的Sevice方法，传入的是Tomcat Request对象，CoyoteAdapter负责将Tomcat Request转成ServletRequest，再调用容器的Service方法。</p>
<h4 id="2-3-4-源码解析"><a href="#2-3-4-源码解析" class="headerlink" title="2.3.4 源码解析"></a>2.3.4 源码解析</h4><p>具体的源码解析，请参考2.5 ， 2.6 章节讲解的Tomcat启动流程及请求处理流程</p>
<h3 id="2-4-容器-Catalina"><a href="#2-4-容器-Catalina" class="headerlink" title="2.4 容器 - Catalina"></a>2.4 容器 - Catalina</h3><p>Tomcat是一个由一系列可配置的组件构成的Web容器，而Catalina是Tomcat的servlet容器。</p>
<p>Catalina 是Servlet 容器实现，包含了之前讲到的所有的容器组件，以及后续章节涉及到的安全、会话、集群、管理等Servlet 容器架构的各个方面。它通过松耦合的方式集成Coyote，以完成按照请求协议进行数据读写。同时，它还包括我们的启动入口、Shell程序等。</p>
<h4 id="2-4-1-Catalina-地位"><a href="#2-4-1-Catalina-地位" class="headerlink" title="2.4.1 Catalina 地位"></a>2.4.1 Catalina 地位</h4><p>Tomcat 的模块分层结构图， 如下：</p>
<p><img src="assets/1561197171566.png" alt="1561197171566"> </p>
<p>Tomcat 本质上就是一款 Servlet 容器， 因此Catalina 才是 Tomcat 的核心 ， 其他模块都是为Catalina 提供支撑的。 比如 ： 通过Coyote 模块提供链接通信，Jasper 模块提供JSP引擎，Naming 提供JNDI 服务，Juli 提供日志服务。</p>
<h4 id="2-4-2-Catalina-结构"><a href="#2-4-2-Catalina-结构" class="headerlink" title="2.4.2 Catalina 结构"></a>2.4.2 Catalina 结构</h4><p>Catalina 的主要组件结构如下：</p>
<p><img src="assets/1561197958434.png" alt="1561197958434"> </p>
<p>如上图所示，Catalina负责管理Server，而Server表示着整个服务器。Server下面有多个服务Service，每个服务都包含着多个连接器组件Connector（Coyote 实现）和一个容器组件Container。在Tomcat 启动的时候， 会初始化一个Catalina的实例。</p>
<p>Catalina 各个组件的职责：</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td>Catalina</td>
<td>负责解析Tomcat的配置文件 , 以此来创建服务器Server组件，并根据命令来对其进行管理</td>
</tr>
<tr>
<td>Server</td>
<td>服务器表示整个Catalina Servlet容器以及其它组件，负责组装并启动Servlet引擎,Tomcat连接器。Server通过实现Lifecycle接口，提供了一种优雅的启动和关闭整个系统的方式</td>
</tr>
<tr>
<td>Service</td>
<td>服务是Server内部的组件，一个Server包含多个Service。它将若干个Connector组件绑定到一个Container（Engine）上</td>
</tr>
<tr>
<td>Connector</td>
<td>连接器，处理与客户端的通信，它负责接收客户请求，然后转给相关的容器处理，最后向客户返回响应结果</td>
</tr>
<tr>
<td>Container</td>
<td>容器，负责处理用户的servlet请求，并返回对象给web用户的模块</td>
</tr>
</tbody></table>
<p><img src="assets/1561209001499.png" alt="1561209001499"> </p>
<h4 id="2-4-3-Container-结构"><a href="#2-4-3-Container-结构" class="headerlink" title="2.4.3 Container 结构"></a>2.4.3 Container 结构</h4><p>Tomcat设计了4种容器，分别是Engine、Host、Context和Wrapper。这4种容器不是平行关系，而是父子关系。， Tomcat通过一种分层的架构，使得Servlet容器具有很好的灵活性。</p>
<p><img src="assets/1560686115687.png" alt="1560686115687"> </p>
<p>各个组件的含义 ： </p>
<table>
<thead>
<tr>
<th>容器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Engine</td>
<td>表示整个Catalina的Servlet引擎，用来管理多个虚拟站点，一个Service最多只能有一个Engine，但是一个引擎可包含多个Host</td>
</tr>
<tr>
<td>Host</td>
<td>代表一个虚拟主机，或者说一个站点，可以给Tomcat配置多个虚拟主机地址，而一个虚拟主机下可包含多个Context</td>
</tr>
<tr>
<td>Context</td>
<td>表示一个Web应用程序， 一个Web应用可包含多个Wrapper</td>
</tr>
<tr>
<td>Wrapper</td>
<td>表示一个Servlet，Wrapper 作为容器中的最底层，不能包含子容器</td>
</tr>
</tbody></table>
<p>我们也可以再通过Tomcat的server.xml配置文件来加深对Tomcat容器的理解。Tomcat采用了组件化的设计，它的构成组件都是可配置的，其中最外层的是Server，其他组件按照一定的格式要求配置在这个顶层容器中。</p>
<p><img src="assets/1560854103740.png" alt="1560854103740"> </p>
<p>那么，Tomcat是怎么管理这些容器的呢？你会发现这些容器具有父子关系，形成一个树形结构，你可能马上就想到了设计模式中的组合模式。没错，Tomcat就是用组合模式来管理这些容器的。具体实现方法是，所有容器组件都实现了Container接口，因此组合模式可以使得用户对单容器对象和组合容器对象的使用具有一致性。这里单容器对象指的是最底层的Wrapper，组合容器对象指的是上面的Context、Host或者Engine。</p>
<p><img src="assets/1560854814464.png" alt="1560854814464"> </p>
<p>Container 接口中提供了以下方法（截图中知识一部分方法） ：</p>
<p><img src="assets/1560855419861.png" alt="1560855419861">  </p>
<p>在上面的接口看到了getParent、SetParent、addChild和removeChild等方法。</p>
<p>Container接口扩展了LifeCycle接口，LifeCycle接口用来统一管理各组件的生命周期，后面我也用专门的篇幅去详细介绍。 </p>
<h3 id="2-5-Tomcat-启动流程"><a href="#2-5-Tomcat-启动流程" class="headerlink" title="2.5 Tomcat 启动流程"></a>2.5 Tomcat 启动流程</h3><h4 id="2-5-1-流程"><a href="#2-5-1-流程" class="headerlink" title="2.5.1 流程"></a>2.5.1 流程</h4><p><img src="assets/1560953623598.png" alt="1560953623598"> </p>
<p>步骤 :</p>
<p>1） 启动tomcat ， 需要调用 bin/startup.bat (在linux 目录下 , 需要调用 bin/startup.sh) ， 在startup.bat 脚本中, 调用了catalina.bat。</p>
<p>2） 在catalina.bat 脚本文件中，调用了BootStrap 中的main方法。</p>
<p>3）在BootStrap 的main 方法中调用了 init 方法 ， 来创建Catalina 及 初始化类加载器。</p>
<p>4）在BootStrap 的main 方法中调用了 load 方法 ， 在其中又调用了Catalina的load方法。</p>
<p>5）在Catalina 的load 方法中 , 需要进行一些初始化的工作, 并需要构造Digester 对象, 用于解析 XML。</p>
<p>6） 然后在调用后续组件的初始化操作 。。。</p>
<p>加载Tomcat的配置文件，初始化容器组件 ，监听对应的端口号， 准备接受客户端请求 。</p>
<h4 id="2-5-2-源码解析"><a href="#2-5-2-源码解析" class="headerlink" title="2.5.2 源码解析"></a>2.5.2 源码解析</h4><h5 id="2-5-2-1-Lifecycle"><a href="#2-5-2-1-Lifecycle" class="headerlink" title="2.5.2.1 Lifecycle"></a>2.5.2.1 Lifecycle</h5><p>由于所有的组件均存在初始化、启动、停止等生命周期方法，拥有生命周期管理的特性， 所以Tomcat在设计的时候， 基于生命周期管理抽象成了一个接口 Lifecycle ，而组件 Server、Service、Container、Executor、Connector 组件 ， 都实现了一个生命周期的接口，从而具有了以下生命周期中的核心方法：</p>
<p>1） init（）：初始化组件</p>
<p>2） start（）：启动组件</p>
<p>3） stop（）：停止组件</p>
<p>4） destroy（）：销毁组件</p>
<p><img src="assets/1561628676871.png" alt="1561628676871"> </p>
<h5 id="2-5-2-2-各组件的默认实现"><a href="#2-5-2-2-各组件的默认实现" class="headerlink" title="2.5.2.2 各组件的默认实现"></a>2.5.2.2 各组件的默认实现</h5><p>上面我们提到的Server、Service、Engine、Host、Context都是接口， 下图中罗列了这些接口的默认实现类。当前对于 Endpoint组件来说，在Tomcat中没有对应的Endpoint接口， 但是有一个抽象类 AbstractEndpoint ，其下有三个实现类： NioEndpoint、Nio2Endpoint、AprEndpoint ， 这三个实现类，分别对应于前面讲解链接器 Coyote 时， 提到的链接器支持的三种IO模型：NIO，NIO2，APR ， Tomcat8.5版本中，默认采用的是 NioEndpoint。</p>
<p><img src="assets/1561631313124.png" alt="1561631313124"> </p>
<p>ProtocolHandler ： Coyote协议接口，通过封装Endpoint和Processor ， 实现针对具体协议的处理功能。Tomcat按照协议和IO提供了6个实现类。</p>
<p>AJP协议：</p>
<p>1） AjpNioProtocol ：采用NIO的IO模型。</p>
<p>2） AjpNio2Protocol：采用NIO2的IO模型。</p>
<p>3） AjpAprProtocol ：采用APR的IO模型，需要依赖于APR库。</p>
<p>HTTP协议：</p>
<p>1） Http11NioProtocol ：采用NIO的IO模型，默认使用的协议（如果服务器没有安装APR）。</p>
<p>2） Http11Nio2Protocol：采用NIO2的IO模型。</p>
<p>3） Http11AprProtocol ：采用APR的IO模型，需要依赖于APR库。</p>
<p><img src="assets/1561633431160.png" alt="1561633431160"> </p>
<h5 id="2-5-2-3-源码入口"><a href="#2-5-2-3-源码入口" class="headerlink" title="2.5.2.3 源码入口"></a>2.5.2.3 源码入口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">目录： org.apache.catalina.startup</span><br><span class="line"></span><br><span class="line">MainClass：BootStrap ----&gt; main(String[] args)</span><br></pre></td></tr></table></figure>

<p><img src="assets/1561632389373.png" alt="1561632389373"> </p>
<h4 id="2-5-3-总结"><a href="#2-5-3-总结" class="headerlink" title="2.5.3 总结"></a>2.5.3 总结</h4><p>从启动流程图中以及源码中，我们可以看出Tomcat的启动过程非常标准化， 统一按照生命周期管理接口Lifecycle的定义进行启动。首先调用init() 方法进行组件的逐级初始化操作，然后再调用start()方法进行启动。</p>
<p>每一级的组件除了完成自身的处理外，还要负责调用子组件响应的生命周期管理方法， 组件与组件之间是松耦合的，因为我们可以很容易的通过配置文件进行修改和替换。</p>
<h3 id="2-6-Tomcat-请求处理流程"><a href="#2-6-Tomcat-请求处理流程" class="headerlink" title="2.6 Tomcat 请求处理流程"></a>2.6 Tomcat 请求处理流程</h3><h4 id="2-6-1-请求流程"><a href="#2-6-1-请求流程" class="headerlink" title="2.6.1 请求流程"></a>2.6.1 请求流程</h4><p>设计了这么多层次的容器，Tomcat是怎么确定每一个请求应该由哪个Wrapper容器里的Servlet来处理的呢？答案是，Tomcat是用Mapper组件来完成这个任务的。</p>
<p>Mapper组件的功能就是将用户请求的URL定位到一个Servlet，它的工作原理是：Mapper组件里保存了Web应用的配置信息，其实就是容器组件与访问路径的映射关系，比如Host容器里配置的域名、Context容器里的Web应用路径，以及Wrapper容器里Servlet映射的路径，你可以想象这些配置信息就是一个多层次的Map。</p>
<p>当一个请求到来时，Mapper组件通过解析请求URL里的域名和路径，再到自己保存的Map里去查找，就能定位到一个Servlet。请你注意，一个请求URL最后只会定位到一个Wrapper容器，也就是一个Servlet。</p>
<p>下面的示意图中 ， 就描述了 当用户请求链接 <code>http://www.itcast.cn/bbs/findAll</code> 之后, 是如何找到最终处理业务逻辑的servlet 。</p>
<p><img src="assets/1560956861899.png" alt="1560956861899"></p>
<p>那上面这幅图只是描述了根据请求的URL如何查找到需要执行的Servlet ， 那么下面我们再来解析一下 ， 从Tomcat的设计架构层面来分析Tomcat的请求处理。</p>
<p><img src="assets/1560959032664.png" alt="1560959032664"> </p>
<p>步骤如下:</p>
<p>1) Connector组件Endpoint中的Acceptor监听客户端套接字连接并接收Socket。<br>2) 将连接交给线程池Executor处理，开始执行请求响应任务。<br>3) Processor组件读取消息报文，解析请求行、请求体、请求头，封装成Request对象。<br>4) Mapper组件根据请求行的URL值和请求头的Host值匹配由哪个Host容器、Context容器、Wrapper容器处理请求。<br>5) CoyoteAdaptor组件负责将Connector组件和Engine容器关联起来，把生成的Request对象和响应对象Response传递到Engine容器中，调用 Pipeline。<br>6) Engine容器的管道开始处理，管道中包含若干个Valve、每个Valve负责部分处理逻辑。执行完Valve后会执行基础的 Valve–StandardEngineValve，负责调用Host容器的Pipeline。<br>7) Host容器的管道开始处理，流程类似，最后执行 Context容器的Pipeline。<br>8) Context容器的管道开始处理，流程类似，最后执行 Wrapper容器的Pipeline。<br>9) Wrapper容器的管道开始处理，流程类似，最后执行 Wrapper容器对应的Servlet对象的 处理方法。</p>
<h4 id="2-6-2-请求流程源码解析"><a href="#2-6-2-请求流程源码解析" class="headerlink" title="2.6.2 请求流程源码解析"></a>2.6.2 请求流程源码解析</h4><p><img src="assets/1561723489828.png" alt="1561723489828"> </p>
<p>在前面所讲解的Tomcat的整体架构中，我们发现Tomcat中的各个组件各司其职，组件之间松耦合，确保了整体架构的可伸缩性和可拓展性，那么在组件内部，如何增强组件的灵活性和拓展性呢？ 在Tomcat中，每个Container组件采用责任链模式来完成具体的请求处理。</p>
<p>在Tomcat中定义了Pipeline 和 Valve 两个接口，Pipeline 用于构建责任链， 后者代表责任链上的每个处理器。Pipeline 中维护了一个基础的Valve，它始终位于Pipeline的末端（最后执行），封装了具体的请求处理和输出响应的过程。当然，我们也可以调用addValve()方法， 为Pipeline 添加其他的Valve， 后添加的Valve 位于基础的Valve之前，并按照添加顺序执行。Pipiline通过获得首个Valve来启动整合链条的执行 。</p>
<h2 id="3-Jasper"><a href="#3-Jasper" class="headerlink" title="3.Jasper"></a>3.Jasper</h2><h3 id="3-1-Jasper-简介"><a href="#3-1-Jasper-简介" class="headerlink" title="3.1 Jasper 简介"></a>3.1 Jasper 简介</h3><p>对于基于JSP 的web应用来说，我们可以直接在JSP页面中编写 Java代码，添加第三方的标签库，以及使用EL表达式。但是无论经过何种形式的处理，最终输出到客户端的都是标准的HTML页面（包含js ，css…），并不包含任何的java相关的语法。 也就是说， 我们可以把jsp看做是一种运行在服务端的脚本。 那么服务器是如何将 JSP页面转换为HTML页面的呢？</p>
<p>Jasper模块是Tomcat的JSP核心引擎，我们知道JSP本质上是一个Servlet。Tomcat使用Jasper对JSP语法进行解析，生成Servlet并生成Class字节码，用户在进行访问jsp时，会访问Servlet，最终将访问的结果直接响应在浏览器端 。另外，在运行的时候，Jasper还会检测JSP文件是否修改，如果修改，则会重新编译JSP文件。</p>
<h3 id="3-2-JSP-编译方式"><a href="#3-2-JSP-编译方式" class="headerlink" title="3.2 JSP 编译方式"></a>3.2 JSP 编译方式</h3><h4 id="3-2-1-运行时编译"><a href="#3-2-1-运行时编译" class="headerlink" title="3.2.1 运行时编译"></a>3.2.1 运行时编译</h4><p>Tomcat 并不会在启动Web应用的时候自动编译JSP文件， 而是在客户端第一次请求时，才编译需要访问的JSP文件。</p>
<p>创建一个web项目, 并编写JSP代码 : </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.text.DateFormat"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.text.SimpleDateFormat"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.Date"</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;$Title$&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;%</span><br><span class="line">      DateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">      String format = dateFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">    %&gt;</span><br><span class="line">    Hello , Java Server Page 。。。。</span><br><span class="line"></span><br><span class="line">    &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;%= format %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h5 id="3-2-1-1-编译过程"><a href="#3-2-1-1-编译过程" class="headerlink" title="3.2.1.1 编译过程"></a>3.2.1.1 编译过程</h5><p>Tomcat 在默认的web.xml 中配置了一个org.apache.jasper.servlet.JspServlet，用于处理所有的.jsp 或 .jspx 结尾的请求，该Servlet 实现即是运行时编译的入口。</p>
<p><img src="assets/1561218961211.png" alt="1561218961211"> </p>
<p>JspServlet 处理流程图： </p>
<p><img src="assets/1561218587098.png" alt="1561218587098"> </p>
<h5 id="3-2-2-编译结果"><a href="#3-2-2-编译结果" class="headerlink" title="3.2.2 编译结果"></a>3.2.2 编译结果</h5><p>1） 如果在 tomcat/conf/web.xml 中配置了参数scratchdir ， 则jsp编译后的结果，就会存储在该目录下 。</p>
<p><img src="assets/1561221034443.png" alt="1561221034443">  </p>
<p>2） 如果没有配置该选项， 则会将编译后的结果，存储在Tomcat安装目录下的 work/Catalina(Engine名称)/localhost(Host名称)/Context名称 。 假设项目名称为 jsp_demo_01 ,  默认的目录为 ： work/Catalina/localhost/jsp_demo_01。</p>
<p>3） 如果使用的是 IDEA 开发工具集成Tomcat 访问web工程中的jsp ， 编译后的结果， 存放在 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\.IntelliJIdea2019.1\system\tomcat\_project_tomcat\work\Catalina\localhost\jsp_demo_01_war_exploded\org\apache\jsp</span><br></pre></td></tr></table></figure>



<h4 id="3-2-2-预编译"><a href="#3-2-2-预编译" class="headerlink" title="3.2.2 预编译"></a>3.2.2 预编译</h4><p>除了运行时编译，我们还可以直接在Web应用启动时， 一次性将Web应用中的所有的JSP页面一次性编译完成。在这种情况下，Web应用运行过程中，便可以不必再进行实时编译，而是直接调用JSP页面对应的Servlet 完成请求处理， 从而提升系统性能。</p>
<p>Tomcat 提供了一个Shell程序JspC，用于支持JSP预编译，而且在Tomcat的安装目录下提供了一个 catalina-tasks.xml 文件声明了Tomcat 支持的Ant任务， 因此，我们很容易使用 Ant 来执行JSP 预编译 。（要想使用这种方式，必须得确保在此之前已经下载并安装了Apache Ant）。</p>
<h3 id="3-3-JSP编译原理"><a href="#3-3-JSP编译原理" class="headerlink" title="3.3 JSP编译原理"></a>3.3 JSP编译原理</h3><h4 id="3-3-1-代码分析"><a href="#3-3-1-代码分析" class="headerlink" title="3.3.1 代码分析"></a>3.3.1 代码分析</h4><p>编译后的.class 字节码文件及源码 : </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">index_jsp</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">jasper</span>.<span class="title">runtime</span>.<span class="title">HttpJspBase</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">jasper</span>.<span class="title">runtime</span>.<span class="title">JspSourceDependent</span>,<span class="title">org</span>.<span class="title">apache</span>.<span class="title">jasper</span>.<span class="title">runtime</span>.<span class="title">JspSourceImports</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> javax.servlet.jsp.JspFactory _jspxFactory =</span><br><span class="line">          javax.servlet.jsp.JspFactory.getDefaultFactory();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; _jspx_dependants;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    _jspx_dependants = <span class="keyword">new</span> java.util.HashMap&lt;java.lang.String,java.lang.Long&gt;(<span class="number">2</span>);</span><br><span class="line">    _jspx_dependants.put(<span class="string">"jar:file:/D:/DevelopProgramFile/apache-tomcat-8.5.42-windows-x64/apache-tomcat-8.5.42/webapps/jsp_demo_01/WEB-INF/lib/standard.jar!/META-INF/c.tld"</span>, Long.valueOf(<span class="number">1098682290000L</span>));</span><br><span class="line">    _jspx_dependants.put(<span class="string">"/WEB-INF/lib/standard.jar"</span>, Long.valueOf(<span class="number">1490343635913L</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_packages;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_classes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    _jspx_imports_packages = <span class="keyword">new</span> java.util.HashSet&lt;&gt;();</span><br><span class="line">    _jspx_imports_packages.add(<span class="string">"javax.servlet"</span>);</span><br><span class="line">    _jspx_imports_packages.add(<span class="string">"javax.servlet.http"</span>);</span><br><span class="line">    _jspx_imports_packages.add(<span class="string">"javax.servlet.jsp"</span>);</span><br><span class="line">    _jspx_imports_classes = <span class="keyword">new</span> java.util.HashSet&lt;&gt;();</span><br><span class="line">    _jspx_imports_classes.add(<span class="string">"java.util.Date"</span>);</span><br><span class="line">    _jspx_imports_classes.add(<span class="string">"java.text.SimpleDateFormat"</span>);</span><br><span class="line">    _jspx_imports_classes.add(<span class="string">"java.text.DateFormat"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> javax.el.ExpressionFactory _el_expressionfactory;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> org.apache.tomcat.InstanceManager _jsp_instancemanager;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; getDependants() &#123;</span><br><span class="line">    <span class="keyword">return</span> _jspx_dependants;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.util.Set&lt;java.lang.String&gt; getPackageImports() &#123;</span><br><span class="line">    <span class="keyword">return</span> _jspx_imports_packages;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.util.Set&lt;java.lang.String&gt; getClassImports() &#123;</span><br><span class="line">    <span class="keyword">return</span> _jspx_imports_classes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> javax.el.<span class="function">ExpressionFactory <span class="title">_jsp_getExpressionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_el_expressionfactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_el_expressionfactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _el_expressionfactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> org.apache.tomcat.<span class="function">InstanceManager <span class="title">_jsp_getInstanceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_jsp_instancemanager == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_jsp_instancemanager == <span class="keyword">null</span>) &#123;</span><br><span class="line">          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _jsp_instancemanager;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_jspInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_jspDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_jspService</span><span class="params">(<span class="keyword">final</span> javax.servlet.http.HttpServletRequest request, <span class="keyword">final</span> javax.servlet.http.HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> java.io.IOException, javax.servlet.ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> java.lang.String _jspx_method = request.getMethod();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"GET"</span>.equals(_jspx_method) &amp;&amp; !<span class="string">"POST"</span>.equals(_jspx_method) &amp;&amp; !<span class="string">"HEAD"</span>.equals(_jspx_method) &amp;&amp; !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) &#123;</span><br><span class="line">      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, <span class="string">"JSPs only permit GET POST or HEAD"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> javax.servlet.jsp.PageContext pageContext;</span><br><span class="line">    javax.servlet.http.HttpSession session = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> javax.servlet.ServletContext application;</span><br><span class="line">    <span class="keyword">final</span> javax.servlet.ServletConfig config;</span><br><span class="line">    javax.servlet.jsp.JspWriter out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> java.lang.Object page = <span class="keyword">this</span>;</span><br><span class="line">    javax.servlet.jsp.JspWriter _jspx_out = <span class="keyword">null</span>;</span><br><span class="line">    javax.servlet.jsp.PageContext _jspx_page_context = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response.setContentType(<span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line">      pageContext = _jspxFactory.getPageContext(<span class="keyword">this</span>, request, response,</span><br><span class="line">      			<span class="keyword">null</span>, <span class="keyword">true</span>, <span class="number">8192</span>, <span class="keyword">true</span>);</span><br><span class="line">      _jspx_page_context = pageContext;</span><br><span class="line">      application = pageContext.getServletContext();</span><br><span class="line">      config = pageContext.getServletConfig();</span><br><span class="line">      session = pageContext.getSession();</span><br><span class="line">      out = pageContext.getOut();</span><br><span class="line">      _jspx_out = out;</span><br><span class="line"></span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"&lt;html&gt;\n"</span>);</span><br><span class="line">      out.write(<span class="string">"  &lt;head&gt;\n"</span>);</span><br><span class="line">      out.write(<span class="string">"    &lt;title&gt;$Title$&lt;/title&gt;\n"</span>);</span><br><span class="line">      out.write(<span class="string">"  &lt;/head&gt;\n"</span>);</span><br><span class="line">      out.write(<span class="string">"  &lt;body&gt;\n"</span>);</span><br><span class="line">      out.write(<span class="string">"    "</span>);</span><br><span class="line"></span><br><span class="line">      DateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">      String format = dateFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">    </span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"    Hello , Java Server Page 。。。。\n"</span>);</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"    &lt;br/&gt;\n"</span>);</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"    "</span>);</span><br><span class="line">      out.print( format );</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"\n"</span>);</span><br><span class="line">      out.write(<span class="string">"  &lt;/body&gt;\n"</span>);</span><br><span class="line">      out.write(<span class="string">"&lt;/html&gt;\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.lang.Throwable t) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(t <span class="keyword">instanceof</span> javax.servlet.jsp.SkipPageException))&#123;</span><br><span class="line">        out = _jspx_out;</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="keyword">null</span> &amp;&amp; out.getBufferSize() != <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">              out.flush();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              out.clearBuffer();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (_jspx_page_context != <span class="keyword">null</span>) _jspx_page_context.handlePageException(t);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(t);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      _jspxFactory.releasePageContext(_jspx_page_context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>由编译后的源码解读， 可以分析出以下几点 ：</p>
<p>1） 其类名为 index_jsp ， 继承自 org.apache.jasper.runtime.HttpJspBase ， 该类是HttpServlet 的子类 ， 所以jsp 本质就是一个Servlet 。</p>
<p>2） 通过属性 _jspx_dependants 保存了当前JSP页面依赖的资源， 包含引入的外部的JSP页面、导入的标签、标签所在的jar包等，便于后续处理过程中使用（如重新编译检测，因此它以Map形式保存了每个资源的上次修改时间）。</p>
<p>3） 通过属性 _jspx_imports_packages 存放导入的 java 包， 默认导入 javax.servlet ， javax.servlet.http, javax.servlet.jsp 。</p>
<p>4） 通过属性 _jspx_imports_classes 存放导入的类， 通过import 指令导入的 DateFormat 、SimpleDateFormat 、Date 都会包含在该集合中。 _jspx_imports_packages 和 _jspx_imports_classes  属性主要用于配置 EL 引擎上下文 。</p>
<p>5） 请求处理由方法 _jspService 完成 ， 而在父类 HttpJspBase 中的service 方法通过模板方法模式 ， 调用了子类的 _jspService  方法。</p>
<p><img src="assets/1561290672734.png" alt="1561290672734"> </p>
<p>6） _jspService  方法中定义了几个重要的局部变量 ： pageContext 、Session、application、config、out、page。由于整个页面的输出有 _jspService 方法完成，因此这些变量和参数会对整个JSP页面生效。 这也是我们为什么可以在JSP页面使用这些变量的原因。</p>
<p>7） 指定文档类型的指令 （page） 最终转换为  response.setContentType() 方法调用。</p>
<p>8） 对于每一行的静态内容（HTML） ， 调用 out.write 输出。</p>
<p>9） 对于 &lt;%   …   %&gt; 中的java 代码 ， 将直接转换为 Servlet 类中的代码。 如果在 Java 代码中嵌入了静态文件， 则同样调用 out.write 输出。</p>
<h4 id="3-3-2-编译流程"><a href="#3-3-2-编译流程" class="headerlink" title="3.3.2 编译流程"></a>3.3.2 编译流程</h4><p>JSP 编译过程如下：</p>
<p><img src="assets/1561298658175.png" alt="1561298658175"> </p>
<p>Compiler 编译工作主要包含代码生成 和 编译两部分 ： </p>
<p><strong>代码生成</strong></p>
<p>1） Compiler 通过一个 PageInfo 对象保存JSP 页面编译过程中的各种配置，这些配置可能来源于 Web 应用初始化参数， 也可能来源于JSP页面的指令配置（如 page ， include）。</p>
<p>2） 调用ParserController 解析指令节点， 验证其是否合法，同时将配置信息保存到PageInfo 中， 用于控制代码生成。</p>
<p>3） 调用ParserController 解析整个页面， 由于 JSP  是逐行解析， 所以对于每一行会创建一个具体的Node 对象。如  静态文本（TemplateText）、Java代码（Scriptlet）、定制标签（CustomTag）、Include指令（IncludeDirective）。</p>
<p>4） 验证除指令外其他所有节点的合法性， 如 脚本、定制标签、EL表达式等。</p>
<p>5） 收集除指令外其他节点的页面配置信息。</p>
<p>6） 编译并加载当前 JSP 页面依赖的标签</p>
<p>7） 对于JSP页面的EL表达式，生成对应的映射函数。</p>
<p>8） 生成JSP页面对应的Servlet 类源代码</p>
<p><strong>编译</strong></p>
<p>代码生成完成后， Compiler 还会生成 SMAP 信息。 如果配置生成 SMAP 信息，Compiler 则会在编译阶段将SMAP 信息写到class 文件中 。</p>
<p>在编译阶段， Compiler 的两个实现 AntCompiler 和 JDTCompiler 分别调用先关框架的API 进行源代码编译。 </p>
<p>对于 AntCompiler 来说， 构造一个 Ant 的javac 的任务完成编译。</p>
<p>对于 JDTCompiler 来说， 调用 org.eclipse.jdt.internal.compiler.Compiler 完成编译。 </p>
<h2 id="4-Tomcat-服务器配置"><a href="#4-Tomcat-服务器配置" class="headerlink" title="4.Tomcat 服务器配置"></a>4.Tomcat 服务器配置</h2><p>Tomcat 服务器的配置主要集中于 tomcat/conf 下的 catalina.policy、catalina.properties、context.xml、server.xml、tomcat-users.xml、web.xml 文件。</p>
<h3 id="4-1-server-xml"><a href="#4-1-server-xml" class="headerlink" title="4.1 server.xml"></a>4.1 server.xml</h3><p>server.xml  是tomcat 服务器的核心配置文件，包含了Tomcat的 Servlet 容器（Catalina）的所有配置。由于配置的属性特别多，我们在这里主要讲解其中的一部分重要配置。</p>
<h4 id="4-1-1-Server"><a href="#4-1-1-Server" class="headerlink" title="4.1.1 Server"></a>4.1.1 Server</h4><p>Server是server.xml的根元素，用于创建一个Server实例，默认使用的实现类是  org.apache.catalina.core.StandardServer。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">	...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>port : Tomcat 监听的关闭服务器的端口。</p>
<p>shutdown： 关闭服务器的指令字符串。</p>
<p>Server内嵌的子元素为 Listener、GlobalNamingResources、Service。</p>
<p>默认配置的5个Listener 的含义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用于以日志形式输出服务器 、操作系统、JVM的版本信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用于加载（服务器启动） 和 销毁 （服务器停止） APR。 如果找不到APR库， 则会输出日志， 并不影响Tomcat启动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用于避免JRE内存泄漏问题 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用户加载（服务器启动） 和 销毁（服务器停止） 全局命名服务 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用于在Context停止时重建Executor 池中的线程， 以避免ThreadLocal 相关的内存泄漏 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>GlobalNamingResources 中定义了全局命名服务：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Global JNDI resources</span></span><br><span class="line"><span class="comment">     Documentation at /docs/jndi-resources-howto.html</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Editable user database that can also be used by</span></span><br><span class="line"><span class="comment">         UserDatabaseRealm to authenticate users</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="4-1-2-Service"><a href="#4-1-2-Service" class="headerlink" title="4.1.2 Service"></a>4.1.2 Service</h4><p>该元素用于创建 Service 实例，默认使用 org.apache.catalina.core.StandardService。 默认情况下，Tomcat 仅指定了Service 的名称， 值为 “Catalina”。Service 可以内嵌的元素为 ： Listener、Executor、Connector、Engine，其中 ： Listener 用于为Service添加生命周期监听器， Executor 用于配置Service 共享线程池，Connector 用于配置Service 包含的链接器， Engine 用于配置Service中链接器对应的Servlet 容器引擎。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">	...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一个Server服务器，可以包含多个Service服务。</p>
<h4 id="4-1-3-Executor"><a href="#4-1-3-Executor" class="headerlink" title="4.1.3 Executor"></a>4.1.3 Executor</h4><p>默认情况下，Service 并未添加共享线程池配置。 如果我们想添加一个线程池， 可以在 <Service> 下添加如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">"tomcatThreadPool"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">namePrefix</span>=<span class="string">"catalina-exec-"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">maxThreads</span>=<span class="string">"200"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">minSpareThreads</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">maxIdleTime</span>=<span class="string">"60000"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">maxQueueSize</span>=<span class="string">"Integer.MAX_VALUE"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">prestartminSpareThreads</span>=<span class="string">"false"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">threadPriority</span>=<span class="string">"5"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardThreadExecutor"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p> 属性说明：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>线程池名称，用于 Connector中指定。</td>
</tr>
<tr>
<td>namePrefix</td>
<td>所创建的每个线程的名称前缀，一个单独的线程名称为 namePrefix+threadNumber。</td>
</tr>
<tr>
<td>maxThreads</td>
<td>池中最大线程数。</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>活跃线程数，也就是核心池线程数，这些线程不会被销毁，会一直存在。</td>
</tr>
<tr>
<td>maxIdleTime</td>
<td>线程空闲时间，超过该时间后，空闲线程会被销毁，默认值为6000（1分钟），单位毫秒。</td>
</tr>
<tr>
<td>maxQueueSize</td>
<td>在被执行前最大线程排队数目，默认为Int的最大值，也就是广义的无限。除非特殊情况，这个值不需要更改，否则会有请求不会被处理的情况发生。</td>
</tr>
<tr>
<td>prestartminSpareThreads</td>
<td>启动线程池时是否启动 minSpareThreads部分线程。默认值为false，即不启动。</td>
</tr>
<tr>
<td>threadPriority</td>
<td>线程池中线程优先级，默认值为5，值从1到10。</td>
</tr>
<tr>
<td>className</td>
<td>线程池实现类，未指定情况下，默认实现类为org.apache.catalina.core.StandardThreadExecutor。如果想使用自定义线程池首先需要实现 org.apache.catalina.Executor接口。</td>
</tr>
</tbody></table>
<p><img src="assets/1561375210344.png" alt="1561375210344"> </p>
<p>如果不配置共享线程池，那么Catalina 各组件在用到线程池时会独立创建。</p>
<h4 id="4-1-4-Connector"><a href="#4-1-4-Connector" class="headerlink" title="4.1.4 Connector"></a>4.1.4 Connector</h4><p>Connector 用于创建链接器实例。默认情况下，server.xml 配置了两个链接器，一个支持HTTP协议，一个支持AJP协议。因此大多数情况下，我们并不需要新增链接器配置，只是根据需要对已有链接器进行优化。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性说明：</p>
<p>1） port： 端口号，Connector 用于创建服务端Socket 并进行监听， 以等待客户端请求链接。如果该属性设置为0，Tomcat将会随机选择一个可用的端口号给当前Connector 使用。</p>
<p>2） protocol ： 当前Connector 支持的访问协议。 默认为 HTTP/1.1 ， 并采用自动切换机制选择一个基于 JAVA NIO 的链接器或者基于本地APR的链接器（根据本地是否含有Tomcat的本地库判定）。</p>
<p>如果不希望采用上述自动切换的机制， 而是明确指定协议， 可以使用以下值。</p>
<p>Http协议：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.coyote.http11.Http11NioProtocol ， 非阻塞式 Java NIO 链接器</span><br><span class="line">org.apache.coyote.http11.Http11Nio2Protocol ， 非阻塞式 JAVA NIO2 链接器 </span><br><span class="line">org.apache.coyote.http11.Http11AprProtocol ， APR 链接器</span><br></pre></td></tr></table></figure>

<p>AJP协议 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.coyote.ajp.AjpNioProtocol ， 非阻塞式 Java NIO 链接器</span><br><span class="line">org.apache.coyote.ajp.AjpNio2Protocol ，非阻塞式 JAVA NIO2 链接器 </span><br><span class="line">org.apache.coyote.ajp.AjpAprProtocol ， APR 链接器</span><br></pre></td></tr></table></figure>

<p>3） connectionTimeOut : Connector 接收链接后的等待超时时间， 单位为 毫秒。 -1 表示不超时。</p>
<p>4） redirectPort：当前Connector 不支持SSL请求， 接收到了一个请求， 并且也符合security-constraint 约束， 需要SSL传输，Catalina自动将请求重定向到指定的端口。</p>
<p>5） executor ： 指定共享线程池的名称， 也可以通过maxThreads、minSpareThreads 等属性配置内部线程池。</p>
<p>6） URIEncoding : 用于指定编码URI的字符编码， Tomcat8.x版本默认的编码为 UTF-8 , Tomcat7.x版本默认为ISO-8859-1。</p>
<p>完整的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span>   </span></span><br><span class="line"><span class="tag">          <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">executor</span>=<span class="string">"tomcatThreadPool"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">maxThreads</span>=<span class="string">"1000"</span>   </span></span><br><span class="line"><span class="tag">          <span class="attr">minSpareThreads</span>=<span class="string">"100"</span>   </span></span><br><span class="line"><span class="tag">          <span class="attr">acceptCount</span>=<span class="string">"1000"</span>  </span></span><br><span class="line"><span class="tag">          <span class="attr">maxConnections</span>=<span class="string">"1000"</span>  </span></span><br><span class="line"><span class="tag">          <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">compression</span>=<span class="string">"on"</span>  </span></span><br><span class="line"><span class="tag">          <span class="attr">compressionMinSize</span>=<span class="string">"2048"</span>  </span></span><br><span class="line"><span class="tag">          <span class="attr">disableUploadTimeout</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">          <span class="attr">redirectPort</span>=<span class="string">"8443"</span>  </span></span><br><span class="line"><span class="tag">          <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="4-1-5-Engine"><a href="#4-1-5-Engine" class="headerlink" title="4.1.5 Engine"></a>4.1.5 Engine</h4><p>Engine 作为Servlet 引擎的顶级元素，内部可以嵌入： Cluster、Listener、Realm、Valve和Host。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">	...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性说明：</p>
<p>1） name： 用于指定Engine 的名称， 默认为Catalina 。该名称会影响一部分Tomcat的存储路径（如临时文件）。</p>
<p>2） defaultHost ： 默认使用的虚拟主机名称， 当客户端请求指向的主机无效时， 将交由默认的虚拟主机处理， 默认为localhost。</p>
<h4 id="4-1-6-Host"><a href="#4-1-6-Host" class="headerlink" title="4.1.6 Host"></a>4.1.6 Host</h4><p>Host 元素用于配置一个虚拟主机， 它支持以下嵌入元素：Alias、Cluster、Listener、Valve、Realm、Context。如果在Engine下配置Realm， 那么此配置将在当前Engine下的所有Host中共享。 同样，如果在Host中配置Realm ， 则在当前Host下的所有Context中共享。Context中的Realm优先级 &gt; Host 的Realm优先级 &gt; Engine中的Realm优先级。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性说明：</p>
<p>1） name: 当前Host通用的网络名称， 必须与DNS服务器上的注册信息一致。 Engine中包含的Host必须存在一个名称与Engine的defaultHost设置一致。</p>
<p>2） appBase： 当前Host的应用基础目录， 当前Host上部署的Web应用均在该目录下（可以是绝对目录，相对路径）。默认为webapps。</p>
<p>3） unpackWARs： 设置为true， Host在启动时会将appBase目录下war包解压为目录。设置为false， Host将直接从war文件启动。</p>
<p>4） autoDeploy： 控制tomcat是否在运行时定期检测并自动部署新增或变更的web应用。</p>
<p>通过给Host添加别名，我们可以实现同一个Host拥有多个网络名称，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"www.web1.com"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Alias</span>&gt;</span>www.web2.com<span class="tag">&lt;/<span class="name">Alias</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个时候，我们就可以通过两个域名访问当前Host下的应用（需要确保DNS或hosts中添加了域名的映射配置）。</p>
<h4 id="4-1-7-Context"><a href="#4-1-7-Context" class="headerlink" title="4.1.7 Context"></a>4.1.7 Context</h4><p>Context 用于配置一个Web应用，默认的配置如下： </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"myApp"</span> <span class="attr">path</span>=<span class="string">"/myApp"</span>&gt;</span></span><br><span class="line">    ....</span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性描述：</p>
<p>1） docBase：Web应用目录或者War包的部署路径。可以是绝对路径，也可以是相对于 Host appBase的相对路径。</p>
<p>2） path：Web应用的Context 路径。如果我们Host名为localhost， 则该web应用访问的根路径为： <a href="http://localhost:8080/myApp。" target="_blank" rel="noopener">http://localhost:8080/myApp。</a></p>
<p>它支持的内嵌元素为：CookieProcessor， Loader， Manager，Realm，Resources，WatchedResource，JarScanner，Valve。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"www.tomcat.com"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"D:\servlet_project03"</span> <span class="attr">path</span>=<span class="string">"/myApp"</span>&gt;</span><span class="tag">&lt;/<span class="name">Context</span>&gt;</span>  </span><br><span class="line">	</span><br><span class="line">    <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-tomcat-users-xml"><a href="#4-2-tomcat-users-xml" class="headerlink" title="4.2 tomcat-users.xml"></a>4.2 tomcat-users.xml</h3><p>该配置文件中，主要配置的是Tomcat的用户，角色等信息，用来控制Tomcat中manager， host-manager的访问权限。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/Tomcat%20%E4%B8%93%E9%A2%98/" data-id="ck7xfhuyj0005o4vl0udugeg0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-精通Spring Boot与Cloud" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/" class="article-date">
  <time datetime="2020-03-18T11:34:11.724Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/">精通Spring Boot与Cloud</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spring-Boot-Loader源码深入解析"><a href="#Spring-Boot-Loader源码深入解析" class="headerlink" title="Spring_Boot_Loader源码深入解析"></a>Spring_Boot_Loader源码深入解析</h2><p>源代码位于：spring-boot-loader-2.1.3.RELEASE.jar中。</p>
<p>类层次结构：</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5Cdiagram.png" alt=""></p>
<h3 id="1、Launcher类详解"><a href="#1、Launcher类详解" class="headerlink" title="1、Launcher类详解"></a>1、Launcher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.security.CodeSource;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.ExplodedArchive;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.JarFileArchive;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个父类，针对于启动器的，它是可以启动一个应用的，这个应用是带有完全配置好的类路径，是由一</span></span><br><span class="line"><span class="comment">// 个或多个归档文件支撑的（这是一个用于启动应用的基类，这个基类它是针对于一个或多个归档文件使用的）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for launchers that can start an application with a fully configured</span></span><br><span class="line"><span class="comment"> * classpath backed by one or more &#123;<span class="doctag">@link</span> Archive&#125;s.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Launcher会加载这个应用，这个方法是一个初始的入口点，它应该被当前类的一个子类的public 		</span></span><br><span class="line">    <span class="comment">// static void main(String[] args)方法调用</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Launch the application. This method is the initial entry point that should be</span></span><br><span class="line"><span class="comment">	 * called by a subclass &#123;<span class="doctag">@code</span> public static void main(String[] args)&#125; method.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the application fails to launch</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 注册Url的协议处理器，位于JarFile类当中</span></span><br><span class="line">		JarFile.registerUrlProtocolHandler();</span><br><span class="line">		<span class="comment">// 很重要！你过去所深入学习的一些知识点，在未来的某一个时刻一定会被用到</span></span><br><span class="line">        <span class="comment">// 创建类加载器，符合条件的归档文件传入</span></span><br><span class="line">        <span class="comment">// getClassPathArchives()返回List&lt;Archive&gt;集合，list当中的每一个Archive对象，</span></span><br><span class="line">        <span class="comment">// 要么是classes目录，要么是lib目录下所有的jar文件的路径</span></span><br><span class="line">        ClassLoader classLoader = createClassLoader(getClassPathArchives());</span><br><span class="line">        <span class="comment">// 第一个参数：args命令行传入的参数</span></span><br><span class="line">        <span class="comment">// 第二个参数：getMainClass()方法调用，本身是一个抽象的方法，需要看具体的</span></span><br><span class="line">        <span class="comment">// 实现ExecutableArchiveLauncher类（即主类或启动类对应的字符串）</span></span><br><span class="line">        <span class="comment">// 第三个参数：classLoader类加载器</span></span><br><span class="line">		launch(args, getMainClass(), classLoader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个类加载器针对于所指定的归档文件</span></span><br><span class="line">    <span class="comment">// createClassLoader这个方法会创建一个新的类加载器，这个类加载器就是用来加载classes目录下的</span></span><br><span class="line">    <span class="comment">// class文件与lib目录下的jar文件信息</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a classloader for the specified archives.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> archives the archives</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the classloader cannot be created</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(List&lt;Archive&gt; archives)</span> <span class="keyword">throws</span> Exception </span>&#123;	     	<span class="comment">// 根据所传入的集合创建新的集合，这个新创建集合的大小就是所传入集合的大小</span></span><br><span class="line">		List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;(archives.size());</span><br><span class="line">        <span class="comment">// 遍历集合所传入的每一个对象，然后将每一个对象的url添加至新的集合当中</span></span><br><span class="line">		<span class="keyword">for</span> (Archive archive : archives) &#123;</span><br><span class="line">            <span class="comment">// archive.getUrl() 对应着jar文件在磁盘上的完整的绝对路径</span></span><br><span class="line">			urls.add(archive.getUrl());</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// urls.toArray(new URL[0])转换为数组</span></span><br><span class="line">		<span class="keyword">return</span> createClassLoader(urls.toArray(<span class="keyword">new</span> URL[<span class="number">0</span>]));</span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="comment">// 创建一个针对于指定的url的类加载器</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a classloader for the specified URLs.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> urls the URLs</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the classloader cannot be created</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(URL[] urls)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// Spring Boot loader提供的全新类加载器</span></span><br><span class="line">        <span class="comment">// 在创建一个类加载器的时候，一定要指定它的父类加载器是什么</span></span><br><span class="line">        <span class="comment">// 第一个参数：urls被加载的jar文件的绝路径</span></span><br><span class="line">        <span class="comment">// 第二个参数：父类加载器（应用或系统类加载器），getClass()返回当前类Launcher的实例，</span></span><br><span class="line">        <span class="comment">// 然后获取它的类加载器，即应用或系统类加载器</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LaunchedURLClassLoader(urls, getClass().getClassLoader());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 针对给定存档文件和完全配置的类加载器启动应用程序</span></span><br><span class="line">    <span class="comment">// 第一个参数：接收到传递的参数</span></span><br><span class="line">    <span class="comment">// 第二个参数：准备要运行的主类</span></span><br><span class="line">    <span class="comment">// 第三个参数：类加载器</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Launch the application given the archive file and a fully configured classloader.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mainClass the main class to run</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> classLoader the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the launch fails</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String[] args, String mainClass, ClassLoader classLoader)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到当前线程，然后设置上下文类加载器，默认情况下，上下文类加载器是AppClassLoader，</span></span><br><span class="line">        <span class="comment">// 通过这种方式把当前线程上下文类加载器由默认的AppClassLoader换成SpringBoot自己定义</span></span><br><span class="line">        <span class="comment">// 的类加载器LauncherURLClassLoader</span></span><br><span class="line">		Thread.currentThread().setContextClassLoader(classLoader);</span><br><span class="line">        <span class="comment">// 创建主方法运行器</span></span><br><span class="line">		createMainMethodRunner(mainClass, args, classLoader).run();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建MainMethodRunner用于启动或加载应用</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create the &#123;<span class="doctag">@code</span> MainMethodRunner&#125; used to launch the application.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mainClass the main class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> classLoader the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the main method runner</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> MainMethodRunner <span class="title">createMainMethodRunner</span><span class="params">(String mainClass, String[] args, ClassLoader classLoader)</span> </span>&#123; <span class="comment">// classLoader未使用到 </span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MainMethodRunner(mainClass, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回应该被加载的主类</span></span><br><span class="line">    <span class="comment">// 返回main-class的名称</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the main class that should be launched.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the name of the main class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the main class cannot be obtained</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getMainClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这是一个抽象方法，返回一个归档文件，它用于构建类路径</span></span><br><span class="line">    <span class="comment">// 找具体的子类ExecutableArchiveLauncher的实现</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the archives that will be used to construct the class path.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the class path archives</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the class path archives cannot be obtained</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Archive&gt; <span class="title">getClassPathArchives</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 用来定位我们当前被执行的那个jar文件，</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Archive <span class="title">createArchive</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ProtectionDomain protectionDomain = getClass().getProtectionDomain();</span><br><span class="line">		CodeSource codeSource = protectionDomain.getCodeSource();</span><br><span class="line">		URI location = (codeSource != <span class="keyword">null</span>) ? codeSource.getLocation().toURI() : <span class="keyword">null</span>;</span><br><span class="line">		String path = (location != <span class="keyword">null</span>) ? location.getSchemeSpecificPart() : <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to determine code source archive"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 创建File对象，File对象本身就是被执行的jar文件，实际上就表示</span></span><br><span class="line">        <span class="comment">// springboot_lecture-1.0.jar完整的绝对路径</span></span><br><span class="line">		File root = <span class="keyword">new</span> File(path); </span><br><span class="line">		<span class="keyword">if</span> (!root.exists()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to determine code source archive from "</span> + root);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (root.isDirectory() ? <span class="keyword">new</span> ExplodedArchive(root) : <span class="keyword">new</span> JarFileArchive(root));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、ExecutableArchiveLauncher类详解"><a href="#2、ExecutableArchiveLauncher类详解" class="headerlink" title="2、ExecutableArchiveLauncher类详解"></a>2、ExecutableArchiveLauncher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可执行的归档启动器的父类，它的子类有两个：</span></span><br><span class="line"><span class="comment">// JarLauncher</span></span><br><span class="line"><span class="comment">// WarLauncher当我们对SpringBoot工程打的不是jar包而是war包的时候就会使用WarLauncher启动器</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for executable archive &#123;<span class="doctag">@link</span> Launcher&#125;s.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutableArchiveLauncher</span> <span class="keyword">extends</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Archive archive;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ExecutableArchiveLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">this</span>.archive = createArchive();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="title">ExecutableArchiveLauncher</span><span class="params">(Archive archive)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.archive = archive;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Archive <span class="title">getArchive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.archive;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// MANIFEST.MF文件内容：</span></span><br><span class="line">   <span class="comment">// Manifest-Version: 1.0</span></span><br><span class="line">   <span class="comment">// Start-Class: com.shengsiyuan.boot.MyApplication</span></span><br><span class="line">   <span class="comment">// Spring-Boot-Classes: BOOT-INF/classes/</span></span><br><span class="line">   <span class="comment">// Spring-Boot-Lib: BOOT-INF/lib/</span></span><br><span class="line">   <span class="comment">// Spring-Boot-Version: 2.2.5.RELEASE</span></span><br><span class="line">   <span class="comment">// Main-Class: org.springframework.boot.loader.JarLauncher</span></span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> String <span class="title">getMainClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Manifest manifest = <span class="keyword">this</span>.archive.getManifest();</span><br><span class="line">      String mainClass = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (manifest != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="comment">// 获取Start-Class的所有属性值（当前项目或工程的启动类）的字符串</span></span><br><span class="line">         mainClass = manifest.getMainAttributes().getValue(<span class="string">"Start-Class"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (mainClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No 'Start-Class' manifest entry specified in "</span> + <span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 返回Start-Class的字符串</span></span><br><span class="line">      <span class="keyword">return</span> mainClass;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> List&lt;Archive&gt; <span class="title">getClassPathArchives</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// 得到一个List&lt;Archive&gt;集合，			   	    	 	//this.archive.getNestedArchives(this::isNestedArchive)</span></span><br><span class="line">       <span class="comment">// 这行代码返回的是什么？</span></span><br><span class="line">      List&lt;Archive&gt; archives = <span class="keyword">new</span> ArrayList&lt;&gt;</span><br><span class="line">          <span class="comment">// 获取嵌套的Archives</span></span><br><span class="line">          <span class="comment">// 通过this::isNestedArchive方法引用判断当前给定的的entry是不是一个符合条件的</span></span><br><span class="line">          <span class="comment">// WEB-INF开头或者是lib目录开头的，如果是的话就加到List&lt;Archive&gt;集合当中</span></span><br><span class="line">          (<span class="keyword">this</span>.archive.getNestedArchives(<span class="keyword">this</span>::isNestedArchive));</span><br><span class="line">      <span class="comment">// 通过上面的代码会得到一个结论：它会将BOOT-INF下面的classes目录，lib目录里面所有的jar文		</span></span><br><span class="line">      <span class="comment">// 件都放置在List&lt;Archive&gt;集合当中</span></span><br><span class="line">       </span><br><span class="line">      <span class="comment">// 调用postProcessClassPathArchives()方法</span></span><br><span class="line">      postProcessClassPathArchives(archives);</span><br><span class="line">      <span class="comment">// 符合条件的archives返回（classes与lib目录）</span></span><br><span class="line">      <span class="keyword">return</span> archives;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确定是否指定JarEntry是一个嵌套的条目，应该被添加至类路径下，这个方法是针对于一个</span></span><br><span class="line">    <span class="comment">// entry只会被调用一次</span></span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Determine if the specified &#123;<span class="doctag">@link</span> JarEntry&#125; is a nested item that should be added</span></span><br><span class="line"><span class="comment">    * to the classpath. The method is called once for each entry.</span></span><br><span class="line"><span class="comment">    // entry就是这个jar文件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> entry the jar entry </span></span><br><span class="line"><span class="comment">    // 如果entry是一个嵌套的条目（jar文件或者目录）</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the entry is a nested item (jar or folder)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isNestedArchive</span><span class="params">(Archive.Entry entry)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 在使用归档项之前调用它们。可以实现添加和删除条目</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called to post-process archive entries before they are used. Implementations can</span></span><br><span class="line"><span class="comment">    * add and remove entries.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> archives the archives</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception if the post processing fails</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessClassPathArchives</span><span class="params">(List&lt;Archive&gt; archives)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、JarLauncher类详解"><a href="#3、JarLauncher类详解" class="headerlink" title="3、JarLauncher类详解"></a>3、JarLauncher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个启动器，针对于用于jar的归档文件，这个launcher假设依赖的jar位于一个/BOOT-INF/lib目录</span></span><br><span class="line"><span class="comment">// 下，另外又假设应用类是被包含在/BOOT-INF/classes目录下。</span></span><br><span class="line">├─BOOT-INF</span><br><span class="line">│  ├─classes</span><br><span class="line">│  │  └─com</span><br><span class="line">│  │      └─shengsiyuan</span><br><span class="line">│  │          └─boot</span><br><span class="line">│  │              ├─config</span><br><span class="line">│  │              ├─controller</span><br><span class="line">│  │              └─domain</span><br><span class="line">│  └─lib</span><br><span class="line">├─META-INF</span><br><span class="line">└─org</span><br><span class="line">    └─springframework</span><br><span class="line">        └─boot</span><br><span class="line">            └─loader</span><br><span class="line">                ├─archive</span><br><span class="line">                ├─data</span><br><span class="line">                ├─jar</span><br><span class="line">                └─util</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Launcher&#125; for JAR based archives. This launcher assumes that dependency jars are</span></span><br><span class="line"><span class="comment"> * included inside a &#123;<span class="doctag">@code</span> /BOOT-INF/lib&#125; directory and that application classes are</span></span><br><span class="line"><span class="comment"> * included inside a &#123;<span class="doctag">@code</span> /BOOT-INF/classes&#125; directory.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span>    </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JarLauncher</span> <span class="keyword">extends</span> <span class="title">ExecutableArchiveLauncher</span> </span>&#123; </span><br><span class="line">    <span class="comment">// JarLauncher继承可执行的归档的启动器</span></span><br><span class="line">	<span class="comment">// 定义两个静态字符串并且是final的常量</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String BOOT_INF_CLASSES = <span class="string">"BOOT-INF/classes/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String BOOT_INF_LIB = <span class="string">"BOOT-INF/lib/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空的构造方法，没有分析的必要</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JarLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">JarLauncher</span><span class="params">(Archive archive)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(archive);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// jar文件规范：</span></span><br><span class="line">    <span class="comment">// 1、对于一个jar文件来说，被指定为Main-Class（入口）类的一个具体类，这个类连同它的包结构，</span></span><br><span class="line">    <span class="comment">// 一定是位于这个jar文件的顶层目录，而不能位于其他的目录里面</span></span><br><span class="line">    <span class="comment">// 2、jar文件是不能被嵌套的（不能在jar文件里面嵌套jar文件）</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 这就是整个isNestedArchive方法的判断执行的逻辑</span></span><br><span class="line">    <span class="comment">// entry指的是一个目录或一个jar文件，判断这个entry是目录或jar文件</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isNestedArchive</span><span class="params">(Archive.Entry entry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断给定的entry是目录</span></span><br><span class="line">		<span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">            <span class="comment">// entry的名称等于BOOT-INF/classes/就返回true</span></span><br><span class="line">			<span class="keyword">return</span> entry.getName().equals(BOOT_INF_CLASSES);</span><br><span class="line">		&#125; <span class="comment">// 不是目录，是一个文件，判断是不是以BOOT-INF/lib/开头的</span></span><br><span class="line">		<span class="keyword">return</span> entry.getName().startsWith(BOOT_INF_LIB);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 位于springboot_lecture-1.0\META-INF\MANIFEST.MF中内容如下：</span></span><br><span class="line">    <span class="comment">// Manifest-Version: 1.0</span></span><br><span class="line">	<span class="comment">// Start-Class: com.shengsiyuan.boot.MyApplication</span></span><br><span class="line">	<span class="comment">// Spring-Boot-Classes: BOOT-INF/classes/</span></span><br><span class="line">	<span class="comment">// Spring-Boot-Lib: BOOT-INF/lib/</span></span><br><span class="line">	<span class="comment">// Spring-Boot-Version: 2.2.5.RELEASE 版本</span></span><br><span class="line">	<span class="comment">// Main-Class: org.springframework.boot.loader.JarLauncher，这个类一定包含main方法，	 // 作为程序的入口</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 真正启动的入口，JarLauncher创建实例后，调用它的launch方法，将命令行参数传递进去，		// launch方法显然是调用父类Launcher类</span></span><br><span class="line">		<span class="keyword">new</span> JarLauncher().launch(args); </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、WarLauncher类详解"><a href="#4、WarLauncher类详解" class="headerlink" title="4、WarLauncher类详解"></a>4、WarLauncher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个针对于war的归档文件的启动器，这个启动器是针对于标准war的归档文件，支持依赖位于</span></span><br><span class="line"><span class="comment">// WEB-INF/lib目录下，同时还位于WEB-INF/lib-provided目录，然后类是位于WEB-INF/classes目录下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Launcher&#125; for WAR based archives. This launcher for standard WAR archives.</span></span><br><span class="line"><span class="comment"> * Supports dependencies in &#123;<span class="doctag">@code</span> WEB-INF/lib&#125; as well as &#123;<span class="doctag">@code</span> WEB-INF/lib-provided&#125;,</span></span><br><span class="line"><span class="comment"> * classes are loaded from &#123;<span class="doctag">@code</span> WEB-INF/classes&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WarLauncher</span> <span class="keyword">extends</span> <span class="title">ExecutableArchiveLauncher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF = <span class="string">"WEB-INF/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF_CLASSES = WEB_INF + <span class="string">"classes/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF_LIB = WEB_INF + <span class="string">"lib/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF_LIB_PROVIDED = WEB_INF + <span class="string">"lib-provided/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">WarLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">WarLauncher</span><span class="params">(Archive archive)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(archive);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNestedArchive</span><span class="params">(Archive.Entry entry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">			<span class="keyword">return</span> entry.getName().equals(WEB_INF_CLASSES);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> entry.getName().startsWith(WEB_INF_LIB) || entry.getName().startsWith(WEB_INF_LIB_PROVIDED);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> WarLauncher().launch(args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、JarFile类详解"><a href="#5、JarFile类详解" class="headerlink" title="5、JarFile类详解"></a>5、JarFile类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader.jar;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandlerFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.data.RandomAccessData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.data.RandomAccessDataFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extended variant of &#123;<span class="doctag">@link</span> java.util.jar.JarFile&#125; that behaves in the same way but</span></span><br><span class="line"><span class="comment"> * offers the following additional functionality.</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;A nested &#123;<span class="doctag">@link</span> JarFile&#125; can be &#123;<span class="doctag">@link</span> #getNestedJarFile(ZipEntry) obtained&#125; based</span></span><br><span class="line"><span class="comment"> * on any directory entry.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;A nested &#123;<span class="doctag">@link</span> JarFile&#125; can be &#123;<span class="doctag">@link</span> #getNestedJarFile(ZipEntry) obtained&#125; for</span></span><br><span class="line"><span class="comment"> * embedded JAR files (as long as their entry is not compressed).&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JarFile</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">jar</span>.<span class="title">JarFile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MANIFEST_NAME = <span class="string">"META-INF/MANIFEST.MF"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROTOCOL_HANDLER = <span class="string">"java.protocol.handler.pkgs"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HANDLERS_PACKAGE = <span class="string">"org.springframework.boot.loader"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AsciiBytes META_INF = <span class="keyword">new</span> AsciiBytes(<span class="string">"META-INF/"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AsciiBytes SIGNATURE_FILE_EXTENSION = <span class="keyword">new</span> AsciiBytes(<span class="string">".SF"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RandomAccessDataFile rootFile;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String pathFromRoot;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RandomAccessData data;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> JarFileType type;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> URL url;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String urlString;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> JarFileEntries entries;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Supplier&lt;Manifest&gt; manifestSupplier;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SoftReference&lt;Manifest&gt; manifest;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> signed;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String comment;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> JarFile&#125; backed by the specified file.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> file the root jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JarFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(<span class="keyword">new</span> RandomAccessDataFile(file));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> JarFile&#125; backed by the specified file.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> file the root jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	JarFile(RandomAccessDataFile file) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="keyword">this</span>(file, <span class="string">""</span>, file, JarFileType.DIRECT);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Private constructor used to create a new &#123;<span class="doctag">@link</span> JarFile&#125; either directly or from a</span></span><br><span class="line"><span class="comment">	 * nested entry.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> rootFile the root jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> pathFromRoot the name of this file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> data the underlying data</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> type the type of the jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">JarFile</span><span class="params">(RandomAccessDataFile rootFile, String pathFromRoot, RandomAccessData data, JarFileType type)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(rootFile, pathFromRoot, data, <span class="keyword">null</span>, type, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">JarFile</span><span class="params">(RandomAccessDataFile rootFile, String pathFromRoot, RandomAccessData data, JarEntryFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">			JarFileType type, Supplier&lt;Manifest&gt; manifestSupplier)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(rootFile.getFile());</span><br><span class="line">		<span class="keyword">this</span>.rootFile = rootFile;</span><br><span class="line">		<span class="keyword">this</span>.pathFromRoot = pathFromRoot;</span><br><span class="line">		CentralDirectoryParser parser = <span class="keyword">new</span> CentralDirectoryParser();</span><br><span class="line">		<span class="keyword">this</span>.entries = parser.addVisitor(<span class="keyword">new</span> JarFileEntries(<span class="keyword">this</span>, filter));</span><br><span class="line">		<span class="keyword">this</span>.type = type;</span><br><span class="line">		parser.addVisitor(centralDirectoryVisitor());</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.data = parser.parse(data, filter == <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.manifestSupplier = (manifestSupplier != <span class="keyword">null</span>) ? manifestSupplier : () -&gt; &#123;</span><br><span class="line">			<span class="keyword">try</span> (InputStream inputStream = getInputStream(MANIFEST_NAME)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> Manifest(inputStream);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> CentralDirectoryVisitor <span class="title">centralDirectoryVisitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> CentralDirectoryVisitor() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitStart</span><span class="params">(CentralDirectoryEndRecord endRecord, RandomAccessData centralDirectoryData)</span> </span>&#123;</span><br><span class="line">				JarFile.<span class="keyword">this</span>.comment = endRecord.getComment();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFileHeader</span><span class="params">(CentralDirectoryFileHeader fileHeader, <span class="keyword">int</span> dataOffset)</span> </span>&#123;</span><br><span class="line">				AsciiBytes name = fileHeader.getName();</span><br><span class="line">				<span class="keyword">if</span> (name.startsWith(META_INF) &amp;&amp; name.endsWith(SIGNATURE_FILE_EXTENSION)) &#123;</span><br><span class="line">					JarFile.<span class="keyword">this</span>.signed = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> RandomAccessDataFile <span class="title">getRootJarFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.rootFile;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">RandomAccessData <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Manifest <span class="title">getManifest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		Manifest manifest = (<span class="keyword">this</span>.manifest != <span class="keyword">null</span>) ? <span class="keyword">this</span>.manifest.get() : <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (manifest == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				manifest = <span class="keyword">this</span>.manifestSupplier.get();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IOException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.manifest = <span class="keyword">new</span> SoftReference&lt;&gt;(manifest);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> manifest;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Enumeration&lt;java.util.jar.JarEntry&gt; entries() &#123;</span><br><span class="line">		<span class="keyword">final</span> Iterator&lt;JarEntry&gt; iterator = <span class="keyword">this</span>.entries.iterator();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Enumeration&lt;java.util.jar.JarEntry&gt;() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> iterator.hasNext();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> java.util.jar.<span class="function">JarEntry <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> iterator.next();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JarEntry <span class="title">getJarEntry</span><span class="params">(CharSequence name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JarEntry <span class="title">getJarEntry</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (JarEntry) getEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsEntry</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.containsEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ZipEntry <span class="title">getEntry</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> InputStream <span class="title">getInputStream</span><span class="params">(ZipEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> JarEntry) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.entries.getInputStream((JarEntry) entry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getInputStream((entry != <span class="keyword">null</span>) ? entry.getName() : <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InputStream <span class="title">getInputStream</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getInputStream(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a nested &#123;<span class="doctag">@link</span> JarFile&#125; loaded from the specified entry.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> entry the zip entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> JarFile&#125; for the entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the nested jar file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> JarFile <span class="title">getNestedJarFile</span><span class="params">(ZipEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getNestedJarFile((JarEntry) entry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a nested &#123;<span class="doctag">@link</span> JarFile&#125; loaded from the specified entry.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> entry the zip entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> JarFile&#125; for the entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the nested jar file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> JarFile <span class="title">getNestedJarFile</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> createJarFileFromEntry(entry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unable to open nested jar file '"</span> + entry.getName() + <span class="string">"'"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> JarFile <span class="title">createJarFileFromEntry</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">			<span class="keyword">return</span> createJarFileFromDirectoryEntry(entry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> createJarFileFromFileEntry(entry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> JarFile <span class="title">createJarFileFromDirectoryEntry</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		AsciiBytes name = entry.getAsciiBytesName();</span><br><span class="line">		JarEntryFilter filter = (candidate) -&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span> (candidate.startsWith(name) &amp;&amp; !candidate.equals(name)) &#123;</span><br><span class="line">				<span class="keyword">return</span> candidate.substring(name.length());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JarFile(<span class="keyword">this</span>.rootFile, <span class="keyword">this</span>.pathFromRoot + <span class="string">"!/"</span> + entry.getName().substring(<span class="number">0</span>, name.length() - <span class="number">1</span>),</span><br><span class="line">				<span class="keyword">this</span>.data, filter, JarFileType.NESTED_DIRECTORY, <span class="keyword">this</span>.manifestSupplier);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> JarFile <span class="title">createJarFileFromFileEntry</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry.getMethod() != ZipEntry.STORED) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">					<span class="string">"Unable to open nested entry '"</span> + entry.getName() + <span class="string">"'. It has been compressed and nested "</span></span><br><span class="line">							+ <span class="string">"jar files must be stored without compression. Please check the "</span></span><br><span class="line">							+ <span class="string">"mechanism used to create your executable jar file"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		RandomAccessData entryData = <span class="keyword">this</span>.entries.getEntryData(entry.getName());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JarFile(<span class="keyword">this</span>.rootFile, <span class="keyword">this</span>.pathFromRoot + <span class="string">"!/"</span> + entry.getName(), entryData,</span><br><span class="line">				JarFileType.NESTED_JAR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getComment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.comment;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getSize();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.close();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.type == JarFileType.DIRECT) &#123;</span><br><span class="line">			<span class="keyword">this</span>.rootFile.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getUrlString</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.urlString == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.urlString = getUrl().toString();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.urlString;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a URL that can be used to access this JAR file. <span class="doctag">NOTE:</span> the specified URL</span></span><br><span class="line"><span class="comment">	 * cannot be serialized and or cloned.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the URL</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> MalformedURLException if the URL is malformed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> URL <span class="title">getUrl</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.url == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Handler handler = <span class="keyword">new</span> Handler(<span class="keyword">this</span>);</span><br><span class="line">			String file = <span class="keyword">this</span>.rootFile.getFile().toURI() + <span class="keyword">this</span>.pathFromRoot + <span class="string">"!/"</span>;</span><br><span class="line">			file = file.replace(<span class="string">"file:////"</span>, <span class="string">"file://"</span>); <span class="comment">// Fix UNC paths</span></span><br><span class="line">			<span class="keyword">this</span>.url = <span class="keyword">new</span> URL(<span class="string">"jar"</span>, <span class="string">""</span>, -<span class="number">1</span>, file, handler);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.url;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getName();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.rootFile.getFile() + <span class="keyword">this</span>.pathFromRoot;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isSigned</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.signed;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setupEntryCertificates</span><span class="params">(JarEntry entry)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Fallback to JarInputStream to obtain certificates, not fast but hopefully not</span></span><br><span class="line">		<span class="comment">// happening that often.</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> (JarInputStream inputStream = <span class="keyword">new</span> JarInputStream(getData().getInputStream())) &#123;</span><br><span class="line">				java.util.jar.JarEntry certEntry = inputStream.getNextJarEntry();</span><br><span class="line">				<span class="keyword">while</span> (certEntry != <span class="keyword">null</span>) &#123;</span><br><span class="line">					inputStream.closeEntry();</span><br><span class="line">					<span class="keyword">if</span> (entry.getName().equals(certEntry.getName())) &#123;</span><br><span class="line">						setCertificates(entry, certEntry);</span><br><span class="line">					&#125;</span><br><span class="line">					setCertificates(getJarEntry(certEntry.getName()), certEntry);</span><br><span class="line">					certEntry = inputStream.getNextJarEntry();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCertificates</span><span class="params">(JarEntry entry, java.util.jar.JarEntry certEntry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">			entry.setCertificates(certEntry);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.entries.clearCache();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">getPathFromRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.pathFromRoot;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">JarFileType <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册一个java.protocol.handler.pkgs属性这样URLStreamHandler就可以被定位处理jar文件</span></span><br><span class="line">    <span class="comment">// 的url</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Register a &#123;<span class="doctag">@literal</span> 'java.protocol.handler.pkgs'&#125; property so that a</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> URLStreamHandler&#125; will be located to deal with jar URLs.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerUrlProtocolHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String handlers = System.getProperty(PROTOCOL_HANDLER, <span class="string">""</span>);</span><br><span class="line">		System.setProperty(PROTOCOL_HANDLER,</span><br><span class="line">				(<span class="string">""</span>.equals(handlers) ? HANDLERS_PACKAGE : handlers + <span class="string">"|"</span> + HANDLERS_PACKAGE));</span><br><span class="line">		resetCachedUrlHandlers();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Reset any cached handlers just in case a jar protocol has already been used. We</span></span><br><span class="line"><span class="comment">	 * reset the handler by trying to set a null &#123;<span class="doctag">@link</span> URLStreamHandlerFactory&#125; which</span></span><br><span class="line"><span class="comment">	 * should have no effect other than clearing the handlers cache.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resetCachedUrlHandlers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			URL.setURLStreamHandlerFactory(<span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Error ex) &#123;</span><br><span class="line">			<span class="comment">// Ignore</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The type of a &#123;<span class="doctag">@link</span> JarFile&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">enum</span> JarFileType &#123;</span><br><span class="line"></span><br><span class="line">		DIRECT, NESTED_DIRECTORY, NESTED_JAR</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、Archive类详解"><a href="#6、Archive类详解" class="headerlink" title="6、Archive类详解"></a>6、Archive类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader.archive;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.Launcher;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An archive that can be launched by the &#123;<span class="doctag">@link</span> Launcher&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> JarFileArchive</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Archive</span> <span class="keyword">extends</span> <span class="title">Iterable</span>&lt;<span class="title">Archive</span>.<span class="title">Entry</span>&gt;, <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a URL that can be used to load the archive.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the archive URL</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> MalformedURLException if the URL is malformed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">URL <span class="title">getUrl</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the manifest of the archive.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the manifest</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the manifest cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">Manifest <span class="title">getManifest</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回与所指定的过滤器相匹配的归档文件，具体的实现</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns nested &#123;<span class="doctag">@link</span> Archive&#125;s for entries that match the specified filter.</span></span><br><span class="line"><span class="comment">	 // 用于限制entries的过滤器</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> filter the filter used to limit entries </span></span><br><span class="line"><span class="comment">	 // 返回被嵌套的归档文件</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> nested archives </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if nested archives cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">List&lt;Archive&gt; <span class="title">getNestedArchives</span><span class="params">(EntryFilter filter)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Closes the &#123;<span class="doctag">@code</span> Archive&#125;, releasing any open resources.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if an error occurs during close processing</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.2.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Represents a single entry in the archive.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">interface</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Returns &#123;<span class="doctag">@code</span> true&#125; if the entry represents a directory.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@return</span> if the entry is a directory</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function"><span class="keyword">boolean</span> <span class="title">isDirectory</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Returns the name of the entry.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@return</span> the name of the entry</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Strategy interface to filter &#123;<span class="doctag">@link</span> Entry Entries&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">interface</span> <span class="title">EntryFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Apply the jar entry filter.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> entry the entry to filter</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the filter matches</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Entry entry)</span></span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7、JarFileArchive类重要方法详解"><a href="#7、JarFileArchive类重要方法详解" class="headerlink" title="7、JarFileArchive类重要方法详解"></a>7、JarFileArchive类重要方法详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入一个过滤器，这个过滤器是一个EntryFilter类型的</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Archive&gt; <span class="title">getNestedArchives</span><span class="params">(EntryFilter filter)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	List&lt;Archive&gt; nestedArchives = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	<span class="keyword">for</span> (Entry entry : <span class="keyword">this</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (filter.matches(entry)) &#123;</span><br><span class="line">			nestedArchives.add(getNestedArchive(entry));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Collections.unmodifiableList(nestedArchives);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8、LaunchedURLClassLoader类详解"><a href="#8、LaunchedURLClassLoader类详解" class="headerlink" title="8、LaunchedURLClassLoader类详解"></a>8、LaunchedURLClassLoader类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.JarURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.security.AccessController;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivilegedExceptionAction;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.jar.Handler;</span><br><span class="line"><span class="comment">// 类加载器于被Launcher所使用，它的父类是URLClassLoader</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ClassLoader&#125; used by the &#123;<span class="doctag">@link</span> Launcher&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LaunchedURLClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		ClassLoader.registerAsParallelCapable();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 创建一个新的LaunchedURLClassLoader的实例</span></span><br><span class="line">    <span class="comment">// 第一个参数：urls指定好绝对路径从什么地方加载类和资源</span></span><br><span class="line">    <span class="comment">// 第二个参数：parent父类加载器用于委托</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> LaunchedURLClassLoader&#125; instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LaunchedURLClassLoader</span><span class="params">(URL[] urls, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(urls, parent);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> URL <span class="title">findResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">super</span>.findResource(name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> UseFastConnectionExceptionsEnumeration(<span class="keyword">super</span>.findResources(name));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">		Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				definePackageIfNecessary(name);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">				<span class="comment">// Tolerate race condition due to being parallel capable</span></span><br><span class="line">				<span class="keyword">if</span> (getPackage(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">// This should never happen as the IllegalArgumentException indicates</span></span><br><span class="line">					<span class="comment">// that the package has already been defined and, therefore,</span></span><br><span class="line">					<span class="comment">// getPackage(name) should not return null.</span></span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Package "</span> + name + <span class="string">" has already been defined but it could not be found"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name, resolve);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Define a package before a &#123;<span class="doctag">@code</span> findClass&#125; call is made. This is necessary to</span></span><br><span class="line"><span class="comment">	 * ensure that the appropriate manifest for nested JARs is associated with the</span></span><br><span class="line"><span class="comment">	 * package.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> className the class name being found</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">definePackageIfNecessary</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> lastDot = className.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">		<span class="keyword">if</span> (lastDot &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			String packageName = className.substring(<span class="number">0</span>, lastDot);</span><br><span class="line">			<span class="keyword">if</span> (getPackage(packageName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					definePackage(className, packageName);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">					<span class="comment">// Tolerate race condition due to being parallel capable</span></span><br><span class="line">					<span class="keyword">if</span> (getPackage(packageName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="comment">// This should never happen as the IllegalArgumentException</span></span><br><span class="line">						<span class="comment">// indicates that the package has already been defined and,</span></span><br><span class="line">						<span class="comment">// therefore, getPackage(name) should not have returned null.</span></span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(</span><br><span class="line">								<span class="string">"Package "</span> + packageName + <span class="string">" has already been defined but it could not be found"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">definePackage</span><span class="params">(String className, String packageName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">				String packageEntryName = packageName.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">"/"</span>;</span><br><span class="line">				String classEntryName = className.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">".class"</span>;</span><br><span class="line">				<span class="keyword">for</span> (URL url : getURLs()) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						URLConnection connection = url.openConnection();</span><br><span class="line">						<span class="keyword">if</span> (connection <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">							JarFile jarFile = ((JarURLConnection) connection).getJarFile();</span><br><span class="line">							<span class="keyword">if</span> (jarFile.getEntry(classEntryName) != <span class="keyword">null</span> &amp;&amp; jarFile.getEntry(packageEntryName) != <span class="keyword">null</span></span><br><span class="line">									&amp;&amp; jarFile.getManifest() != <span class="keyword">null</span>) &#123;</span><br><span class="line">								definePackage(packageName, jarFile.getManifest(), url);</span><br><span class="line">								<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">						<span class="comment">// Ignore</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;, AccessController.getContext());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (java.security.PrivilegedActionException ex) &#123;</span><br><span class="line">			<span class="comment">// Ignore</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Clear URL caches.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (URL url : getURLs()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				URLConnection connection = url.openConnection();</span><br><span class="line">				<span class="keyword">if</span> (connection <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">					clearCache(connection);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">				<span class="comment">// Ignore</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">(URLConnection connection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		Object jarFile = ((JarURLConnection) connection).getJarFile();</span><br><span class="line">		<span class="keyword">if</span> (jarFile <span class="keyword">instanceof</span> org.springframework.boot.loader.jar.JarFile) &#123;</span><br><span class="line">			((org.springframework.boot.loader.jar.JarFile) jarFile).clearCache();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UseFastConnectionExceptionsEnumeration</span> <span class="keyword">implements</span> <span class="title">Enumeration</span>&lt;<span class="title">URL</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Enumeration&lt;URL&gt; delegate;</span><br><span class="line"></span><br><span class="line">		UseFastConnectionExceptionsEnumeration(Enumeration&lt;URL&gt; delegate) &#123;</span><br><span class="line">			<span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>.delegate.hasMoreElements();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> URL <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>.delegate.nextElement();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9、URLClassLoader类详解"><a href="#9、URLClassLoader类详解" class="headerlink" title="9、URLClassLoader类详解"></a>9、URLClassLoader类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Closeable;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FilePermission;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.AccessControlContext;</span><br><span class="line"><span class="keyword">import</span> java.security.AccessController;</span><br><span class="line"><span class="keyword">import</span> java.security.CodeSigner;</span><br><span class="line"><span class="keyword">import</span> java.security.CodeSource;</span><br><span class="line"><span class="keyword">import</span> java.security.Permission;</span><br><span class="line"><span class="keyword">import</span> java.security.PermissionCollection;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivilegedAction;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivilegedExceptionAction;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.NoSuchElementException;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.WeakHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Attributes;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Attributes.Name;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Resource;</span><br><span class="line"><span class="keyword">import</span> sun.misc.URLClassPath;</span><br><span class="line"><span class="keyword">import</span> sun.net.www.ParseUtil;</span><br><span class="line"><span class="keyword">import</span> sun.security.util.SecurityConstants;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个类加载器用于加载类和资源，从一个url搜索路径指向jar文件或目录。任何url只要以/结尾的</span></span><br><span class="line"><span class="comment">// 都会被指定引用的目录，否则这个url就会被认为指向的是jar文件，根据需要被打开</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class loader is used to load classes and resources from a search</span></span><br><span class="line"><span class="comment"> * path of URLs referring to both JAR files and directories. Any URL that</span></span><br><span class="line"><span class="comment"> * ends with a '/' is assumed to refer to a directory. Otherwise, the URL</span></span><br><span class="line"><span class="comment"> * is assumed to refer to a JAR file which will be opened as needed.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The AccessControlContext of the thread that created the instance of</span></span><br><span class="line"><span class="comment"> * URLClassLoader will be used when subsequently loading classes and</span></span><br><span class="line"><span class="comment"> * resources.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The classes that are loaded are by default granted permission only to</span></span><br><span class="line"><span class="comment"> * access the URLs specified when the URLClassLoader was created.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  David Connelly</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>   1.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLClassLoader</span> <span class="keyword">extends</span> <span class="title">SecureClassLoader</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* The search path for classes and resources */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URLClassPath ucp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The context to be used when loading classes and resources */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessControlContext acc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new URLClassLoader for the given URLs. The URLs will be</span></span><br><span class="line"><span class="comment">     * searched in the order specified for classes and resources after first</span></span><br><span class="line"><span class="comment">     * searching in the specified parent class loader. Any URL that ends with</span></span><br><span class="line"><span class="comment">     * a '/' is assumed to refer to a directory. Otherwise, the URL is assumed</span></span><br><span class="line"><span class="comment">     * to refer to a JAR file which will be downloaded and opened as needed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If there is a security manager, this method first</span></span><br><span class="line"><span class="comment">     * calls the security manager's &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method</span></span><br><span class="line"><span class="comment">     * to ensure creation of a class loader is allowed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  SecurityException  if a security manager exists and its</span></span><br><span class="line"><span class="comment">     *             &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method doesn't allow</span></span><br><span class="line"><span class="comment">     *             creation of a class loader.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SecurityManager#checkCreateClassLoader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    URLClassLoader(URL[] urls, ClassLoader parent,</span><br><span class="line">                   AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = acc;</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new URLClassLoader for the specified URLs using the</span></span><br><span class="line"><span class="comment">     * default delegation parent &#123;<span class="doctag">@code</span> ClassLoader&#125;. The URLs will</span></span><br><span class="line"><span class="comment">     * be searched in the order specified for classes and resources after</span></span><br><span class="line"><span class="comment">     * first searching in the parent class loader. Any URL that ends with</span></span><br><span class="line"><span class="comment">     * a '/' is assumed to refer to a directory. Otherwise, the URL is</span></span><br><span class="line"><span class="comment">     * assumed to refer to a JAR file which will be downloaded and opened</span></span><br><span class="line"><span class="comment">     * as needed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If there is a security manager, this method first</span></span><br><span class="line"><span class="comment">     * calls the security manager's &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method</span></span><br><span class="line"><span class="comment">     * to ensure creation of a class loader is allowed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  SecurityException  if a security manager exists and its</span></span><br><span class="line"><span class="comment">     *             &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method doesn't allow</span></span><br><span class="line"><span class="comment">     *             creation of a class loader.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SecurityManager#checkCreateClassLoader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    URLClassLoader(URL[] urls, AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = acc;</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new URLClassLoader for the specified URLs, parent</span></span><br><span class="line"><span class="comment">     * class loader, and URLStreamHandlerFactory. The parent argument</span></span><br><span class="line"><span class="comment">     * will be used as the parent class loader for delegation. The</span></span><br><span class="line"><span class="comment">     * factory argument will be used as the stream handler factory to</span></span><br><span class="line"><span class="comment">     * obtain protocol handlers when creating new jar URLs.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If there is a security manager, this method first</span></span><br><span class="line"><span class="comment">     * calls the security manager's &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method</span></span><br><span class="line"><span class="comment">     * to ensure creation of a class loader is allowed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> factory the URLStreamHandlerFactory to use when creating URLs</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  SecurityException  if a security manager exists and its</span></span><br><span class="line"><span class="comment">     *             &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method doesn't allow</span></span><br><span class="line"><span class="comment">     *             creation of a class loader.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SecurityManager#checkCreateClassLoader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls, ClassLoader parent,</span></span></span><br><span class="line"><span class="function"><span class="params">                          URLStreamHandlerFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, factory, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* A map (used as a set) to keep track of closeable local resources</span></span><br><span class="line"><span class="comment">     * (either JarFiles or FileInputStreams). We don't care about</span></span><br><span class="line"><span class="comment">     * Http resources since they don't need to be closed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If the resource is coming from a jar file</span></span><br><span class="line"><span class="comment">     * we keep a (weak) reference to the JarFile object which can</span></span><br><span class="line"><span class="comment">     * be closed if URLClassLoader.close() called. Due to jar file</span></span><br><span class="line"><span class="comment">     * caching there will typically be only one JarFile object</span></span><br><span class="line"><span class="comment">     * per underlying jar file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * For file resources, which is probably a less common situation</span></span><br><span class="line"><span class="comment">     * we have to keep a weak reference to each stream.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WeakHashMap&lt;Closeable,Void&gt;</span><br><span class="line">        closeables = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an input stream for reading the specified resource.</span></span><br><span class="line"><span class="comment">     * If this loader is closed, then any resources opened by this method</span></span><br><span class="line"><span class="comment">     * will be closed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; The search order is described in the documentation for &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * #getResource(String)&#125;.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  name</span></span><br><span class="line"><span class="comment">     *         The resource name</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  An input stream for reading the resource, or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">     *          if the resource could not be found</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span>  1.7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getResourceAsStream</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        URL url = getResource(name);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            URLConnection urlc = url.openConnection();</span><br><span class="line">            InputStream is = urlc.getInputStream();</span><br><span class="line">            <span class="keyword">if</span> (urlc <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">                JarURLConnection juc = (JarURLConnection)urlc;</span><br><span class="line">                JarFile jar = juc.getJarFile();</span><br><span class="line">                <span class="keyword">synchronized</span> (closeables) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!closeables.containsKey(jar)) &#123;</span><br><span class="line">                        closeables.put(jar, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (urlc <span class="keyword">instanceof</span> sun.net.www.protocol.file.FileURLConnection) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (closeables) &#123;</span><br><span class="line">                    closeables.put(is, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> is;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Closes this URLClassLoader, so that it can no longer be used to load</span></span><br><span class="line"><span class="comment">    * new classes or resources that are defined by this loader.</span></span><br><span class="line"><span class="comment">    * Classes and resources defined by any of this loader's parents in the</span></span><br><span class="line"><span class="comment">    * delegation hierarchy are still accessible. Also, any classes or resources</span></span><br><span class="line"><span class="comment">    * that are already loaded, are still accessible.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * In the case of jar: and file: URLs, it also closes any files</span></span><br><span class="line"><span class="comment">    * that were opened by it. If another thread is loading a</span></span><br><span class="line"><span class="comment">    * class when the &#123;<span class="doctag">@code</span> close&#125; method is invoked, then the result of</span></span><br><span class="line"><span class="comment">    * that load is undefined.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * The method makes a best effort attempt to close all opened files,</span></span><br><span class="line"><span class="comment">    * by catching &#123;<span class="doctag">@link</span> IOException&#125;s internally. Unchecked exceptions</span></span><br><span class="line"><span class="comment">    * and errors are not caught. Calling close on an already closed</span></span><br><span class="line"><span class="comment">    * loader has no effect.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@exception</span> IOException if closing any file opened by this class loader</span></span><br><span class="line"><span class="comment">    * resulted in an IOException. Any such exceptions are caught internally.</span></span><br><span class="line"><span class="comment">    * If only one is caught, then it is re-thrown. If more than one exception</span></span><br><span class="line"><span class="comment">    * is caught, then the second and following exceptions are added</span></span><br><span class="line"><span class="comment">    * as suppressed exceptions of the first one caught, which is then re-thrown.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@exception</span> SecurityException if a security manager is set, and it denies</span></span><br><span class="line"><span class="comment">    *   &#123;<span class="doctag">@link</span> RuntimePermission&#125;&#123;<span class="doctag">@code</span> ("closeClassLoader")&#125;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@since</span> 1.7</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkPermission(<span class="keyword">new</span> RuntimePermission(<span class="string">"closeClassLoader"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;IOException&gt; errors = ucp.closeLoaders();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// now close any remaining streams.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (closeables) &#123;</span><br><span class="line">            Set&lt;Closeable&gt; keys = closeables.keySet();</span><br><span class="line">            <span class="keyword">for</span> (Closeable c : keys) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    c.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioex) &#123;</span><br><span class="line">                    errors.add(ioex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            closeables.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (errors.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        IOException firstex = errors.remove(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Suppress any remaining exceptions</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (IOException error: errors) &#123;</span><br><span class="line">            firstex.addSuppressed(error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> firstex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Appends the specified URL to the list of URLs to search for</span></span><br><span class="line"><span class="comment">     * classes and resources.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the URL specified is &#123;<span class="doctag">@code</span> null&#125; or is already in the</span></span><br><span class="line"><span class="comment">     * list of URLs, or if this loader is closed, then invoking this</span></span><br><span class="line"><span class="comment">     * method has no effect.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url the URL to be added to the search path of URLs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addURL</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">        ucp.addURL(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the search path of URLs for loading classes and resources.</span></span><br><span class="line"><span class="comment">     * This includes the original list of URLs specified to the constructor,</span></span><br><span class="line"><span class="comment">     * along with any URLs subsequently appended by the addURL() method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the search path of URLs for loading classes and resources.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> URL[] getURLs() &#123;</span><br><span class="line">        <span class="keyword">return</span> ucp.getURLs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds and loads the class with the specified name from the URL search</span></span><br><span class="line"><span class="comment">     * path. Any URLs referring to JAR files are loaded and opened as needed</span></span><br><span class="line"><span class="comment">     * until the class is found.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the resulting class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> ClassNotFoundException if the class could not be found,</span></span><br><span class="line"><span class="comment">     *            or if the loader is closed.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> NullPointerException if &#123;<span class="doctag">@code</span> name&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(<span class="keyword">final</span> String name)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> PrivilegedExceptionAction&lt;Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">                    <span class="keyword">public</span> Class&lt;?&gt; run() <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">".class"</span>);</span><br><span class="line">                        Resource res = ucp.getResource(path, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (res != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> defineClass(name, res);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException pae) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (ClassNotFoundException) pae.getException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Retrieve the package using the specified package name.</span></span><br><span class="line"><span class="comment">     * If non-null, verify the package using the specified code</span></span><br><span class="line"><span class="comment">     * source and manifest.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Package <span class="title">getAndVerifyPackage</span><span class="params">(String pkgname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Manifest man, URL url)</span> </span>&#123;</span><br><span class="line">        Package pkg = getPackage(pkgname);</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Package found, so check package sealing.</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.isSealed()) &#123;</span><br><span class="line">                <span class="comment">// Verify that code source URL is the same.</span></span><br><span class="line">                <span class="keyword">if</span> (!pkg.isSealed(url)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"sealing violation: package "</span> + pkgname + <span class="string">" is sealed"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Make sure we are not attempting to seal the package</span></span><br><span class="line">                <span class="comment">// at this code source URL.</span></span><br><span class="line">                <span class="keyword">if</span> ((man != <span class="keyword">null</span>) &amp;&amp; isSealed(pkgname, man)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"sealing violation: can't seal package "</span> + pkgname +</span><br><span class="line">                        <span class="string">": already loaded"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Also called by VM to define Package for classes loaded from the CDS</span></span><br><span class="line">    <span class="comment">// archive</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">definePackageInternal</span><span class="params">(String pkgname, Manifest man, URL url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getAndVerifyPackage(pkgname, man, url) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (man != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    definePackage(pkgname, man, url);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    definePackage(pkgname, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException iae) &#123;</span><br><span class="line">                <span class="comment">// parallel-capable class loaders: re-verify in case of a</span></span><br><span class="line">                <span class="comment">// race condition</span></span><br><span class="line">                <span class="keyword">if</span> (getAndVerifyPackage(pkgname, man, url) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Should never happen</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Cannot find package "</span> +</span><br><span class="line">                                             pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Defines a Class using the class bytes obtained from the specified</span></span><br><span class="line"><span class="comment">     * Resource. The resulting Class must be resolved before it can be</span></span><br><span class="line"><span class="comment">     * used.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; defineClass(String name, Resource res) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">        <span class="keyword">int</span> i = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">        URL url = res.getCodeSourceURL();</span><br><span class="line">        <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">            String pkgname = name.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="comment">// Check if package already loaded.</span></span><br><span class="line">            Manifest man = res.getManifest();</span><br><span class="line">            definePackageInternal(pkgname, man, url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Now read the class bytes and define the class</span></span><br><span class="line">        java.nio.ByteBuffer bb = res.getByteBuffer();</span><br><span class="line">        <span class="keyword">if</span> (bb != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Use (direct) ByteBuffer:</span></span><br><span class="line">            CodeSigner[] signers = res.getCodeSigners();</span><br><span class="line">            CodeSource cs = <span class="keyword">new</span> CodeSource(url, signers);</span><br><span class="line">            sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, bb, cs);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] b = res.getBytes();</span><br><span class="line">            <span class="comment">// must read certificates AFTER reading bytes.</span></span><br><span class="line">            CodeSigner[] signers = res.getCodeSigners();</span><br><span class="line">            CodeSource cs = <span class="keyword">new</span> CodeSource(url, signers);</span><br><span class="line">            sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length, cs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Defines a new package by name in this ClassLoader. The attributes</span></span><br><span class="line"><span class="comment">     * contained in the specified Manifest will be used to obtain package</span></span><br><span class="line"><span class="comment">     * version and sealing information. For sealed packages, the additional</span></span><br><span class="line"><span class="comment">     * URL specifies the code source URL from which the package was loaded.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name  the package name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> man   the Manifest containing package version and sealing</span></span><br><span class="line"><span class="comment">     *              information</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url   the code source url for the package, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>   IllegalArgumentException if the package name duplicates</span></span><br><span class="line"><span class="comment">     *              an existing package either in this class loader or one</span></span><br><span class="line"><span class="comment">     *              of its ancestors</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the newly defined Package object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Package <span class="title">definePackage</span><span class="params">(String name, Manifest man, URL url)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">"/"</span>);</span><br><span class="line">        String specTitle = <span class="keyword">null</span>, specVersion = <span class="keyword">null</span>, specVendor = <span class="keyword">null</span>;</span><br><span class="line">        String implTitle = <span class="keyword">null</span>, implVersion = <span class="keyword">null</span>, implVendor = <span class="keyword">null</span>;</span><br><span class="line">        String sealed = <span class="keyword">null</span>;</span><br><span class="line">        URL sealBase = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        Attributes attr = man.getAttributes(path);</span><br><span class="line">        <span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            specTitle   = attr.getValue(Name.SPECIFICATION_TITLE);</span><br><span class="line">            specVersion = attr.getValue(Name.SPECIFICATION_VERSION);</span><br><span class="line">            specVendor  = attr.getValue(Name.SPECIFICATION_VENDOR);</span><br><span class="line">            implTitle   = attr.getValue(Name.IMPLEMENTATION_TITLE);</span><br><span class="line">            implVersion = attr.getValue(Name.IMPLEMENTATION_VERSION);</span><br><span class="line">            implVendor  = attr.getValue(Name.IMPLEMENTATION_VENDOR);</span><br><span class="line">            sealed      = attr.getValue(Name.SEALED);</span><br><span class="line">        &#125;</span><br><span class="line">        attr = man.getMainAttributes();</span><br><span class="line">        <span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (specTitle == <span class="keyword">null</span>) &#123;</span><br><span class="line">                specTitle = attr.getValue(Name.SPECIFICATION_TITLE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (specVersion == <span class="keyword">null</span>) &#123;</span><br><span class="line">                specVersion = attr.getValue(Name.SPECIFICATION_VERSION);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (specVendor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                specVendor = attr.getValue(Name.SPECIFICATION_VENDOR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (implTitle == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implTitle = attr.getValue(Name.IMPLEMENTATION_TITLE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (implVersion == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implVersion = attr.getValue(Name.IMPLEMENTATION_VERSION);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (implVendor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implVendor = attr.getValue(Name.IMPLEMENTATION_VENDOR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sealed == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sealed = attr.getValue(Name.SEALED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"true"</span>.equalsIgnoreCase(sealed)) &#123;</span><br><span class="line">            sealBase = url;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> definePackage(name, specTitle, specVersion, specVendor,</span><br><span class="line">                             implTitle, implVersion, implVendor, sealBase);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Returns true if the specified package name is sealed according to the</span></span><br><span class="line"><span class="comment">     * given manifest.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSealed</span><span class="params">(String name, Manifest man)</span> </span>&#123;</span><br><span class="line">        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">"/"</span>);</span><br><span class="line">        Attributes attr = man.getAttributes(path);</span><br><span class="line">        String sealed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sealed = attr.getValue(Name.SEALED);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sealed == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((attr = man.getMainAttributes()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sealed = attr.getValue(Name.SEALED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"true"</span>.equalsIgnoreCase(sealed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds the resource with the specified name on the URL search path.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the resource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> URL&#125; for the resource, or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">     * if the resource could not be found, or if the loader is closed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">findResource</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The same restriction to finding classes applies to resources</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        URL url = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;URL&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URL <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> ucp.findResource(name, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, acc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> url != <span class="keyword">null</span> ? ucp.checkURL(url) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an Enumeration of URLs representing all of the resources</span></span><br><span class="line"><span class="comment">     * on the URL search path having the specified name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the resource name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> IOException if an I/O exception occurs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an &#123;<span class="doctag">@code</span> Enumeration&#125; of &#123;<span class="doctag">@code</span> URL&#125;s</span></span><br><span class="line"><span class="comment">     *         If the loader is closed, the Enumeration will be empty.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(<span class="keyword">final</span> String name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Enumeration&lt;URL&gt; e = ucp.findResources(name, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Enumeration&lt;URL&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> URL url = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    URL u = AccessController.doPrivileged(</span><br><span class="line">                        <span class="keyword">new</span> PrivilegedAction&lt;URL&gt;() &#123;</span><br><span class="line">                            <span class="function"><span class="keyword">public</span> URL <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span> (!e.hasMoreElements())</span><br><span class="line">                                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                                <span class="keyword">return</span> e.nextElement();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, acc);</span><br><span class="line">                    <span class="keyword">if</span> (u == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    url = ucp.checkURL(u);</span><br><span class="line">                &#125; <span class="keyword">while</span> (url == <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">return</span> url != <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> URL <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!next()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">                &#125;</span><br><span class="line">                URL u = url;</span><br><span class="line">                url = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> u;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the permissions for the given codesource object.</span></span><br><span class="line"><span class="comment">     * The implementation of this method first calls super.getPermissions</span></span><br><span class="line"><span class="comment">     * and then adds permissions based on the URL of the codesource.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the protocol of this URL is "jar", then the permission granted</span></span><br><span class="line"><span class="comment">     * is based on the permission that is required by the URL of the Jar</span></span><br><span class="line"><span class="comment">     * file.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the protocol is "file" and there is an authority component, then</span></span><br><span class="line"><span class="comment">     * permission to connect to and accept connections from that authority</span></span><br><span class="line"><span class="comment">     * may be granted. If the protocol is "file"</span></span><br><span class="line"><span class="comment">     * and the path specifies a file, then permission to read that</span></span><br><span class="line"><span class="comment">     * file is granted. If protocol is "file" and the path is</span></span><br><span class="line"><span class="comment">     * a directory, permission is granted to read all files</span></span><br><span class="line"><span class="comment">     * and (recursively) all files and subdirectories contained in</span></span><br><span class="line"><span class="comment">     * that directory.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the protocol is not "file", then permission</span></span><br><span class="line"><span class="comment">     * to connect to and accept connections from the URL's host is granted.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> codesource the codesource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> NullPointerException if &#123;<span class="doctag">@code</span> codesource&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the permissions granted to the codesource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PermissionCollection <span class="title">getPermissions</span><span class="params">(CodeSource codesource)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        PermissionCollection perms = <span class="keyword">super</span>.getPermissions(codesource);</span><br><span class="line"></span><br><span class="line">        URL url = codesource.getLocation();</span><br><span class="line"></span><br><span class="line">        Permission p;</span><br><span class="line">        URLConnection urlConnection;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            urlConnection = url.openConnection();</span><br><span class="line">            p = urlConnection.getPermission();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException ioe) &#123;</span><br><span class="line">            p = <span class="keyword">null</span>;</span><br><span class="line">            urlConnection = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p <span class="keyword">instanceof</span> FilePermission) &#123;</span><br><span class="line">            <span class="comment">// if the permission has a separator char on the end,</span></span><br><span class="line">            <span class="comment">// it means the codebase is a directory, and we need</span></span><br><span class="line">            <span class="comment">// to add an additional permission to read recursively</span></span><br><span class="line">            String path = p.getName();</span><br><span class="line">            <span class="keyword">if</span> (path.endsWith(File.separator)) &#123;</span><br><span class="line">                path += <span class="string">"-"</span>;</span><br><span class="line">                p = <span class="keyword">new</span> FilePermission(path, SecurityConstants.FILE_READ_ACTION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((p == <span class="keyword">null</span>) &amp;&amp; (url.getProtocol().equals(<span class="string">"file"</span>))) &#123;</span><br><span class="line">            String path = url.getFile().replace(<span class="string">'/'</span>, File.separatorChar);</span><br><span class="line">            path = ParseUtil.decode(path);</span><br><span class="line">            <span class="keyword">if</span> (path.endsWith(File.separator))</span><br><span class="line">                path += <span class="string">"-"</span>;</span><br><span class="line">            p =  <span class="keyword">new</span> FilePermission(path, SecurityConstants.FILE_READ_ACTION);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Not loading from a 'file:' URL so we want to give the class</span></span><br><span class="line"><span class="comment">             * permission to connect to and accept from the remote host</span></span><br><span class="line"><span class="comment">             * after we've made sure the host is the correct one and is valid.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            URL locUrl = url;</span><br><span class="line">            <span class="keyword">if</span> (urlConnection <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">                locUrl = ((JarURLConnection)urlConnection).getJarFileURL();</span><br><span class="line">            &#125;</span><br><span class="line">            String host = locUrl.getHost();</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="keyword">null</span> &amp;&amp; (host.length() &gt; <span class="number">0</span>))</span><br><span class="line">                p = <span class="keyword">new</span> SocketPermission(host,</span><br><span class="line">                                         SecurityConstants.SOCKET_CONNECT_ACCEPT_ACTION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// make sure the person that created this class loader</span></span><br><span class="line">        <span class="comment">// would have this permission</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</span><br><span class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Permission fp = p;</span><br><span class="line">                AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> SecurityException </span>&#123;</span><br><span class="line">                        sm.checkPermission(fp);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">            &#125;</span><br><span class="line">            perms.add(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> perms;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance of URLClassLoader for the specified</span></span><br><span class="line"><span class="comment">     * URLs and parent class loader. If a security manager is</span></span><br><span class="line"><span class="comment">     * installed, the &#123;<span class="doctag">@code</span> loadClass&#125; method of the URLClassLoader</span></span><br><span class="line"><span class="comment">     * returned by this method will invoke the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> SecurityManager.checkPackageAccess&#125; method before</span></span><br><span class="line"><span class="comment">     * loading the class.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs to search for classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the resulting class loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URLClassLoader <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> URL[] urls,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">final</span> ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Save the caller's context</span></span><br><span class="line">        <span class="keyword">final</span> AccessControlContext acc = AccessController.getContext();</span><br><span class="line">        <span class="comment">// Need a privileged block to create the class loader</span></span><br><span class="line">        URLClassLoader ucl = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;URLClassLoader&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URLClassLoader <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> FactoryURLClassLoader(urls, parent, acc);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">return</span> ucl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance of URLClassLoader for the specified</span></span><br><span class="line"><span class="comment">     * URLs and default parent class loader. If a security manager is</span></span><br><span class="line"><span class="comment">     * installed, the &#123;<span class="doctag">@code</span> loadClass&#125; method of the URLClassLoader</span></span><br><span class="line"><span class="comment">     * returned by this method will invoke the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> SecurityManager.checkPackageAccess&#125; before</span></span><br><span class="line"><span class="comment">     * loading the class.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs to search for classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the resulting class loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URLClassLoader <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> URL[] urls)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Save the caller's context</span></span><br><span class="line">        <span class="keyword">final</span> AccessControlContext acc = AccessController.getContext();</span><br><span class="line">        <span class="comment">// Need a privileged block to create the class loader</span></span><br><span class="line">        URLClassLoader ucl = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;URLClassLoader&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URLClassLoader <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> FactoryURLClassLoader(urls, acc);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">return</span> ucl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        sun.misc.SharedSecrets.setJavaNetAccess (</span><br><span class="line">            <span class="keyword">new</span> sun.misc.JavaNetAccess() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URLClassPath <span class="title">getURLClassPath</span> <span class="params">(URLClassLoader u)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> u.ucp;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getOriginalHostName</span><span class="params">(InetAddress ia)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> ia.holder.getOriginalHostName();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        ClassLoader.registerAsParallelCapable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryURLClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ClassLoader.registerAsParallelCapable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FactoryURLClassLoader(URL[] urls, ClassLoader parent,</span><br><span class="line">                          AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>(urls, parent, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FactoryURLClassLoader(URL[] urls, AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// First check if we have permission to access the package. This</span></span><br><span class="line">        <span class="comment">// should go away once we've added support for exported packages.</span></span><br><span class="line">        SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">                sm.checkPackageAccess(name.substring(<span class="number">0</span>, i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name, resolve);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10、MainMethodRunner类详解"><a href="#10、MainMethodRunner类详解" class="headerlink" title="10、MainMethodRunner类详解"></a>10、MainMethodRunner类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是一个辅助类，被Launcher使用用来调用main方法，包含main方法的类是使用线线程上下文类加载器加载的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Utility class that is used by &#123;<span class="doctag">@link</span> Launcher&#125;s to call a main method. The class</span></span><br><span class="line"><span class="comment"> * containing the main method is loaded using the thread context class loader.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainMethodRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String mainClassName;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个MainMethodRunner的实例</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> MainMethodRunner&#125; instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mainClass the main class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args incoming arguments</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MainMethodRunner</span><span class="params">(String mainClass, String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.mainClassName = mainClass;</span><br><span class="line">        <span class="comment">// 如果args不为空克隆一份</span></span><br><span class="line">		<span class="keyword">this</span>.args = (args != <span class="keyword">null</span>) ? args.clone() : <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 获取线程上下文类加载器（LauncherURLClassLoader）,通过LauncherURLClassLoader类加载器</span></span><br><span class="line">    <span class="comment">// 加载this.mainClassName实际上就是Start-Class: com.shengsiyuan.boot.MyApplication</span></span><br><span class="line">    <span class="comment">// 加载到虚拟机当中，形成mainClass对象</span></span><br><span class="line">		Class&lt;?&gt; mainClass = Thread.currentThread().getContextClassLoader().loadClass(<span class="keyword">this</span>.mainClassName);</span><br><span class="line">		<span class="comment">// 反射，通过包含了main方法的那个class对象的this.getDeclaredMethod()方法，获取到方法名，和方		// 法参数就能定位到main方法，通过mainMethod调用目标方法</span></span><br><span class="line">        Method mainMethod = mainClass.getDeclaredMethod(<span class="string">"main"</span>, String[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 第一个参数：被调用那个方法所在的对象，这里传null的原因在于main方法是一个静态方法，原则上静态方		  // 法是不归属于当前这个类的，只是把当前这个类作为寄存的一个场所而已</span></span><br><span class="line">        <span class="comment">// 第二个参数：被调用方法接收的参数</span></span><br><span class="line">        <span class="comment">// 当这个main方法真正执行完毕后，真正的就开始启动并且执行</span></span><br><span class="line">        <span class="comment">// 为什么这里会传入null？静态方法本身是不属于这个类的，而是属于这个类所对应的class对象，因此可以传		   // 入null</span></span><br><span class="line">        mainMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; <span class="keyword">this</span>.args &#125;);   </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：为什么SpringBoot要求提供main方法？原因在于SpringBoot应用除了要以jar包的形式java -jar的形式运行之外，也可以在右键运行，如果这个方法是一个main方法的话，显然就可以一个java的形式运行当前这个程序，如果这个方法是一个test方法，是不能运行的，这样就没法在程序或ide中右键用run的方式运行程序入口，SpringBoot之所以要求应用的入口放置一个main方法当中，是基于（既可以以ide运行的方式，也可以通过打jar包的形式运行，两种方式既然不同）。</p>
<h2 id="JDWP远程调试详解"><a href="#JDWP远程调试详解" class="headerlink" title="JDWP远程调试详解"></a>JDWP远程调试详解</h2><h3 id="1、相同的程序，不同的类加载器"><a href="#1、相同的程序，不同的类加载器" class="headerlink" title="1、相同的程序，不同的类加载器"></a>1、相同的程序，不同的类加载器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shengsiyuan.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 输出当前加载MyApplication类的类加载器</span></span><br><span class="line">        <span class="comment">// 问题1：当以命令行的形式或者以控制台的方式运行程序，这行代码输出的内容是什么？</span></span><br><span class="line">        <span class="comment">// 问题2：当把这个程序打成一个jar包，然后用java -jar的形式运行所打的这个jar包</span></span><br><span class="line">        <span class="comment">// 来启动这个应用，这行代码又会输出什么？两次结果是否是一样的？</span></span><br><span class="line">        <span class="comment">// 本质上都是运行这个程序</span></span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们使用以命令行的形式或者以控制台的方式运行程序，使用的是应用类加载器加载当前类的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun.misc.Launcher$AppClassLoader<span class="meta">@b</span>4aac2</span><br></pre></td></tr></table></figure>

<p>当我们以java -jar的形式运行当前程序，使用的类加载器是Spring所提供的LaunchedURLClassLoader类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">D:\Codings\springboot_lecture&gt;gradle bootJar</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in <span class="number">6</span>s</span><br><span class="line"><span class="number">3</span> actionable tasks: <span class="number">1</span> executed, <span class="number">2</span> up-to-date</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;java -jar springboot_lecture-1.0.jar</span><br><span class="line">org.springframework.boot.loader.LaunchedURLClassLoader@197848c</span><br></pre></td></tr></table></figure>

<p>相同的程序运行的形态不一样，输出的类加载器也不一样。</p>
<h3 id="2、JDWP"><a href="#2、JDWP" class="headerlink" title="2、JDWP"></a>2、JDWP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JDWP 是 Java Debug Wire Protocol 的缩写，Java调试协议，它定义了调试器（debugger）和被调试的 Java 虚拟机（target vm）之间的通信协议。</span><br><span class="line"></span><br><span class="line">详情参见：https:<span class="comment">//www.ibm.com/developerworks/cn/java/j-lo-jpda3/index.html</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">   -agentlib:&lt;libname&gt;[=&lt;选项&gt;]</span><br><span class="line">             加载本机代理库 &lt;libname&gt;, 例如 -agentlib:hprof</span><br><span class="line">             另请参阅 -agentlib:jdwp=help 和 -agentlib:hprof=help</span><br><span class="line">   C:\Users\Administrator&gt;java -agentlib:jdwp=help</span><br><span class="line">                  Java Debugger JDWP Agent Library</span><br><span class="line">                  --------------------------------</span><br><span class="line"></span><br><span class="line">     (see http:<span class="comment">//java.sun.com/products/jpda for more information)</span></span><br><span class="line"></span><br><span class="line">   jdwp usage: java -agentlib:jdwp=[help]|[&lt;option&gt;=&lt;value&gt;, ...]</span><br><span class="line"></span><br><span class="line">   Option Name and Value            Description                       Default</span><br><span class="line">   ---------------------            -----------                       -------</span><br><span class="line">   suspend=y|n                      wait on startup?                  y</span><br><span class="line">   transport=&lt;name&gt;                 transport spec                    none</span><br><span class="line">   address=&lt;listen/attach address&gt;  transport spec                    <span class="string">""</span></span><br><span class="line">   server=y|n                       listen <span class="keyword">for</span> debugger?              n</span><br><span class="line">   launch=&lt;command line&gt;            run debugger on event             none</span><br><span class="line">   onthrow=&lt;exception name&gt;         debug on <span class="keyword">throw</span>                    none</span><br><span class="line">   onuncaught=y|n                   debug on any uncaught?            n</span><br><span class="line">   timeout=&lt;timeout value&gt;          <span class="keyword">for</span> listen/attach in milliseconds n</span><br><span class="line">   mutf8=y|n                        output modified utf-<span class="number">8</span>             n</span><br><span class="line">   quiet=y|n </span><br><span class="line">      </span><br><span class="line">   Examples</span><br><span class="line">--------</span><br><span class="line"> - Using sockets connect to a debugger at a specific address:</span><br><span class="line">   java -agentlib:jdwp=transport=dt_socket,address=localhost:<span class="number">8080</span></span><br><span class="line"> - Using sockets listen <span class="keyword">for</span> a debugger to attach:</span><br><span class="line">   java -agentlib:jdwp=transport=dt_socket,server=y,suspend=y</span><br><span class="line">      </span><br><span class="line">   具体说明：</span><br><span class="line">   suspend=y|n暂停挂起                wait on startup是否启动的时候等待）  是</span><br><span class="line">   transport=&lt;name&gt;                 transport spec传输规范             none</span><br><span class="line">   address=&lt;listen/attach address&gt;  transport spec传输规范             <span class="string">""</span></span><br><span class="line">   server=y|n                       listen <span class="keyword">for</span> debugger是否监听调试器    否</span><br></pre></td></tr></table></figure>

<p>JDWP最佳实践</p>
<p>找到spring-boot-loader-2.1.3.RELEASE.jar中的JarLauncher.java，在main方法上加上断点</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C6.JPG" alt=""></p>
<p>命令行中输入以下命令，效果如下图</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">Desktop</span>&gt;<span class="title">java</span> -<span class="title">agentlib:jdwp</span>=<span class="title">transport</span>=<span class="title">dt_socket</span>,<span class="title">server</span>=<span class="title">y</span>,<span class="title">suspend</span>=<span class="title">y</span>,<span class="title">address</span>=50</span></span><br><span class="line"><span class="function">50 -<span class="title">jar</span> <span class="title">springboot_lecture</span>-1.0.<span class="title">jar</span></span></span><br><span class="line"><span class="function"><span class="title">Listening</span> <span class="title">for</span> <span class="title">transport</span> <span class="title">dt_socket</span> <span class="title">at</span> <span class="title">address</span>: 5050</span></span><br></pre></td></tr></table></figure>

<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C7.JPG" alt=""></p>
<p>IDEA中配置，操作步骤如下：</p>
<p>Edit Configuration-&gt;点击左上角+号-&gt;选择Rmote</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C8.JPG" alt=""></p>
<p>点击OK，回到IDEA，选择MyDebug，点击右边Debug按钮</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C9.JPG" alt=""></p>
<p>此时，我们就可以在IDEA以传统的方式进行代码调试</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C10.JPG" alt=""></p>
<p>命令中此时正在监听</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C11.JPG" alt=""></p>
<h2 id="调试spring-boot-loader的启动与加载全流程"><a href="#调试spring-boot-loader的启动与加载全流程" class="headerlink" title="调试spring-boot-loader的启动与加载全流程"></a>调试spring-boot-loader的启动与加载全流程</h2><h2 id="SpringBootApplication注解深度解析"><a href="#SpringBootApplication注解深度解析" class="headerlink" title="@SpringBootApplication注解深度解析"></a>@SpringBootApplication注解深度解析</h2><p>Spring Boot启动流程（Spring Boot底层源码分析） </p>
<p>MyApplication.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/api"</span>, produces = MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyConfigBean myConfigBean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;myConfig.myObject.myName&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String myName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;myConfig.myObject.myAge&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> myAge;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/person"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">getPerson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setId(<span class="number">1</span>);</span><br><span class="line">        person.setName(<span class="string">"张三"</span>);</span><br><span class="line">        person.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">this</span>.myName);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.myAge);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"---"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(myConfigBean.getMyName());</span><br><span class="line">        System.out.println(myConfigBean.getMyAge());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>右键运行这段代码，这是每个初学Spring Boot的人都会去做的一件事情，但是有没有想过，当我们去启动main方法的时候，这个应用就算已经正常的启动了，用户可以通过浏览器去输入我们在Controller里面所自定义的某一个Controller上面相关的url，相应的方法就会执行，控制器就已经发挥作用了，MyApplication是我们程序的入口类，MyApplication实际上与MyController之间从源码上并没有任何直接的关联关系，但是当我们在IDEA右键运行的时候，用户就可以通过事先所预置的url，就能成功的去访问Controller里面特定的执行方法，看起来是一个停神奇的事情，这也会给很多Spring Boot初学者带来一种错觉，会认为Spring Boot就是这么简单，我们使用起来把一些注解配置好，程序就可以正常的去启动。 如果按照这种方式理解没有任何问题，有没有更深层次的思考，它们是怎么就能关联起来？</p>
<p>如果把@SpringBootApplication注解注释掉呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.ApplicationContextException: Unable to start web server; nested exception is org.springframework.context.ApplicationContextException: Unable to start ServletWebServerApplicationContext due to missing ServletWebServerFactory bean.</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:<span class="number">156</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:<span class="number">544</span>) ~[spring-context-<span class="number">5.2</span><span class="number">.4</span>.RELEASE.jar:<span class="number">5.2</span><span class="number">.4</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:<span class="number">141</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:<span class="number">747</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:<span class="number">397</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:<span class="number">315</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:<span class="number">1226</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:<span class="number">1215</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at com.shengsiyuan.boot.MyApplication.main(MyApplication.java:<span class="number">45</span>) [main/:na]</span><br><span class="line">Caused by: org.springframework.context.ApplicationContextException: Unable to start ServletWebServerApplicationContext due to missing ServletWebServerFactory bean.</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.getWebServerFactory(ServletWebServerApplicationContext.java:<span class="number">203</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.createWebServer(ServletWebServerApplicationContext.java:<span class="number">179</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:<span class="number">153</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	... <span class="number">8</span> common frames omitted</span><br></pre></td></tr></table></figure>

<p>根本原因在于缺少ServletWebServerFactory bean对象，导致程序异常退出。</p>
<p>@SpringBootApplication注解对于整个Spring Boot或Spring Cloud的技术体系来说是特别的重要（整个Spring Boot或Spring Cloud一整套微服务技术栈，本质上就是围绕着一系列的注解来展开的，注解在整个微服务的框架当中，扮演着特别重要的作用）。</p>
<h3 id="1、Spring-Boot启动过程分析"><a href="#1、Spring-Boot启动过程分析" class="headerlink" title="1、Spring Boot启动过程分析"></a>1、Spring Boot启动过程分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>首先看这行代码，代码执行流程是，通过SpringApplication这个类的run方法（静态方法），第一个参数是传入当前main方法所在类的class对象，第二个参数是把main方法字符串数组这个参数传递进去，整个应用就已经启动了 ，在实际应用当中，这种场景非常多，但这种应用场景只是一种非常简便的，给开发人员提供一种默认的各种设置简便的启动方式，对于Spring Boot来说，里面的配置信息实际都可能通过两种方式去改变的。</p>
<p>第一种方式：通过配置文件的（yml、properties）的形式</p>
<p>第二种方式：通过程序编码的方式</p>
<p>两种方式各有各的优势，没有谁好谁不好的区分</p>
<p>注释掉SpringApplication.run(MyApplication.class, args);这行代码，可以按照分步的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shengsiyuan.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.Banner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    JDWP：Java Debug Wire Protocol，Java调试协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        <span class="comment">// SpringApplication.run(MyApplication.class, args);</span></span><br><span class="line">        SpringApplication springApplication = <span class="keyword">new</span> SpringApplication(MyApplication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        springApplication.setBannerMode(Banner.Mode.OFF);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> new SpringApplication()的一个对象，参数就是当前这个类的class对象，这样就生成一个SpringApplication的一个实例，这个实例一旦生成好以后，就可以在程序中以编码的形式改变或修改它默认的很多配置，当我们去调用set的时候，里面有很多各种各样的set方法，我们可以找到setBannerMode()方法，设置好Banner的一种模式，</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C12.png" alt=""></p>
<p>Banner.Mode源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * An enumeration of possible values for configuring the Banner.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">enum</span> Mode &#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Disable printing of the banner.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		OFF,</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Print the banner to System.out.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		CONSOLE,</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Print the banner to the log file.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		LOG</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>Banner.Mode是一个枚举，有三个可选的对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OFF：不打印banner</span><br><span class="line"></span><br><span class="line">CONSOLE：将banner打印至标准输出控制台（这是系统默认的）</span><br><span class="line"></span><br><span class="line">LOG：打印至日志文件中</span><br></pre></td></tr></table></figure>

<p>选择OFF即不打印Banner的信息，当设置好Banner的信息后就可启动springApplication，调用springApplication的run方法。</p>
<p>springApplication.run(args)中的run方法不是一个静态方法，而是一个实例方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Run the Spring application, creating and refreshing a new</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> ApplicationContext&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the application arguments (usually passed from a Java main method)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a running &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">		StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">		stopWatch.start();</span><br><span class="line">		ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">		Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		configureHeadlessProperty();</span><br><span class="line">		SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">		listeners.starting();</span><br><span class="line">		...中间省略</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>SpringApplication.run(MyApplication.class, args)中的run方法是一个静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Static helper that can be used to run a &#123;<span class="doctag">@link</span> SpringApplication&#125; from the</span></span><br><span class="line"><span class="comment">	 * specified source using default settings.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> primarySource the primary source to load</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the application arguments (usually passed from a Java main method)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the running &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class&lt;?&gt; primarySource, String... args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> run(<span class="keyword">new</span> Class&lt;?&gt;[] &#123; primarySource &#125;, args);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>注意：SpringApplication.run(MyApplication.class, args);中的run方法与springApplication.run(args);中的run方法不是同一个run方法，本质上完成的功能是一样的。 </p>
<p>此时代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        <span class="comment">// SpringApplication.run(MyApplication.class, args);</span></span><br><span class="line">        SpringApplication springApplication = <span class="keyword">new</span> SpringApplication(MyApplication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        springApplication.setBannerMode(Banner.Mode.OFF);</span><br><span class="line">        springApplication.run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>右键运行示例代码，输出日志信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; Task :compileJava UP-TO-DATE</span><br><span class="line">&gt; Task :processResources UP-TO-DATE</span><br><span class="line">&gt; Task :classes UP-TO-DATE</span><br><span class="line"></span><br><span class="line">&gt; Task :MyApplication.main()</span><br><span class="line">sun.misc.Launcher$AppClassLoader@<span class="number">1</span>d16e93</span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">23</span>:<span class="number">05</span>:<span class="number">24.710</span>  INFO <span class="number">12348</span> --- [           main] com.shengsiyuan.boot.MyApplication       : Starting MyApplication on GKF4FAXCIZLZ3HL with PID <span class="number">12348</span> (D:\Codings\springboot_lecture\build\classes\java\main started by Administrator in D:\Codings\springboot_lecture)</span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">23</span>:<span class="number">05</span>:<span class="number">24.717</span>  INFO <span class="number">12348</span> --- [           main] com.shengsiyuan.boot.MyApplication       : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">23</span>:<span class="number">05</span>:<span class="number">26.662</span>  INFO <span class="number">12348</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 9090 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.680  INFO 12348 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.681  INFO 12348 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.31]</span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.924  INFO 12348 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.925  INFO 12348 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 2124 ms</span></span><br><span class="line"><span class="function">2020-03-17 23:05:27.209  INFO 12348 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2020-03-17 23:05:27.640  INFO 12348 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 9090 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2020-03-17 23:05:27.644  INFO 12348 --- [           main] com.shengsiyuan.boot.MyApplication       : Started MyApplication in 3.982 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">4.6</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>此时并没有打印出banner的信息，说明配置已经是生效的。</p>
<h3 id="2、-SpringBootApplication深入解析"><a href="#2、-SpringBootApplication深入解析" class="headerlink" title="2、@SpringBootApplication深入解析"></a>2、@SpringBootApplication深入解析</h3><p>标识着一个配置类声明了一个或多个@Bean方法并且还会触发自动配置和组件扫描两个功能，这是一个很便捷的注解，它等价于或相当于同时声明了@Configuration，@EnableAutoConfiguration，@ComponentScan。</p>
<h3 id="3、-SpringBootConfiguration深入解析"><a href="#3、-SpringBootConfiguration深入解析" class="headerlink" title="3、@SpringBootConfiguration深入解析"></a>3、@SpringBootConfiguration深入解析</h3><p>标识着一个类提供了Spring Boot应用的@Configuration(表示当前类是一个配置类)，可以用作一个替代方案，<br>对于Spring标准的@Configuration注解，这样的话配置就能自动的探寻到或被发现。<br>应用应该只包含一个@SpringBootConfiguration，大多数的一些惯常的Spring Boot应用都会从@SpringBootConfiguration中继承过来。</p>
<h3 id="4、-Configuration深入解析"><a href="#4、-Configuration深入解析" class="headerlink" title="4、@Configuration深入解析"></a>4、@Configuration深入解析</h3><p>用于标识一个类声明了一个或多个@Bean方法，并且可以被Spring容器进行处理生成bean的定义以及服务的请求<br>针对于一些在运行期的时候的bean，示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"> 	<span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// instantiate, configure and return bean ... 实例化，配置与返回这个bean</span></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="启动-Configuration类"><a href="#启动-Configuration类" class="headerlink" title="启动@Configuration类"></a>启动@Configuration类</h5><h6 id="通过AnnotationConfigApplicationContext方式"><a href="#通过AnnotationConfigApplicationContext方式" class="headerlink" title="通过AnnotationConfigApplicationContext方式"></a>通过AnnotationConfigApplicationContext方式</h6><p> @Configuration类通常是通过AnnotationConfigApplicationContext或者它web相关变种<br> AnnotationConfigWebApplicationContext启动的，对于前者一种简单的示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">   ctx.register(AppConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">   ctx.refresh();</span><br><span class="line">   MyBean myBean = ctx.getBean(MyBean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">   <span class="comment">// use myBean ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 非常经典示例，首先创建一个AnnotationConfigApplicationContext的对象，然后将AppConfig配置类注册</span></span><br><span class="line"><span class="comment">// 到AnnotationConfigApplicationContext应用上下文上，注册完以后刷新，就可以从上下文当中把里面特定的</span></span><br><span class="line"><span class="comment">// 方法的bean信息获取到，最后就可以使用bean。</span></span><br></pre></td></tr></table></figure>

<h6 id="通过Spring-60-bean-62-XML方式"><a href="#通过Spring-60-bean-62-XML方式" class="headerlink" title="通过Spring&#60;bean&#62;XML方式"></a>通过Spring&#60;bean&#62;XML方式</h6><p>作为直接针对注解configapplicationcontext注册@Configuration类的替代方案，@Configuration类可以在Spring XML文件中声明为普通的<bean>定义:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.acme.AppConfig"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在上面的示例当中，&#60;context:annotation-config/&#62;是必需的，为了方便启用ConfigurationClassPostProcessor和其他与注解相关的后置处理器，它们可以使得@Configuration类的处理成为可能。</p>
<h6 id="通过组件扫描方式"><a href="#通过组件扫描方式" class="headerlink" title="通过组件扫描方式"></a>通过组件扫描方式</h6><p>@Configuration使用@Component进行元注解，因此@Configuration类是可以进行组件扫描的(通常使用Spring XML的&#60;context:component-scan/&#62;的元素)，并且因此也可以充分利用@Autowired/@Inject像任何常规的@Component一样。特别是，如存在单个的构方法，自动装配语义会透明地应用于该构造函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> SomeBean someBean;</span><br><span class="line"> </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">AppConfig</span><span class="params">(SomeBean someBean)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.someBean = someBean;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// @Bean definition using "SomeBean"</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>@Configuration类不仅可以使用组件扫描的方式来启动，而且本身还可以使用@ComponentScan注解来配置组件扫描:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.acme.app.services"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">// various @Bean definitions ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有关详细信息，请参见@ComponentScan javadocs。</p>
<h5 id="与外部的值搭配使用"><a href="#与外部的值搭配使用" class="headerlink" title="与外部的值搭配使用"></a>与外部的值搭配使用</h5><h6 id="使用环境API"><a href="#使用环境API" class="headerlink" title="使用环境API"></a>使用环境API</h6><p>外部的值是可以通过注入 spring的org.springframework.core.env.Environment注入到 @Configuration类里面使用，例如，使用@Autowired注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">      <span class="meta">@Autowired</span> Environment env;</span><br><span class="line"> </span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          MyBean myBean = <span class="keyword">new</span> MyBean();</span><br><span class="line">          myBean.setName(env.getProperty(<span class="string">"bean.name"</span>));</span><br><span class="line">          <span class="keyword">return</span> myBean;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>通过Environment解析的属性位于一个或多个“property source”对象中，而且@Configuration类还可以贡献属性源到环境对象中，使用@PropertySource注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@PropertySource</span>(<span class="string">"classpath:/com/acme/app.properties"</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Inject</span> Environment env;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> MyBean(env.getProperty(<span class="string">"bean.name"</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>有关更多细节，请参见环境和@PropertySource javadocs。</p>
<h6 id="使用-Value注解"><a href="#使用-Value注解" class="headerlink" title="使用@Value注解"></a>使用@Value注解</h6><p>外部值可以使用@Value注解注入到@Configuration类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:/com/acme/app.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;bean.name&#125;"</span>) String beanName;</span><br><span class="line">  </span><br><span class="line">     <span class="meta">@Bean</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     	<span class="keyword">return</span> <span class="keyword">new</span> MyBean(beanName);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式通常与Spring的PropertySourcesPlaceholderConfigurer搭配一起使用,可以自动启用XML配置通过&lt;context:property-placeholder / &gt;或@Configuration类中显式地通过一个专门的静态@Bean方法(见“关于beanfactorypostprocessor-returning@Bean方法的说明)。但是请注意，只有在需要自定义配置(如占位符语法等)时，才需要通过静态@Bean方法显式注册PropertySourcesPlaceholderConfigurer。具体地说，如果没有bean后处理器(例如PropertySourcesPlaceholderConfigurer)为ApplicationContext注册了嵌入式值解析器，Spring将注册一个默认的嵌入式值解析器，它将对环境中注册的属性源解析占位符。请参阅下面关于使用@ImportResource用Spring XML组合@Configuration类的部分;参见@Value javadocs;有关使用诸如PropertySourcesPlaceholderConfigurer之类的BeanFactoryPostProcessor类型的详细信息，请参阅@Bean javadocs。</p>
<h5 id="组合-Configuration类"><a href="#组合-Configuration类" class="headerlink" title="组合@Configuration类"></a>组合@Configuration类</h5><h6 id="使用-Import注解"><a href="#使用-Import注解" class="headerlink" title="使用@Import注解"></a>使用@Import注解</h6><p>@Configuration类是可以使用@Import注解进行组合，类似于Spring XML文件中的<import>标签。由于@Configuration对象是在容器中作为Spring bean来管理的，因此被导入的配置一定可以被注入——例如，通过构造器注入:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// instantiate, configure and return DataSource</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(DatabaseConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseConfig dataConfig;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppConfig</span><span class="params">(DatabaseConfig dataConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dataConfig = dataConfig;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// reference the dataSource() bean method</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean(dataConfig.dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在AppConfig和被导入的DatabaseConfig都可以通过在Spring上下文中注册AppConfig来启动:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> AnnotationConfigApplicationContext(AppConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<h6 id="使用-Profile注解"><a href="#使用-Profile注解" class="headerlink" title="使用@Profile注解"></a>使用@Profile注解</h6><p>@Configuration类可以被@Profile注解所标记，用来表示它们被处理当一个给定profile或多个profiles被激活的时候才处理它们:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"development"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedDatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// instantiate, configure and return embedded DataSource</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"production"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductionDatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// instantiate, configure and return production DataSource</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者，您也可以在@Bean方法级别声明配置文件条件——例如，对于同一个配置类中的可选bean变体:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</span><br><span class="line">       <span class="meta">@Profile</span>(<span class="string">"development"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">public</span> DataSource <span class="title">embeddedDatabase</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</span><br><span class="line">       <span class="meta">@Profile</span>(<span class="string">"production"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">public</span> DataSource <span class="title">productionDatabase</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>参见@Profile和org.springframework.core.env。环境javadocs以获得更多细节。</p>
<h6 id="使用Spring-XML中-ImportResource注解"><a href="#使用Spring-XML中-ImportResource注解" class="headerlink" title="使用Spring XML中@ImportResource注解"></a>使用Spring XML中@ImportResource注解</h6><p>如上所述，@Configuration类可以被声明作为Spring XML文件中的常规Spring <bean>定义。还可以使用@ImportResource注解将Spring XML配置文件导入@Configuration类。可以注入从XML导入的Bean定义——例如，使用@Inject注释:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@ImportResource</span>(<span class="string">"classpath:/com/acme/database-config.xml"</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Inject</span> DataSource dataSource; <span class="comment">// from XML</span></span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="comment">// inject the XML-defined dataSource bean</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> MyBean(<span class="keyword">this</span>.dataSource);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h6 id="使用嵌套的-Configuration类"><a href="#使用嵌套的-Configuration类" class="headerlink" title="使用嵌套的@Configuration类"></a>使用嵌套的@Configuration类</h6><p>@Configuration类可以相互嵌套，如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Inject</span> DataSource dataSource;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseConfig</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function">DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedDatabaseBuilder().build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当启动这种情况的时候，只有AppConfig需要注册到应用上下文中。对于一个嵌套的@Configuration类来说，DatabaseConfig将会被自动的注册。这样就避免了使用@Import注解的需要，当这种AppConfig与DatabaseConfig之间的关系已经是比较隐式很清晰的。</p>
<p>还请注意，嵌套的@Configuration类可以用于很好的影响@Profile注解去提供相同的bean的两种选择，对于外层的@Configuration来说。</p>
<h5 id="延迟初始化配置"><a href="#延迟初始化配置" class="headerlink" title="延迟初始化配置"></a>延迟初始化配置</h5>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/" data-id="ck7xfhuyn0006o4vlc8bs03f5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/hello-world/" class="article-date">
  <time datetime="2020-03-18T10:43:28.489Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/hello-world/" data-id="ck7xfhuwj0000o4vl51q39i8s" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Windows下Cmder的配置与使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/Windows%E4%B8%8BCmder%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2020-03-18T10:09:09.910Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/Windows%E4%B8%8BCmder%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/">Windows下Cmder的配置与使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Windows下Cmder的安装与使用"><a href="#Windows下Cmder的安装与使用" class="headerlink" title="Windows下Cmder的安装与使用"></a>Windows下Cmder的安装与使用</h1><p>cmder是一款windows下的控制台编辑软件，较之cmd其提供了更为友善的用户界面。例如：提供了更为方便的复制、粘贴方式；可分屏多开窗口，并且用ctrl+n即可在几个窗口间切换；可在任意文件夹中右键打开；可以设置窗口颜色,字体大小等很多功能。</p>
<h2 id="1-下载"><a href="#1-下载" class="headerlink" title="1.下载"></a>1.下载</h2><p>cmder软件可在官网 <a href="https://cmder.net/" target="_blank" rel="noopener">https://cmder.net/</a> 下载，有mini版和完整版，建议完整版，完整版功能更齐全，下载好解压文件包以后就可以使用。</p>
<h2 id="2-添加环境变量"><a href="#2-添加环境变量" class="headerlink" title="2.添加环境变量"></a>2.添加环境变量</h2><p>添加到系统环境变量是为了能在任意文件夹中右键打开，添加环境变量的方法如下：<br>右键计算机-&gt;属性-&gt;高级系统设置-&gt;高级-&gt;环境变量-&gt;系统变量。如下图所示：选中Path，并点击编辑，加入包含Cmder.exe的路径，笔者这里是D:\soft\cmde，因此在Path最后加入;D:\soft\cmder(这里注意在路径前应加入“;”，以与前面路径隔开)</p>
<h2 id="3-添加Cmder到右键菜单"><a href="#3-添加Cmder到右键菜单" class="headerlink" title="3.添加Cmder到右键菜单"></a>3.添加Cmder到右键菜单</h2><p>添加环境变量后打开cmd或cmder，输入如下命令:</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cmder.exe /REGISTER ALL</span><br></pre></td></tr></table></figure>

<p>命令执行完后就能通过右键打开cmder啦。</p>
<h2 id="4-Cmder的常用快捷方式"><a href="#4-Cmder的常用快捷方式" class="headerlink" title="4.Cmder的常用快捷方式"></a>4.Cmder的常用快捷方式</h2><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Tab         自动路径补全</span><br><span class="line">Ctrl+T      建立新页签</span><br><span class="line">Ctrl+W      关闭页签</span><br><span class="line">Ctrl+Tab    切换页签</span><br><span class="line">Alt+F4      关闭所有页签</span><br><span class="line">Alt+<span class="built_in">Shift</span>+<span class="number">1</span> 开启<span class="built_in">cmd</span>.exe</span><br><span class="line">Alt+<span class="built_in">Shift</span>+<span class="number">2</span> 开启powershell.exe</span><br><span class="line">Alt+<span class="built_in">Shift</span>+<span class="number">3</span> 开启powershell.exe (系统管理员权限)</span><br><span class="line">Ctrl+<span class="number">1</span>      快速切换到第<span class="number">1</span>个页签</span><br><span class="line">Ctrl+n      快速切换到第n个页签( n值无上限)</span><br><span class="line">Alt + enter 切换到全屏状态</span><br><span class="line">Ctr+r       历史命令搜索</span><br><span class="line">Tab         自动路径补全</span><br><span class="line">Ctrl+<span class="number">1</span>      快速切换到第<span class="number">1</span>个页签</span><br><span class="line">Ctrl+n      快速切换到第n个页签( n值无上限)</span><br><span class="line">Win+Alt+P   开启工具选项视窗</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/Windows%E4%B8%8BCmder%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/" data-id="ck7xfhux00001o4vlawodczjs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-jar文件规范" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/jar%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83/" class="article-date">
  <time datetime="2020-03-18T10:07:30.149Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/jar%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83/">jar文件规范</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="jar文件规范"><a href="#jar文件规范" class="headerlink" title="jar文件规范"></a>jar文件规范</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line">介绍</span><br><span class="line">JAR文件是一种基于流行的ZIP文件格式的文件格式，用于将许多文件聚合到一个文件中。JAR文件本质上是一个zip文件，其中包含一个可选的META-INF目录。可以通过命令行jar工具或通过使用 Java平台中的  java.util.jar API 来创建JAR文件。对JAR文件的名称没有限制，它可以是特定平台上的任何合法文件名。</span><br><span class="line">在许多情况下，JAR文件不仅仅是Java类文件和/或资源的简单存档。它们用作应用程序和扩展的构建块。META-INF目录（如果存在）用于存储程序包和扩展配置数据，包括安全性，版本控制，扩展和服务。</span><br><span class="line"></span><br><span class="line">META-INF目录</span><br><span class="line">Java <span class="number">2</span> Platform识别并解释了META-INF目录中的以下文件/目录，以配置应用程序，扩展，类加载器和服务：</span><br><span class="line">清单文件</span><br><span class="line">用于定义扩展名和打包相关数据的清单文件。</span><br><span class="line">索引清单</span><br><span class="line">该文件由jar工具的新“ -i”选项生成，其中包含应用程序或扩展中定义的包的位置信息。它是JarIndex实现的一部分，由类加载器用来加速其类加载过程。</span><br><span class="line">SF</span><br><span class="line">JAR文件的签名文件。“ x”代表基本文件名。</span><br><span class="line">xDSA</span><br><span class="line">与具有相同基本文件名的签名文件关联的签名块文件。该文件存储相应签名文件的数字签名。</span><br><span class="line">服务/</span><br><span class="line">该目录存储所有服务提供商的配置文件。</span><br><span class="line">名称-值对和节</span><br><span class="line">在转到各个配置文件的内容的详细信息之前，需要定义一些格式约定。在大多数情况下，清单文件和签名文件中包含的信息表示为受RFC822标准启发的所谓“名称：值”对。我们也将这些对称为标头或属性。</span><br><span class="line">名称/值对的组称为“节”。各节用空行与其他节分开。</span><br><span class="line"></span><br><span class="line">任何形式的二进制数据都表示为base64。对于导致行长度超过<span class="number">72</span>个字节的二进制数据，需要连续进行。二进制数据的示例是摘要和签名。</span><br><span class="line"></span><br><span class="line">实现应支持最大<span class="number">65535</span>字节的报头值。</span><br><span class="line"></span><br><span class="line">本文档中的所有规范都使用相同的语法，其中终端符号以固定宽度的字体显示，非终端符号以斜体显示。</span><br><span class="line"></span><br><span class="line">规格：</span><br><span class="line">  部分：* header + newline</span><br><span class="line">  nonempty部分：+ header + newline</span><br><span class="line">  newline：                      CR LF | 低频| CR（不跟 LF）</span><br><span class="line">  标题：名称 ： 值</span><br><span class="line">  名称：alphanum * headerchar</span><br><span class="line">  值：                          SPACE * otherchar 换行符*连续</span><br><span class="line">  延续：               SPACE * otherchar换行符</span><br><span class="line">  alphanum：&#123; AZ &#125; | &#123; az &#125; | &#123; <span class="number">0</span>-<span class="number">9</span> &#125;</span><br><span class="line">  headerchar：字母数字 | - |_</span><br><span class="line">  otherchar：除 NUL，CR 和 LF 外的任何UTF-<span class="number">8</span>字符</span><br><span class="line">; 另外：为了防止通过直电子邮件，不发送的文件的重整</span><br><span class="line">; 标头将以四个字母“ From”开头。</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">在以上规范中定义的非终端符号将在以下规范中引用。</span><br><span class="line"></span><br><span class="line">JAR清单</span><br><span class="line">总览</span><br><span class="line">一个JAR文件清单包含一个主要部分，后面是各个JAR文件条目的部分列表，每个部分之间都用换行符分隔。主要部分和各个部分都遵循上面指定的部分语法。他们每个人都有自己的特定限制和规则。</span><br><span class="line">主要部分包含有关JAR文件本身以及该JAR文件所属的应用程序或扩展名的安全和配置信息。它还定义了适用于每个单独清单清单的主要属性。此部分中的任何属性名称都不能等于“ Name ”。此部分以空行终止。</span><br><span class="line"></span><br><span class="line">各个部分定义了此JAR文件中包含的程序包或文件的各种属性。并非JAR文件中的所有文件都需要在清单中作为条目列出，但是必须列出所有要签名的文件。清单文件本身不能列出。每个部分都必须以名称为“ Name ” 的属性开头，并且该值必须是文件的相对路径，或者是引用存档外部数据的绝对URL。</span><br><span class="line"></span><br><span class="line">如果同一文件条目有多个单独的节，则这些节中的属性将合并。如果某个属性在不同部分中具有不同的值，则将识别最后一个。</span><br><span class="line"></span><br><span class="line">无法理解的属性将被忽略。这样的属性可以包括应用程序使用的实现特定的信息。</span><br><span class="line"></span><br><span class="line">清单规格：</span><br><span class="line">  清单文件：main-section换行符* individual-section</span><br><span class="line">  main-section：版本信息换行符* main-attribute</span><br><span class="line">  版本信息：                      Manifest-Version： 版本号</span><br><span class="line">  version-number：digit + &#123; 。digit +&#125; *</span><br><span class="line">  main-attribute ：（任何合法的main属性）换行</span><br><span class="line">  单节：             名称： 值 newline * perentry-attribute</span><br><span class="line">  perentry-attribute ：（任何合法的perentry属性）newline</span><br><span class="line">  newline：                             CR LF | 低频| CR（不跟 LF）</span><br><span class="line">   数字：                                &#123;<span class="number">0</span>-<span class="number">9</span>&#125; </span><br><span class="line">在以上说明书中，可以出现在主要部分中的属性被称为主要属性，而可以出现在各个部分中的属性被称为按条目属性。某些属性可以同时出现在主要部分和各个部分中，在这种情况下，每个条目的属性值将覆盖指定条目的主要属性值。两种属性定义如下。</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">主要属性</span><br><span class="line">主要属性是清单的主要部分中存在的属性。它们分为以下不同的组：</span><br><span class="line">一般主要属性</span><br><span class="line">Manifest-Version：定义清单文件的版本。该值是合法的版本号，如以上规范中所述。</span><br><span class="line">Created-By：创建清单文件的基础，定义Java实现的版本和供应商。此属性由jar工具生成。</span><br><span class="line">签名版本：定义jar文件的签名版本。该值应该是有效的版本号 字符串。</span><br><span class="line">类路径：此属性的值指定此应用程序或扩展程序所需的扩展程序或库的相对URL。网址由一个或多个空格分隔。应用程序或扩展类加载器使用此属性的值来构造其内部搜索路径。有关详细信息，请参见 类路径属性部分。</span><br><span class="line">为独立应用程序定义的属性：捆绑到可执行jar文件中的独立应用程序使用此属性，可以通过java运行时直接通过运行“ java -jar x.jar ” 来调用这些文件。</span><br><span class="line">Main-Class：此属性的值是启动程序将在启动时加载的主应用程序类的类名。该值不得在类 名后附加<span class="class">.<span class="keyword">class</span>扩展名。</span></span><br><span class="line"><span class="class">为<span class="title">applet</span>定义的属性： 不推荐使用：在以后的发行版中可能会删除这些属性以及实现该属性的机制。 一个<span class="title">applet</span>使用这些属性，这些<span class="title">applet</span>捆绑在<span class="title">JAR</span>文件中，以定义该<span class="title">applet</span>所依赖的扩展的要求，版本和位置信息。（请参阅扩展版本控制）。</span></span><br><span class="line"><span class="class">扩展列表：此属性指示小程序所需的扩展。此属性中列出的每个扩展都将具有一组附加属性，小程序可使用这些附加属性来指定其所需的扩展版本和供应商。</span></span><br><span class="line"><span class="class">&lt;<span class="title">extension</span>&gt; -<span class="title">Extension</span>-<span class="title">Name</span>：此属性是扩展名的唯一名称。<span class="title">Java</span>插件将在已安装扩展的清单中将此属性的值与<span class="title">Extension</span>-<span class="title">Name</span>属性进行比较，以确定是否已安装该扩展。</span></span><br><span class="line"><span class="class">&lt;<span class="title">extension</span>&gt; -<span class="title">Specification</span>-<span class="title">Version</span>：此属性指定小程序所需的最小扩展规范版本。<span class="title">Java</span>插件将将此属性的值与已安装扩展的<span class="title">Specification</span>-<span class="title">Version</span>属性进行比较，以确定扩展是否为最新。</span></span><br><span class="line"><span class="class">&lt;<span class="title">extension</span>&gt; -<span class="title">Implementation</span>-<span class="title">Version</span>：此属性指定小程序所需的最小扩展实现版本号。<span class="title">Java</span>插件将将此属性的值与已安装扩展的<span class="title">Implementation</span>-<span class="title">Version</span>属性进行比较，以查看是否需要下载更新的实现。</span></span><br><span class="line"><span class="class">&lt;<span class="title">extension</span>&gt; -<span class="title">Implementation</span>-<span class="title">Vendor</span>-<span class="title">Id</span>：如果<span class="title">applet</span>需要特定供应商的实施，则此属性可用于标识扩展实施的供应商。<span class="title">Java</span>插件将将此属性的值与已安装扩展的<span class="title">Implementation</span>-<span class="title">Vendor</span>-<span class="title">Id</span>属性进行比较。</span></span><br><span class="line"><span class="class">&lt;<span class="title">extension</span>&gt; -<span class="title">Implementation</span>-<span class="title">URL</span>：如果尚未安装所需的版本，则此属性指定可用于获取扩展的最新版本的<span class="title">URL</span>。</span></span><br><span class="line"><span class="class">为扩展标识定义的属性：扩展使用此属性来定义其唯一标识。</span></span><br><span class="line"><span class="class">扩展名：此属性指定<span class="title">Jar</span>文件中包含的扩展名。名称应该是唯一的标识符，例如包含扩展名的主程序包的名称。</span></span><br><span class="line"><span class="class">为扩展名和包版本控制   以及密封信息定义的属性：这些属性定义<span class="title">JAR</span>文件所属的扩展名功能。这些属性的值适用于<span class="title">JAR</span>文件中的所有软件包，但是可以通过按条目属性覆盖。</span></span><br><span class="line"><span class="class"><span class="title">Implementation</span>-<span class="title">Title</span>：该值是一个字符串，用于定义扩展实现的标题。</span></span><br><span class="line"><span class="class"><span class="title">Implementation</span>-<span class="title">Version</span>：该值是一个字符串，用于定义扩展实现的版本。</span></span><br><span class="line"><span class="class">实施供应商：该值是一个字符串，用于定义维护扩展实施的组织。</span></span><br><span class="line"><span class="class"><span class="title">Implementation</span>-<span class="title">Vendor</span>-<span class="title">Id</span>：不建议使用：在将来的版本中，可以忽略此属性。 该值是一个字符串<span class="title">ID</span>，用于唯一定义维护扩展实施的组织。</span></span><br><span class="line"><span class="class">实施<span class="title">URL</span>：不推荐使用：在将来的版本中，可以忽略此属性。 此属性定义可从中下载扩展实现的<span class="title">URL</span>。</span></span><br><span class="line"><span class="class">规范标题：该值是一个字符串，用于定义扩展规范的标题。</span></span><br><span class="line"><span class="class"><span class="title">Specification</span>-<span class="title">Version</span>：该值是一个字符串，用于定义扩展规范的版本。</span></span><br><span class="line"><span class="class">规范供应商：该值是一个字符串，用于定义维护扩展规范的组织。</span></span><br><span class="line"><span class="class">密封的：此属性定义此<span class="title">JAR</span>文件是否密封。该值可以是“ <span class="title">true</span>”或“ <span class="title">false</span>”，忽略大小写。如果将其设置为“ <span class="title">true</span>”，则<span class="title">JAR</span>文件中的所有程序包均默认为密封的，除非另行单独定义。</span></span><br><span class="line"><span class="class">逐项属性</span></span><br><span class="line"><span class="class">按条目属性仅适用于清单条目与之关联的单个<span class="title">JAR</span>文件条目。如果相同的属性也出现在主要部分中，则按条目属性的值将覆盖主要属性的值。例如，如果<span class="title">JAR</span>文件<span class="title">a</span>.<span class="title">jar</span>具有以下清单内容：</span></span><br><span class="line"><span class="class">清单版本：1.0</span></span><br><span class="line"><span class="class">创建者：1.2（<span class="title">Sun</span> <span class="title">Microsystems</span> <span class="title">Inc</span>.）</span></span><br><span class="line"><span class="class">密封：真实</span></span><br><span class="line"><span class="class">名称：<span class="title">foo</span> / <span class="title">bar</span> /</span></span><br><span class="line"><span class="class">密封：假</span></span><br><span class="line"><span class="class">这意味着所有在<span class="title">a</span>.<span class="title">jar</span>中存档的软件包都是密封的，除了<span class="title">foo</span>.<span class="title">bar</span>没有。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">按条目属性分为以下几类：</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">为文件内容定义的属性：</span></span><br><span class="line"><span class="class"><span class="title">Content</span>-<span class="title">Type</span>：此属性可用于为<span class="title">JAR</span>文件中的特定文件条目指定<span class="title">MIME</span>类型和数据子类型。该值应该是类型/子类型形式的字符串 。例如，“ <span class="title">image</span> / <span class="title">bmp</span>”是具有<span class="title">bmp</span>子类型的图像类型（表示位图）。这将指示文件条目为图像，数据存储为位图。<span class="title">RFC</span> 1521和1522讨论并定义<span class="title">MIME</span>类型定义。</span></span><br><span class="line"><span class="class">为软件包版本控制和密封信息定义的属性：这些属性与上面定义的主要属性相同，这组主要属性定义了扩展软件包版本控制和密封信息。当用作按条目的属性时，这些属性将覆盖主要属性，但仅适用于清单条目指定的单个文件。</span></span><br><span class="line"><span class="class">为<span class="title">bean</span>对象定义的属性：</span></span><br><span class="line"><span class="class"><span class="title">Java</span>-<span class="title">Bean</span>：定义特定的<span class="title">jar</span>文件条目是否为<span class="title">Java</span> <span class="title">Beans</span>对象。该值应为“ <span class="title">true</span>”或“ <span class="title">false</span>”，忽略大小写。</span></span><br><span class="line"><span class="class">为签名定义的属性：这些属性用于签名和验证。详情请点击这里。</span></span><br><span class="line"><span class="class"><span class="title">x</span>-<span class="title">Digest</span>-<span class="title">y</span>：此属性的名称指定用于计算相应<span class="title">jar</span>文件条目的摘要值的摘要算法的名称。此属性的值存储实际的摘要值。前缀“ <span class="title">x</span>”指定算法名称，可选后缀“ <span class="title">y</span>”表示摘要值应针对哪种语言进行验证。</span></span><br><span class="line"><span class="class">魔术：这是一个可选属性，应用程序可以使用该属性来指示验证者应如何计算清单条目中包含的摘要值。此属性的值是一组用逗号分隔的上下文特定的字符串。详细说明在这里。</span></span><br><span class="line"><span class="class">签名的<span class="title">JAR</span>文件</span></span><br><span class="line"><span class="class">总览</span></span><br><span class="line"><span class="class">可以使用命令行<span class="title">jarsigner</span>工具或直接通过<span class="title">java</span>.<span class="title">securityAPI</span> 对<span class="title">JAR</span>文件进行签名。<span class="title">META</span>-<span class="title">INF</span>如果<span class="title">JAR</span>文件由<span class="title">jarsigner</span>工具签名，则每个文件条目（包括目录中与签名无关的文件） 都将被签名。与签名相关的文件是：</span></span><br><span class="line"><span class="class"><span class="title">META</span>-<span class="title">INF</span>/<span class="title">MANIFEST</span>.<span class="title">MF</span></span></span><br><span class="line"><span class="class"><span class="title">META</span>-<span class="title">INF</span>/*.<span class="title">SF</span></span></span><br><span class="line"><span class="class"><span class="title">META</span>-<span class="title">INF</span>/*.<span class="title">DSA</span></span></span><br><span class="line"><span class="class"><span class="title">META</span>-<span class="title">INF</span>/*.<span class="title">RSA</span></span></span><br><span class="line"><span class="class"><span class="title">META</span>-<span class="title">INF</span>/<span class="title">SIG</span>-*</span></span><br><span class="line"><span class="class">请注意，如果此类文件位于<span class="title">META</span>-<span class="title">INF</span> 子目录中，则不会将其视为与签名相关。这些文件名的大小写不区分大小写，将保留并且也不会被签名。</span></span><br><span class="line"><span class="class">可以使用<span class="title">java</span>.<span class="title">securityAPI</span> 对<span class="title">JAR</span>文件的子集进行签名 。已签名的<span class="title">JAR</span>文件与原始<span class="title">JAR</span>文件完全相同，不同之处在于已更新其清单，并将两个其他文件添加到<span class="title">META</span>-<span class="title">INF</span> 目录中：签名文件和签名阻止文件。当不使用<span class="title">jarsigner</span>时，签名程序必须构造签名文件和签名块文件。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">对于在签名的<span class="title">JAR</span>文件中签名的每个文件条目，只要清单中不存在该清单条目，就会为其创建一个单独的清单条目。每个清单条目列出一个或多个摘要属性以及一个可选的<span class="title">Magic</span>属性。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">签名文件</span></span><br><span class="line"><span class="class">每个签名者都由带有扩展名的签名文件表示 .<span class="title">SF</span>。该文件的主要部分类似于清单文件。它包括一个主要部分，其中包括签名者提供的信息，但并不特定于任何特定的<span class="title">jar</span>文件条目。除了 <span class="title">Signature</span>-<span class="title">Version</span>和<span class="title">Created</span>-<span class="title">By</span> 属性（请参见<span class="title">Main</span> <span class="title">Attributes</span>），主要部分还可以包括以下安全属性：</span></span><br><span class="line"><span class="class"><span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>-<span class="title">Main</span>-<span class="title">Attributes</span>（其中<span class="title">x</span>是<span class="title">java</span>.<span class="title">security</span>.<span class="title">MessageDigest</span>算法的标准名称）：此属性的值是清单主要属性的摘要值。</span></span><br><span class="line"><span class="class"><span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>（其中<span class="title">x</span>是<span class="title">java</span>.<span class="title">security</span>.<span class="title">MessageDigest</span>算法的标准名称 ）：此属性的值是整个清单的摘要值。</span></span><br><span class="line"><span class="class">主要部分后面是各个条目的列表，这些条目的名称也必须出现在清单文件中。每个单独的条目必须至少包含清单文件中相应条目的摘要。</span></span><br><span class="line"><span class="class">计算中不使用清单文件中出现但签名文件中没有出现的路径或<span class="title">URL</span>。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">签名验证</span></span><br><span class="line"><span class="class">如果签名有效，则<span class="title">JAR</span>文件验证成功，并且自此以后，生成签名时<span class="title">JAR</span>文件中的文件均未更改。<span class="title">JAR</span>文件验证涉及以下步骤：</span></span><br><span class="line"><span class="class">首次解析清单时，请验证签名文件上的签名。为了提高效率，可以记住此验证。请注意，此验证仅验证签名指示本身，而不验证实际的存档文件。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">如果<span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>签名文件中存在属性，请对照整个清单计算的摘要来验证该值。如果<span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>签名文件中存在多个 属性，请验证其中至少有一个与计算的摘要值匹配。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">如果<span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>签名文件中不存在属性，或者在上一步中计算出的摘要值都不匹配，那么将执行优化程度较低的验证：</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">如果<span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>-<span class="title">Main</span>-<span class="title">Attributes</span>签名文件中存在条目，请根据清单文件中主要属性计算的摘要来验证该值。如果此计算失败，则<span class="title">JAR</span>文件验证失败。可以记住这一决定以提高效率。如果<span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>-<span class="title">Main</span>-<span class="title">Attributes</span>签名文件中不存在某个 条目，则该条目的不存在不会影响<span class="title">JAR</span>文件验证，并且不会验证清单的主要属性。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">根据清单文件中相应条目计算的摘要值，验证签名文件中每个源文件信息部分中的摘要值。如果任何摘要值不匹配，则<span class="title">JAR</span>文件验证将失败。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">存储在<span class="title">x</span>-<span class="title">Digest</span>-<span class="title">Manifest</span>属性中的清单文件的摘要值可能与当前清单文件的摘要值不相等的原因之一是，在签名后（因此使用<span class="title">jar</span>工具）将一个或多个文件添加到<span class="title">JAR</span>文件中（使用<span class="title">jar</span>工具）。签名文件）已生成。当使用<span class="title">jar</span>工具添加文件时，清单文件将被更改（新文件将添加到节中），但签名文件没有被更改。如果自那时以来生成签名时<span class="title">JAR</span>文件中的文件均未更改，则仍然认为验证成功，如果签名文件的非标头部分中的摘要值等于摘要值，就是这种情况清单文件中相应部分的内容。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">对于清单中的每个条目，根据在“名称：”属性中指定的相对数据路径或<span class="title">URL</span>引用的实际数据计算的摘要，验证清单文件中的摘要值。如果任何摘要值不匹配，则<span class="title">JAR</span>文件验证将失败。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">清单文件示例：</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">清单版本：1.0</span></span><br><span class="line"><span class="class">创建者：1.7.0（<span class="title">Sun</span> <span class="title">Microsystems</span> <span class="title">Inc</span>.）</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">名称：<span class="title">common</span> / <span class="title">class1</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class"><span class="title">SHA</span>-256-摘要：（<span class="title">SHA</span>-256摘要的<span class="title">base64</span>表示形式）</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">名称：<span class="title">common</span> / <span class="title">class2</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class"><span class="title">SHA1</span>-<span class="title">Digest</span>：（<span class="title">SHA1</span>摘要的<span class="title">base64</span>表示形式）</span></span><br><span class="line"><span class="class"><span class="title">SHA</span>-256-摘要：（<span class="title">SHA</span>-256摘要的<span class="title">base64</span>表示形式）</span></span><br><span class="line"><span class="class">相应的签名文件为：</span></span><br><span class="line"><span class="class">签名版本：1.0</span></span><br><span class="line"><span class="class"><span class="title">SHA</span>-256-<span class="title">Digest</span>-<span class="title">Manifest</span>：（<span class="title">SHA</span>-256摘要的<span class="title">base64</span>表示）</span></span><br><span class="line"><span class="class"><span class="title">SHA</span>-256-<span class="title">Digest</span>-<span class="title">Manifest</span>-<span class="title">Main</span>-<span class="title">Attributes</span>：（<span class="title">SHA</span>-256摘要的<span class="title">base64</span>表示形式）</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">名称：<span class="title">common</span> / <span class="title">class1</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class"><span class="title">SHA</span>-256-摘要：（<span class="title">SHA</span>-256摘要的<span class="title">base64</span>表示形式）</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">名称：<span class="title">common</span> / <span class="title">class2</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class"><span class="title">SHA</span>-256-摘要：（<span class="title">SHA</span>-256摘要的<span class="title">base64</span>表示形式）</span></span><br><span class="line"><span class="class">魔术属性</span></span><br><span class="line"><span class="class">验证给定清单条目上的签名的另一个要求是，验证者应了解该条目清单清单中的<span class="title">Magic</span> <span class="title">Key</span> <span class="title">Pair</span>值的值。</span></span><br><span class="line"><span class="class"><span class="title">Magic</span>属性是可选的，但如果要验证条目的签名，则解析器需要了解该条目的<span class="title">Magic</span>键的值。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">Magic</span>属性的一个或多个值是一组用逗号分隔的上下文特定的字符串。逗号前后的空格将被忽略。大小写被忽略。魔术属性的确切含义是特定于应用程序的。这些值指示如何计算清单条目中包含的哈希值，因此对于正确验证签名至关重要。关键字可以用于动态或嵌入式内容，用于多种语言文档的多个哈希等。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">这是清单文件中潜在使用<span class="title">Magic</span>属性的两个示例：</span></span><br><span class="line"><span class="class"></span></span><br><span class="line">        名称：http://www.example-scripts.com/index#script1</span><br><span class="line">        SHA-<span class="number">256</span>-摘要：（SHA-<span class="number">256</span>哈希的base64表示形式）</span><br><span class="line">        魔术：JavaScript，动态</span><br><span class="line"></span><br><span class="line">        名称：http:<span class="comment">//www.example-tourist.com/guide.html</span></span><br><span class="line">        SHA-<span class="number">256</span>-摘要：（SHA-<span class="number">256</span>哈希的base64表示形式）</span><br><span class="line">        SHA-<span class="number">256</span>-Digest-French：（SHA-<span class="number">256</span>哈希的base64表示形式）</span><br><span class="line">        SHA-<span class="number">256</span>-Digest-German：（SHA-<span class="number">256</span>哈希的base64表示形式）</span><br><span class="line">        魔术：多语种</span><br><span class="line">在第一个示例中，这些Magic值可以指示http查询的结果是嵌入在文档中的脚本（与文档本身相反），并且该脚本是动态生成的。这两条信息指示如何计算与清单的摘要值进行比较的哈希值，从而比较有效的签名。</span><br><span class="line"></span><br><span class="line">在第二个示例中，Magic值指示所检索的文档可能已针对特定语言进行了内容协商，并且要进行验证的摘要取决于所检索的文档所使用的语言。</span><br><span class="line"></span><br><span class="line">数字签名</span><br><span class="line">数字签名是.SF 签名文件的签名版本。这些是二进制文件，不应被人类解释。</span><br><span class="line">数字签名文件的文件名与.SF文件相同，但扩展名不同。扩展名取决于数字签名的类型。</span><br><span class="line"></span><br><span class="line">.RSA （PKCS7签名，SHA-<span class="number">256</span> + RSA）</span><br><span class="line">.DSA （PKCS7签名，DSA）</span><br><span class="line">上面未列出的用于签名算法的数字签名文件必须位于META-INF目录中，并且前缀为“ SIG-”。相应的签名文件（.SFfile）也必须具有相同的前缀。</span><br><span class="line">对于那些不支持外部签名数据的格式，文件应包含文件的签名副本.SF。因此，某些数据可能会重复，验证者应该比较这两个文件。</span><br><span class="line"></span><br><span class="line">支持外部数据的格式要么引用 .SF文件，要么使用隐式引用对其执行计算。</span><br><span class="line"></span><br><span class="line">每个.SF文件可能具有多个数字签名，但这些签名应由同一法人实体生成。</span><br><span class="line"></span><br><span class="line">文件扩展名可以是<span class="number">1</span>到<span class="number">3</span> 个字母数字字符。无法识别的扩展名将被忽略。</span><br><span class="line"></span><br><span class="line">清单文件和签名文件的注意事项</span><br><span class="line">以下是适用于清单文件和签名文件的其他限制和规则的列表。</span><br><span class="line">解析之前：</span><br><span class="line">如果文件的最后一个字符是EOF字符（代码<span class="number">26</span>），则EOF被视为空白。追加了两个换行符（一个用于不将换行符放在最后一行末尾的编辑器，而另一个则是为了使语法不必对最后一个条目进行特殊大写，因为最后一个条目后可能没有空行）。</span><br><span class="line">属性：</span><br><span class="line">在所有情况下，对于所有部分，都将忽略不了解的属性。</span><br><span class="line">属性名称不区分大小写。但是，生成清单和签名文件的程序应使用本规范中所示的情况。</span><br><span class="line">属性名称不能在节中重复。</span><br><span class="line">版本：</span><br><span class="line">Manifest-Version和Signature-Version必须是第一个，并且在这种情况下必须如此（以便可以轻松地将它们识别为魔术字符串）。除此之外，主要部分中的属性顺序并不重要。</span><br><span class="line">订购：</span><br><span class="line">各个清单条目的顺序并不重要。</span><br><span class="line">各个签名条目的顺序并不重要，只是要签名的摘要按该顺序排列。</span><br><span class="line">行长：</span><br><span class="line">以UTF8编码的形式，任何行都不能超过<span class="number">72</span>个字节（不是字符）。如果某个值会使初始行长于此长度，则应在额外的行上继续（每行以单个SPACE开头）。</span><br><span class="line">错误：</span><br><span class="line">如果根据该规范无法解析文件，则应输出警告，并且任何签名均不可信任。</span><br><span class="line">局限性：</span><br><span class="line">因为标头名称不能连续，所以标头名称的最大长度为<span class="number">70</span>个字节（名称后必须有一个冒号和一个空格）。</span><br><span class="line">NUL，CR和LF不能嵌入标头值中，而NUL，CR，LF和“：”不能嵌入标头名中。</span><br><span class="line">实现应支持<span class="number">65535</span>字节（非字符）头值，以及每个文件<span class="number">65535</span>头。它们可能会用完内存，但是在这些值以下不应有硬编码的限制。</span><br><span class="line">签名人：</span><br><span class="line">从技术上讲，不同的实体可能会使用不同的签名算法来共享单个签名文件。这违反了标准，多余的签名可能会被忽略。</span><br><span class="line">算法：</span><br><span class="line">此标准不要求摘要算法或签名算法。但是，必须至少支持MD5和SHA1摘要算法之一。</span><br><span class="line">JAR指数</span><br><span class="line">总览</span><br><span class="line">从<span class="number">1.3</span>开始，引入JarIndex来优化网络应用程序（尤其是小应用程序）的类加载器的类搜索过程。最初，applet类加载器使用简单的线性搜索算法来搜索其内部搜索路径中的每个元素，该内部搜索路径是由“ ARCHIVE”标签或“ Class-Path”主属性构造的。类加载器将下载并打开其搜索路径中的每个元素，直到找到该类或资源为止。如果类加载器尝试查找不存在的资源，则必须下载应用程序或applet中的所有jar文件。对于大型网络应用程序和小程序，这可能导致启动缓慢，响应缓慢以及网络带宽浪费。JarIndex机制收集小程序中定义的所有jar文件的内容，并将信息存储在小程序类路径上第一个jar文件的索引文件中。在下载第一个jar文件之后，小应用程序类加载器将使用收集的内容信息来高效下载jar文件。</span><br><span class="line">现有的jar工具得到了增强，可以检查jar文件列表并生成有关哪些类和资源驻留在哪个jar文件中的目录信息。此目录信息存储在根jar文件的META-INF目录中名为INDEX.LIST的简单文本 文件中。当类加载器加载根jar文件时，它将读取INDEX.LIST文件，并使用它来构建从文件名和程序包名到jar文件名列表的映射的哈希表。为了找到类或资源，类加载器查询哈希表以找到合适的jar文件，然后在必要时下载它。</span><br><span class="line"></span><br><span class="line">一旦类加载器在特定的jar文件中找到INDEX.LIST文件，它就始终信任其中列出的信息。如果找到特定类的映射，但类加载器无法通过跟踪链接找到它，则抛出InvalidJarIndexException。发生这种情况时，应用程序开发人员应在扩展名上重新运行jar工具，以将正确的信息获取到索引文件中。</span><br><span class="line"></span><br><span class="line">为了防止在应用程序中增加过多的空间开销并加快内存中哈希表的构建，INDEX.LIST文件应保持尽可能小。对于具有非空包名称的类，映射记录在包级别。通常，一个程序包名称映射到一个jar文件，但是如果一个特定的程序包跨越一个以上的jar文件，则此程序包的映射值将是jar文件列表。对于具有非空目录前缀的资源文件，映射也记录在目录级别。仅对于包名称为空的类以及位于根目录中的资源文件，映射将在单个文件级别记录。</span><br><span class="line"></span><br><span class="line">索引文件规范</span><br><span class="line">所述INDEX.LIST文件包含一个或多个部分，每个部分分离由单个空行。每个部分都定义了特定jar文件的内容，其中的标头定义了jar文件的路径名，其后是包或文件名的列表，每行一个。所有的jar文件路径都相对于根jar文件的代码库。这些路径名的解析方式与当前扩展机制对捆绑扩展名的解析方式相同。</span><br><span class="line">UTF-<span class="number">8</span>编码用于支持索引文件中文件名或包名中的非ASCII字符。</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">规格</span><br><span class="line">    索引文件：版本信息空白行部分*</span><br><span class="line">    版本信息：               JarIndex版本： 版本号</span><br><span class="line">    版本号：数字+ &#123; 。digit +&#125; *</span><br><span class="line">    部分：主体空白行</span><br><span class="line">    主体：标题名称*</span><br><span class="line">    标题：<span class="keyword">char</span> + .jar 换行</span><br><span class="line">    名称：<span class="keyword">char</span> +换行</span><br><span class="line">    字符：除 NULL，CR 和LF 之外的任何有效Unicode字符</span><br><span class="line">    空白行：newline newline</span><br><span class="line">    newline：                       CR LF | 低频| CR（不跟 LF）</span><br><span class="line">    数字：                           &#123; <span class="number">0</span>-<span class="number">9</span> &#125;</span><br><span class="line"> </span><br><span class="line">的INDEX.LIST文件通过运行产生罐子-i。有关更多详细信息，请参见jar手册页。</span><br><span class="line">向后兼容</span><br><span class="line">新的类加载方案与在当前扩展机制之上开发的应用程序完全向后兼容。当类加载器加载第一个jar文件并在META-INF 目录中找到INDEX.LIST文件时，它将构造索引哈希表，并对扩展使用新的加载方案。否则，类加载器将仅使用原始的线性搜索算法。</span><br><span class="line">服务提供者</span><br><span class="line">总览</span><br><span class="line">在文件META-INF /服务目录是服务供应商的配置文件。服务是一组著名的接口和（通常是抽象的）类。服务提供者是服务的特定实现。提供程序中的类通常实现接口，并子类化服务本身中定义的类。服务提供者可以扩展的形式安装在Java平台的实现中，也就是说，将jar文件放置在任何常用扩展目录中。也可以通过将提供程序添加到applet或应用程序类路径或通过其他某些特定于平台的方式来使提供程序可用。</span><br><span class="line"></span><br><span class="line">服务由抽象类表示。给定服务的提供者包含一个或多个具体类，这些类通过特定于该提供者的数据和代码扩展该服务类。该提供程序类通常不是整个提供程序本身，而是包含足够信息以决定提供程序是否能够满足特定请求以及可以按需创建实际提供程序的代码的代理。提供程序类的细节往往是高度特定于服务的；没有单个类或接口可能会统一它们，因此尚未定义此类。此处强制执行的唯一要求是，提供程序类必须具有零参数构造函数，以便可以在查找过程中实例化它们。</span><br><span class="line"></span><br><span class="line">提供者配置文件</span><br><span class="line">服务提供者通过将提供者配置文件放在资源目录META-INF / services中来标识自己 。文件名应包含抽象服务类的标准名称。该文件应包含以换行符分隔的唯一的具体提供程序类名称的列表。空格和制表符以及空白行将被忽略。注释字符为“＃”（<span class="number">0x23</span>）；在每一行中，第一个注释字符之后的所有字符都将被忽略。该文件必须使用UTF-<span class="number">8</span>编码。</span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">假设我们有一个名为java.io.spi.CharCodec的服务类。它有两种抽象方法：</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CharEncoder <span class="title">getEncoder</span><span class="params">(String encodingName)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CharDecoder <span class="title">getDecoder</span><span class="params">(String encodingName)</span></span>;</span><br><span class="line">每个方法都返回一个适当的对象，如果不能转换给定的编码，则返回<span class="keyword">null</span>。典型的CharCodec提供程序将支持多个编码。</span><br><span class="line"></span><br><span class="line">如果sun.io.StandardCodec是CharCodec服务的提供者，则其jar文件将包含文件 META-INF / services / java.io.spi.CharCodec。该文件将包含单行：</span><br><span class="line"></span><br><span class="line">sun.io.StandardCodec＃平台的标准编解码器</span><br><span class="line">要找到给定编码名称的编码器，内部I / O代码将执行以下操作：</span><br><span class="line"></span><br><span class="line">   CharEncoder getEncoder（String encodingName）&#123;</span><br><span class="line">       迭代器ps = Service.providers（CharCodec<span class="class">.<span class="keyword">class</span>）</span>;</span><br><span class="line">       <span class="keyword">while</span>（ps.hasNext（））&#123;</span><br><span class="line">           CharCodec cc =（CharCodec）ps.next（）;</span><br><span class="line">           CharEncoder ce = cc.getEncoder（encodingName）;</span><br><span class="line">           如果（ce！= <span class="keyword">null</span>）</span><br><span class="line">               返回ce</span><br><span class="line">       &#125;</span><br><span class="line">       返回<span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">提供者查找机制始终在调用者的安全上下文中执行。受信任的系统代码通常应从特权安全上下文中调用此类中的方法。</span><br><span class="line"></span><br><span class="line">类路径属性</span><br><span class="line">应用程序的清单可以指定一个或多个相对URL，这些URL引用其所需的其他库的JAR文件和目录。这些相对URL相对于从中加载包含应用程序的代码库进行处理。</span><br><span class="line"></span><br><span class="line">应用程序（或更一般而言，是JAR文件）使用manifest属性指定了所需的库的相对URL Class-Path。如果在宿主Java虚拟机上找不到其他库的实现，则此属性列出了URL，以搜索这些库的实现。这些相对URL可能包括应用程序所需的任何库或资源的JAR文件和目录。不以反斜杠（/）结尾的相对URL 被假定为引用JAR文件。例如：</span><br><span class="line"></span><br><span class="line">类路径：servlet.jar infobus.jar acme / beans.jar images /</span><br><span class="line">Class-PathJAR文件的清单中最多可以指定一个标头。</span><br><span class="line"></span><br><span class="line">当前，出于安全原因，URL必须相对于JAR文件的代码库。因此，远程可选包将源自与应用程序相同的代码库。</span><br><span class="line"></span><br><span class="line">每个相对URL都是根据加载了包含应用程序或库的代码库解析的。如果结果URL无效或引用了找不到的资源，则将其忽略。</span><br><span class="line"></span><br><span class="line">通过将URL插入紧随包含JAR文件的URL的类路径中，将所得的URL用于扩展应用程序，applet或servlet的类路径。省略所有重复的URL。例如，给出以下类路径：</span><br><span class="line"></span><br><span class="line">a.jar b.jar</span><br><span class="line">假设b.jar包含以下 Class-Path清单属性：</span><br><span class="line"></span><br><span class="line">类路径：x.jar a.jar</span><br><span class="line">结果，生成的应用程序类路径将如下所示：</span><br><span class="line"></span><br><span class="line">a.jar b.jar x.jar</span><br><span class="line">如果x.jar具有自己的依赖关系，则将根据每个后续URL的相同规则添加这些依赖关系。在实际的实现中，对JAR文件的依赖关系被延迟处理，因此，直到需要时才打开JAR文件。</span><br><span class="line"></span><br><span class="line">包装封口</span><br><span class="line">可以选择密封 JAR文件和程序包，以便程序包可以在版本中强制保持一致性。</span><br><span class="line"></span><br><span class="line">封装在JAR中的程序包指定该程序包中定义的所有类都必须源自同一JAR。否则，将 SecurityException引发a。</span><br><span class="line"></span><br><span class="line">密封的JAR指定密封该JAR定义的所有程序包，除非专门为程序包覆盖。</span><br><span class="line"></span><br><span class="line">密封的包是通过manifest属性指定的，该属性 Sealed的值为trueor <span class="keyword">false</span> （与大小写无关）。例如：</span><br><span class="line"></span><br><span class="line">名称：javax / servlet / internal /</span><br><span class="line">密封：真实</span><br><span class="line">这指定javax.servlet.internal包是密封的，并且必须从同一JAR文件加载该包中的所有类。</span><br><span class="line"></span><br><span class="line">如果缺少此属性，则包密封属性是包含JAR文件的属性。</span><br><span class="line"></span><br><span class="line">密封的JAR通过相同的清单标头指定 Sealed，再次使用<span class="keyword">true</span>或 值<span class="keyword">false</span>。例如：</span><br><span class="line"></span><br><span class="line">密封：真实</span><br><span class="line">这指定将密封此归档文件中的所有程序包，除非Sealed使用清单条目中的属性为特定程序包显式覆盖 。</span><br><span class="line"></span><br><span class="line">如果缺少此属性，则为了向后兼容，假定JAR文件 未密封。然后，系统默认检查包装标头中的密封信息。</span><br><span class="line"></span><br><span class="line">程序包密封对于安全性也很重要，因为它会将对程序包保护的成员的访问限制为仅在程序包中定义的源自同一JAR文件的那些类。</span><br><span class="line"></span><br><span class="line">未命名的程序包不可密封，因此必须将要密封的类放在自己的程序包中。</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/jar%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83/" data-id="ck7xfhuya0004o4vlefyp8icq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Solr schema.xml配置详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/Solr%20schema.xml%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2020-03-18T10:06:48.341Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/Solr%20schema.xml%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/">Solr schema.xml配置详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> 版权说明。。.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  </span></span><br><span class="line"><span class="comment"> 这是solr的chema 文件，这个文件应该被重命名为"schema.xml",而且他应该放在solrhome/core/conf文件下面。</span></span><br><span class="line"><span class="comment"> 获取你也能在solr webapp 的classload下面找到他.</span></span><br><span class="line"><span class="comment"> 更多的信息可以查看</span></span><br><span class="line"><span class="comment"> http://wiki.apache.org/solr/SchemaXml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 性能说明:可以如下来提高性能。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - 设置 stored="false" 对那些只需要搜索，无需返回的字段.</span></span><br><span class="line"><span class="comment">  - 设置 indexed="false" 对于那些只用于返回无需进行搜索的字段.</span></span><br><span class="line"><span class="comment">  - 删除所有不需要 copyfiled字段的声明</span></span><br><span class="line"><span class="comment">  - 为了最好的索引大小与索引性能，设置所有一般的文本字段index=false,使用copyfile将他们copy到一个字段上，然后使用它进行搜索。</span></span><br><span class="line"><span class="comment">  - 运行jvm服务器模式，并使用较高的日志级别，避免记录每一个请求。</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"example-data-driven-schema"</span> <span class="attr">version</span>=<span class="string">"1.6"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 该配置名称与版本说明.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- 字段的有效属性:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">name：属性的名称，这里有个特殊的属性“_version_”是必须添加的。</span></span><br><span class="line"><span class="comment">type：字段的数据结构类型，所用到的类型需要在fieldType中设置。</span></span><br><span class="line"><span class="comment">default：默认值。</span></span><br><span class="line"><span class="comment">indexed：是否创建索引</span></span><br><span class="line"><span class="comment">stored：是否存储原始数据（如果不需要存储相应字段值，尽量设为false）</span></span><br><span class="line"><span class="comment">docValues：表示此域是否需要添加一个 docValues 域，这对 facet 查询， group 分组，排序， function 查询有好处，尽管这个属性不是必须的，但他能加快索引数据加载，对 NRT 近实时搜索比较友好，且更节省内存，但它也有一些限制，比如当前docValues 域只支持 strField,UUIDField,Trie*Field 等域，且要求域的域值是单值不能是多值域</span></span><br><span class="line"><span class="comment">solrMissingFirst/solrMissingLast：查询结果排序的过程中，如果发现这个字段的值不存在，则排在前面/后面，忽略排序的条件</span></span><br><span class="line"><span class="comment">multValued：是否有多个值，比如说一个用户的所有好友id。（对可能存在多值的字段尽量设置为true，避免建索引时抛出错误）</span></span><br><span class="line"><span class="comment">omitNorms：此属性若设置为 true ，即表示将忽略域值的长度标准化，忽略在索引过程中对当前域的权重设置，且会节省内存。只有全文本域或者你需要在索引创建过程中设置域的权重时才需要把这个值设为 false, 对于基本数据类型且不分词的域如intFeild,longField,Stre, 否则默认就是 false.</span></span><br><span class="line"><span class="comment">required：添加文档时，该字段必须存在，类似mysql的not null</span></span><br><span class="line"><span class="comment">termVectors: 设置为 true 即表示需要为该 field 存储项向量信息，当你需要MoreLikeThis 功能时，则需要将此属性值设为 true ，这样会带来一些性能提升。</span></span><br><span class="line"><span class="comment">termPositions: 是否存储 Term 的起始位置信息，这会增大索引的体积，但高亮功能需要依赖此项设置，否则无法高亮</span></span><br><span class="line"><span class="comment">termOffsets: 表示是否存储索引的位置偏移量，高亮功能需要此项配置，当你使用SpanQuery 时，此项配置会影响匹配的结果集</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--字段名称应该包含字母数字或下划线字符，不以一个数字开始。这是目前没有严格执行，但其他字段名称将不会有来自所有组件的第一类支持和背部的兼容性没有保证。领导和的名字下划线（如_version_）保留。--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">在这data_driven_schema_configs configset，下面三个字段是必须的：</span></span><br><span class="line"><span class="comment">id、_version_，和_text_。所有其他字段都是可以删除修改的，并根据需要手动添加</span></span><br><span class="line"><span class="comment">在xml。</span></span><br><span class="line"><span class="comment">请注意，许多动态字段也被定义-您可以使用它们来指定一个</span></span><br><span class="line"><span class="comment">字段的类型通过字段命名约定-见下文。</span></span><br><span class="line"><span class="comment">警告：本_text_catch所字段将会显著地提高索引的大小。</span></span><br><span class="line"><span class="comment">如果你不需要，考虑删除它和相应的copyfield指令。--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>=<span class="string">"long"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span> <span class="attr">required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 常规字段-&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="informer_id" type="long" indexed="true" stored="false"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="phone_number" type="string" indexed="true" stored="false"/&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    &lt;field name="title" type="string" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="content" type="string" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="latitude" type="string" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="longitude" type="string" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="attachment" type="string" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    &lt;field name="clue_status" type="int" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="del_flag" type="int" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="gmt_create" type="date" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="create_uid" type="long" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="gmt_modified" type="date" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;field name="modified_uid" type="long" indexed="true" stored="true" /&gt;</span></span><br><span class="line"><span class="comment">    &lt;!--预留字段 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;field name="id" type="string" indexed="true" stored="true"  multiValued="false" /&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"_version_"</span> <span class="attr">type</span>=<span class="string">"long"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"_root_"</span> <span class="attr">type</span>=<span class="string">"string"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"false"</span> <span class="attr">docValues</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"_text_"</span> <span class="attr">type</span>=<span class="string">"text_general"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"false"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--复制字段--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--建议建立一个拷贝字段，将所有的 全文本 字段复制到一个字段中，以便进行统一的检索</span></span><br><span class="line"><span class="comment">        要注意的是，如果你只是复制单个域，那么如果你被复制域本身就是多值域，那么目标域也是多值域，这毋庸置疑，那如果你复制的是多个域，只要其中有一个域是多值域，那么目标域就一定是多值域，这点一定要谨记</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">copyField</span> <span class="attr">source</span>=<span class="string">"*"</span> <span class="attr">dest</span>=<span class="string">"_text_"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--动态字段--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 动态字段 属性配置上与常规字段没啥区别，最大的区别是name的属性上可以进行通配，比如说name="*_i"，那么只要是后面带i的字段都是符合的。这样就不怕一些字段无法匹配无法写入  --&gt;</span></span><br><span class="line">       </span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_i"</span>  <span class="attr">type</span>=<span class="string">"int"</span>    <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_is"</span> <span class="attr">type</span>=<span class="string">"ints"</span>    <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_s"</span>  <span class="attr">type</span>=<span class="string">"string"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_ss"</span> <span class="attr">type</span>=<span class="string">"strings"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_l"</span>  <span class="attr">type</span>=<span class="string">"long"</span>   <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_ls"</span> <span class="attr">type</span>=<span class="string">"longs"</span>   <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_t"</span>   <span class="attr">type</span>=<span class="string">"text_general"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_txt"</span> <span class="attr">type</span>=<span class="string">"text_general"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_b"</span>  <span class="attr">type</span>=<span class="string">"boolean"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_bs"</span> <span class="attr">type</span>=<span class="string">"booleans"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_f"</span>  <span class="attr">type</span>=<span class="string">"float"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_fs"</span> <span class="attr">type</span>=<span class="string">"floats"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_d"</span>  <span class="attr">type</span>=<span class="string">"double"</span> <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_ds"</span> <span class="attr">type</span>=<span class="string">"doubles"</span> <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 字段类型 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">StrField: 这是一个不分词的字符串域，它支持 docValues 域，但当为其添加了docValues 域，则要求只能是单值域且该域必须存在或者该域有默认值</span></span><br><span class="line"><span class="comment">BoolField ： boolean 域，对应 true/false</span></span><br><span class="line"><span class="comment">TrieIntField, TrieFloatField, TrieLongField, TrieDoubleField 这几个都是默认的数字域， precisionStep 属性一般用于数字范围查询， precisionStep 值越小，则索引时该域的域值分出的 token 个数越多，会增大硬盘上索引的体积，但它会加快数字范围检索的响应速度， positionIncrementGap 属性表示如果当前域是多值域时，多个值之间的间距，单值域，设置此项无意义。</span></span><br><span class="line"><span class="comment">TrieDateField ：显然这是一个日期域类型，不过遗憾的是它支持 1995-12-31T23:59:59Z 这种格式的日期，比较坑爹，为此我自定义了一个 TrieCNDateField 域类型，用于支持国人比较喜欢的 yyyy-MM-dd HH:mm:ss 格式的日期。源码请参见我的上一篇博客。</span></span><br><span class="line"><span class="comment">BinaryField ：经过 base64 编码的字符串域类型，即你需要把 binary 数据进行base64 编码才能被 solr 进行索引。</span></span><br><span class="line"><span class="comment">RandomSortField ：随机排序域类型，当你需要实现伪随机排序时，请使用此域类型。</span></span><br><span class="line"><span class="comment">TextField ：是用的最多的一种域类型，它需要进行分词，所以它一般需要配置分词器。至于具体它如何配置 IK 分词器，这里就不展开了--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"string"</span> <span class="attr">class</span>=<span class="string">"solr.StrField"</span> <span class="attr">sortMissingLast</span>=<span class="string">"true"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"strings"</span> <span class="attr">class</span>=<span class="string">"solr.StrField"</span> <span class="attr">sortMissingLast</span>=<span class="string">"true"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"boolean"</span> <span class="attr">class</span>=<span class="string">"solr.BoolField"</span> <span class="attr">sortMissingLast</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"booleans"</span> <span class="attr">class</span>=<span class="string">"solr.BoolField"</span> <span class="attr">sortMissingLast</span>=<span class="string">"true"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sortMissingLast and sortMissingFirst attributes are optional attributes are</span></span><br><span class="line"><span class="comment">         currently supported on types that are sorted internally as strings</span></span><br><span class="line"><span class="comment">         and on numeric types.</span></span><br><span class="line"><span class="comment">         This includes "string","boolean", and, as of 3.5 (and 4.x),</span></span><br><span class="line"><span class="comment">         int, float, long, date, double, including the "Trie" variants.</span></span><br><span class="line"><span class="comment">       - If sortMissingLast="true", then a sort on this field will cause documents</span></span><br><span class="line"><span class="comment">         without the field to come after documents with the field,</span></span><br><span class="line"><span class="comment">         regardless of the requested sort order (asc or desc).</span></span><br><span class="line"><span class="comment">       - If sortMissingFirst="true", then a sort on this field will cause documents</span></span><br><span class="line"><span class="comment">         without the field to come before documents with the field,</span></span><br><span class="line"><span class="comment">         regardless of the requested sort order.</span></span><br><span class="line"><span class="comment">       - If sortMissingLast="false" and sortMissingFirst="false" (the default),</span></span><br><span class="line"><span class="comment">         then default lucene sorting will be used which places docs without the</span></span><br><span class="line"><span class="comment">         field first in an ascending sort and last in a descending sort.</span></span><br><span class="line"><span class="comment">    --&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      默认数值类型，用于范围类的查找, consider the tint/tfloat/tlong/tdouble types.</span></span><br><span class="line"><span class="comment">      这些字段支持文档的值，但应该是单值字段.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"int"</span> <span class="attr">class</span>=<span class="string">"solr.TrieIntField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"float"</span> <span class="attr">class</span>=<span class="string">"solr.TrieFloatField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"long"</span> <span class="attr">class</span>=<span class="string">"solr.TrieLongField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"double"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDoubleField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"ints"</span> <span class="attr">class</span>=<span class="string">"solr.TrieIntField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"floats"</span> <span class="attr">class</span>=<span class="string">"solr.TrieFloatField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"longs"</span> <span class="attr">class</span>=<span class="string">"solr.TrieLongField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"doubles"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDoubleField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">     各个精度值</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tint"</span> <span class="attr">class</span>=<span class="string">"solr.TrieIntField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tfloat"</span> <span class="attr">class</span>=<span class="string">"solr.TrieFloatField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tlong"</span> <span class="attr">class</span>=<span class="string">"solr.TrieLongField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tdouble"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDoubleField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tints"</span> <span class="attr">class</span>=<span class="string">"solr.TrieIntField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tfloats"</span> <span class="attr">class</span>=<span class="string">"solr.TrieFloatField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tlongs"</span> <span class="attr">class</span>=<span class="string">"solr.TrieLongField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tdoubles"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDoubleField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 日期格式</span></span><br><span class="line"><span class="comment">         <span class="doctag">Note:</span> --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"date"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDateField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"dates"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDateField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"0"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 一种基于树结构的日期字段，日期范围查询与数据分类--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tdate"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDateField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"6"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"tdates"</span> <span class="attr">class</span>=<span class="string">"solr.TrieDateField"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">precisionStep</span>=<span class="string">"6"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    --&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"binary"</span> <span class="attr">class</span>=<span class="string">"solr.BinaryField"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- The "RandomSortField" is not used to store or search any</span></span><br><span class="line"><span class="comment">         data.  You can declare fields of this type it in your schema</span></span><br><span class="line"><span class="comment">         to generate pseudo-random orderings of your docs for sorting </span></span><br><span class="line"><span class="comment">         or function purposes.  The ordering is generated based on the field</span></span><br><span class="line"><span class="comment">         name and the version of the index. As long as the index version</span></span><br><span class="line"><span class="comment">         remains unchanged, and the same field name is reused,</span></span><br><span class="line"><span class="comment">         the ordering of the docs will be consistent.  </span></span><br><span class="line"><span class="comment">         If you want different psuedo-random orderings of documents,</span></span><br><span class="line"><span class="comment">         for the same version of the index, use a dynamicField and</span></span><br><span class="line"><span class="comment">         change the field name in the request.</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"random"</span> <span class="attr">class</span>=<span class="string">"solr.RandomSortField"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- solr.TextField allows the specification of custom text analyzers</span></span><br><span class="line"><span class="comment">         specified as a tokenizer and a list of token filters. Different</span></span><br><span class="line"><span class="comment">         analyzers may be specified for indexing and querying.</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">         The optional positionIncrementGap puts space between multiple fields of</span></span><br><span class="line"><span class="comment">         this type on the same document, with the purpose of preventing false phrase</span></span><br><span class="line"><span class="comment">         matching across fields.</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">         For more info on customizing your analyzer chain, please see</span></span><br><span class="line"><span class="comment">         http://wiki.apache.org/solr/AnalyzersTokenizersTokenFilters</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- One can also specify an existing Analyzer class that has a</span></span><br><span class="line"><span class="comment">         default constructor via the class attribute on the analyzer element.</span></span><br><span class="line"><span class="comment">         Example:</span></span><br><span class="line"><span class="comment">    &lt;fieldType name="text_greek" class="solr.TextField"&gt;</span></span><br><span class="line"><span class="comment">      &lt;analyzer class="org.apache.lucene.analysis.el.GreekAnalyzer"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/fieldType&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- A text field that only splits on whitespace for exact matching of words --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_ws"</span> <span class="attr">type</span>=<span class="string">"text_ws"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_ws"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.WhitespaceTokenizerFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- A general text field that has reasonable, generic</span></span><br><span class="line"><span class="comment">         cross-language defaults: it tokenizes with StandardTokenizer,</span></span><br><span class="line"><span class="comment">           removes stop words from case-insensitive "stopwords.txt"</span></span><br><span class="line"><span class="comment">           (empty by default), and down cases.  At query time only, it</span></span><br><span class="line"><span class="comment">           also applies synonyms.</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_general"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">words</span>=<span class="string">"stopwords.txt"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- in this example, we will only use synonyms at query time</span></span><br><span class="line"><span class="comment">        &lt;filter class="solr.SynonymFilterFactory" synonyms="index_synonyms.txt" ignoreCase="true" expand="false"/&gt;</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">words</span>=<span class="string">"stopwords.txt"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.SynonymFilterFactory"</span> <span class="attr">synonyms</span>=<span class="string">"synonyms.txt"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">expand</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- A text field with defaults appropriate for English: it</span></span><br><span class="line"><span class="comment">         tokenizes with StandardTokenizer, removes English stop words</span></span><br><span class="line"><span class="comment">         (lang/stopwords_en.txt), down cases, protects words from protwords.txt, and</span></span><br><span class="line"><span class="comment">         finally applies Porter's stemming.  The query time analyzer</span></span><br><span class="line"><span class="comment">         also applies synonyms from synonyms.txt. --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_txt_en"</span> <span class="attr">type</span>=<span class="string">"text_en"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_en"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- in this example, we will only use synonyms at query time</span></span><br><span class="line"><span class="comment">        &lt;filter class="solr.SynonymFilterFactory" synonyms="index_synonyms.txt" ignoreCase="true" expand="false"/&gt;</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Case insensitive stop word removal.</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">ignoreCase</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">words</span>=<span class="string">"lang/stopwords_en.txt"</span></span></span><br><span class="line"><span class="tag">            /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.EnglishPossessiveFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.KeywordMarkerFilterFactory"</span> <span class="attr">protected</span>=<span class="string">"protwords.txt"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Optionally you may want to use this less aggressive stemmer instead of PorterStemFilterFactory:</span></span><br><span class="line"><span class="comment">        &lt;filter class="solr.EnglishMinimalStemFilterFactory"/&gt;</span></span><br><span class="line"><span class="comment">          --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.PorterStemFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.SynonymFilterFactory"</span> <span class="attr">synonyms</span>=<span class="string">"synonyms.txt"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">expand</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">ignoreCase</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">words</span>=<span class="string">"lang/stopwords_en.txt"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.EnglishPossessiveFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.KeywordMarkerFilterFactory"</span> <span class="attr">protected</span>=<span class="string">"protwords.txt"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Optionally you may want to use this less aggressive stemmer instead of PorterStemFilterFactory:</span></span><br><span class="line"><span class="comment">        &lt;filter class="solr.EnglishMinimalStemFilterFactory"/&gt;</span></span><br><span class="line"><span class="comment">          --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.PorterStemFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- A text field with defaults appropriate for English, plus</span></span><br><span class="line"><span class="comment">         aggressive word-splitting and autophrase features enabled.</span></span><br><span class="line"><span class="comment">         This field is just like text_en, except it adds</span></span><br><span class="line"><span class="comment">         WordDelimiterFilter to enable splitting and matching of</span></span><br><span class="line"><span class="comment">         words on case-change, alpha numeric boundaries, and</span></span><br><span class="line"><span class="comment">         non-alphanumeric chars.  This means certain compound word</span></span><br><span class="line"><span class="comment">         cases will work, for example query "wi fi" will match</span></span><br><span class="line"><span class="comment">         document "WiFi" or "wi-fi".</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_txt_en_split"</span> <span class="attr">type</span>=<span class="string">"text_en_splitting"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_en_splitting"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span> <span class="attr">autoGeneratePhraseQueries</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.WhitespaceTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- in this example, we will only use synonyms at query time</span></span><br><span class="line"><span class="comment">        &lt;filter class="solr.SynonymFilterFactory" synonyms="index_synonyms.txt" ignoreCase="true" expand="false"/&gt;</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Case insensitive stop word removal.</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">ignoreCase</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">words</span>=<span class="string">"lang/stopwords_en.txt"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.WordDelimiterFilterFactory"</span> <span class="attr">generateWordParts</span>=<span class="string">"1"</span> <span class="attr">generateNumberParts</span>=<span class="string">"1"</span> <span class="attr">catenateWords</span>=<span class="string">"1"</span> <span class="attr">catenateNumbers</span>=<span class="string">"1"</span> <span class="attr">catenateAll</span>=<span class="string">"0"</span> <span class="attr">splitOnCaseChange</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.KeywordMarkerFilterFactory"</span> <span class="attr">protected</span>=<span class="string">"protwords.txt"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.PorterStemFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.WhitespaceTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.SynonymFilterFactory"</span> <span class="attr">synonyms</span>=<span class="string">"synonyms.txt"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">expand</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">ignoreCase</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">words</span>=<span class="string">"lang/stopwords_en.txt"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.WordDelimiterFilterFactory"</span> <span class="attr">generateWordParts</span>=<span class="string">"1"</span> <span class="attr">generateNumberParts</span>=<span class="string">"1"</span> <span class="attr">catenateWords</span>=<span class="string">"0"</span> <span class="attr">catenateNumbers</span>=<span class="string">"0"</span> <span class="attr">catenateAll</span>=<span class="string">"0"</span> <span class="attr">splitOnCaseChange</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.KeywordMarkerFilterFactory"</span> <span class="attr">protected</span>=<span class="string">"protwords.txt"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.PorterStemFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- Less flexible matching, but less false matches.  Probably not ideal for product names,</span></span><br><span class="line"><span class="comment">         but may be good for SKUs.  Can insert dashes in the wrong place and still match. --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_txt_en_split_tight"</span> <span class="attr">type</span>=<span class="string">"text_en_splitting_tight"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_en_splitting_tight"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span> <span class="attr">autoGeneratePhraseQueries</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.WhitespaceTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.SynonymFilterFactory"</span> <span class="attr">synonyms</span>=<span class="string">"synonyms.txt"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">expand</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">words</span>=<span class="string">"lang/stopwords_en.txt"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.WordDelimiterFilterFactory"</span> <span class="attr">generateWordParts</span>=<span class="string">"0"</span> <span class="attr">generateNumberParts</span>=<span class="string">"0"</span> <span class="attr">catenateWords</span>=<span class="string">"1"</span> <span class="attr">catenateNumbers</span>=<span class="string">"1"</span> <span class="attr">catenateAll</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.KeywordMarkerFilterFactory"</span> <span class="attr">protected</span>=<span class="string">"protwords.txt"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.EnglishMinimalStemFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- this filter can remove any duplicate tokens that appear at the same position - sometimes</span></span><br><span class="line"><span class="comment">             possible with WordDelimiterFilter in conjuncton with stemming. --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.RemoveDuplicatesTokenFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- Just like text_general except it reverses the characters of</span></span><br><span class="line"><span class="comment">           each token, to enable more efficient leading wildcard queries.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_txt_rev"</span> <span class="attr">type</span>=<span class="string">"text_general_rev"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_general_rev"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">words</span>=<span class="string">"stopwords.txt"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.ReversedWildcardFilterFactory"</span> <span class="attr">withOriginal</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">maxPosAsterisk</span>=<span class="string">"3"</span> <span class="attr">maxPosQuestion</span>=<span class="string">"2"</span> <span class="attr">maxFractionAsterisk</span>=<span class="string">"0.33"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.SynonymFilterFactory"</span> <span class="attr">synonyms</span>=<span class="string">"synonyms.txt"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">expand</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">words</span>=<span class="string">"stopwords.txt"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_phon_en"</span> <span class="attr">type</span>=<span class="string">"phonetic_en"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"phonetic_en"</span> <span class="attr">stored</span>=<span class="string">"false"</span> <span class="attr">indexed</span>=<span class="string">"true"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.DoubleMetaphoneFilterFactory"</span> <span class="attr">inject</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- lowercases the entire field value, keeping it as a single token.  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_s_lower"</span> <span class="attr">type</span>=<span class="string">"lowercase"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"lowercase"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.KeywordTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">      Example of using PathHierarchyTokenizerFactory at index time, so</span></span><br><span class="line"><span class="comment">      queries for paths match documents at that path, or in descendent paths</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_descendent_path"</span> <span class="attr">type</span>=<span class="string">"descendent_path"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"descendent_path"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.PathHierarchyTokenizerFactory"</span> <span class="attr">delimiter</span>=<span class="string">"/"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.KeywordTokenizerFactory"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      Example of using PathHierarchyTokenizerFactory at query time, so</span></span><br><span class="line"><span class="comment">      queries for paths match documents at that path, or in ancestor paths</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_ancestor_path"</span> <span class="attr">type</span>=<span class="string">"ancestor_path"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"ancestor_path"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.KeywordTokenizerFactory"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.PathHierarchyTokenizerFactory"</span> <span class="attr">delimiter</span>=<span class="string">"/"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- since fields of this type are by default not stored or indexed,</span></span><br><span class="line"><span class="comment">         any data added to them will be ignored outright.  --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"ignored"</span> <span class="attr">stored</span>=<span class="string">"false"</span> <span class="attr">indexed</span>=<span class="string">"false"</span> <span class="attr">docValues</span>=<span class="string">"false"</span> <span class="attr">multiValued</span>=<span class="string">"true"</span> <span class="attr">class</span>=<span class="string">"solr.StrField"</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- This point type indexes the coordinates as separate fields (subFields)</span></span><br><span class="line"><span class="comment">      If subFieldType is defined, it references a type, and a dynamic field</span></span><br><span class="line"><span class="comment">      definition is created matching *___&lt;typename&gt;.  Alternately, if </span></span><br><span class="line"><span class="comment">      subFieldSuffix is defined, that is used to create the subFields.</span></span><br><span class="line"><span class="comment">      Example: if subFieldType="double", then the coordinates would be</span></span><br><span class="line"><span class="comment">        indexed in fields myloc_0___double,myloc_1___double.</span></span><br><span class="line"><span class="comment">      Example: if subFieldSuffix="_d" then the coordinates would be indexed</span></span><br><span class="line"><span class="comment">        in fields myloc_0_d,myloc_1_d</span></span><br><span class="line"><span class="comment">      The subFields are an implementation detail of the fieldType, and end</span></span><br><span class="line"><span class="comment">      users normally should not need to know about them.</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_point"</span> <span class="attr">type</span>=<span class="string">"point"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"point"</span> <span class="attr">class</span>=<span class="string">"solr.PointType"</span> <span class="attr">dimension</span>=<span class="string">"2"</span> <span class="attr">subFieldSuffix</span>=<span class="string">"_d"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- A specialized field for geospatial search. If indexed, this fieldType must not be multivalued. --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"location"</span> <span class="attr">class</span>=<span class="string">"solr.LatLonType"</span> <span class="attr">subFieldSuffix</span>=<span class="string">"_coordinate"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- An alternative geospatial field type new to Solr 4.  It supports multiValued and polygon shapes.</span></span><br><span class="line"><span class="comment">      For more information about this and other Spatial fields new to Solr 4, see:</span></span><br><span class="line"><span class="comment">      http://wiki.apache.org/solr/SolrAdaptersForLuceneSpatial4</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"location_rpt"</span> <span class="attr">class</span>=<span class="string">"solr.SpatialRecursivePrefixTreeFieldType"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">geo</span>=<span class="string">"true"</span> <span class="attr">distErrPct</span>=<span class="string">"0.025"</span> <span class="attr">maxDistErr</span>=<span class="string">"0.001"</span> <span class="attr">distanceUnits</span>=<span class="string">"kilometers"</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- Money/currency field type. See http://wiki.apache.org/solr/MoneyFieldType</span></span><br><span class="line"><span class="comment">        Parameters:</span></span><br><span class="line"><span class="comment">          defaultCurrency: Specifies the default currency if none specified. Defaults to "USD"</span></span><br><span class="line"><span class="comment">          precisionStep:   Specifies the precisionStep for the TrieLong field used for the amount</span></span><br><span class="line"><span class="comment">          providerClass:   Lets you plug in other exchange provider backend:</span></span><br><span class="line"><span class="comment">                           solr.FileExchangeRateProvider is the default and takes one parameter:</span></span><br><span class="line"><span class="comment">                             currencyConfig: name of an xml file holding exchange rates</span></span><br><span class="line"><span class="comment">                           solr.OpenExchangeRatesOrgProvider uses rates from openexchangerates.org:</span></span><br><span class="line"><span class="comment">                             ratesFileLocation: URL or path to rates JSON file (default latest.json on the web)</span></span><br><span class="line"><span class="comment">                             refreshInterval: Number of minutes between each rates fetch (default: 1440, min: 60)</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"currency"</span> <span class="attr">class</span>=<span class="string">"solr.CurrencyField"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">defaultCurrency</span>=<span class="string">"USD"</span> <span class="attr">currencyConfig</span>=<span class="string">"currency.xml"</span> /&gt;</span></span><br><span class="line">           </span><br><span class="line">    <span class="comment">&lt;!-- some examples for different languages (generally ordered by ISO code) --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Armenian --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamicField</span> <span class="attr">name</span>=<span class="string">"*_txt_hy"</span> <span class="attr">type</span>=<span class="string">"text_hy"</span>  <span class="attr">indexed</span>=<span class="string">"true"</span>  <span class="attr">stored</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_hy"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">analyzer</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"solr.StandardTokenizerFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.LowerCaseFilterFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.StopFilterFactory"</span> <span class="attr">ignoreCase</span>=<span class="string">"true"</span> <span class="attr">words</span>=<span class="string">"lang/stopwords_hy.txt"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"solr.SnowballPorterFilterFactory"</span> <span class="attr">language</span>=<span class="string">"Armenian"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/Solr%20schema.xml%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/" data-id="ck7xfhuy80003o4vlaphldp6g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-微服务spring大纲以及组件说明" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1spring%E5%A4%A7%E7%BA%B2%E4%BB%A5%E5%8F%8A%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E/" class="article-date">
  <time datetime="2020-03-18T09:50:57.897Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1spring%E5%A4%A7%E7%BA%B2%E4%BB%A5%E5%8F%8A%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E/">微服务spring大纲以及组件说明</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="微服务spring大纲以及组件说明"><a href="#微服务spring大纲以及组件说明" class="headerlink" title="微服务spring大纲以及组件说明"></a>微服务spring大纲以及组件说明</h2><p>Spring官方网站网址链接<br><a href="https://spring.io/projects" target="_blank" rel="noopener">https://spring.io/projects</a><br><a href="https://spring.io/projects/spring-boot" target="_blank" rel="noopener">https://spring.io/projects/spring-boot</a><br><a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud</a></p>
<p>Spring Boot/Cloud是基于Spring技术栈所构建的一整套完善的微服务框架，旨在简化Java微服务开发的流程与方式，让开发者能够以更具效率的方式来进行Java微服务的开发；<br>不过，Spring Boot/Cloud底层使用了众多优秀的技术，这些技术被隐藏到了框架内部，我们需要深入挖掘这些底层技术方能更好地理解框架的运作原理，也才能更好地应用。课程中将会透过大量的代码实例与框架源码剖析来讲解框架的使用方式与底层执行流程，帮助学习者充分理解框架的底层原理；同时，课程还会对微服务的理论与最佳实践进行深入剖析，课程讲解的是Spring Boot/Cloud，但又不会拘泥于Spring Boot/Cloud，而是对微服务这种架构风格进行一次系统、完整的梳理。</p>
<p>使用Gradle构建Spring Boot 2.0项目讲解<br>Spring Boot 2.0重要开发工具讲解<br>Spring Boot 2.0启动类与核心注解@SpringBootApplication<br>Spring Boot 2.0的自动配置详解<br>Spring Boot 2.0配置类注解详解<br>深入理解Spring Boot 2.0自动配置过程与方式<br>Spring Cloud Eureka使用方式详解与高可用配置（优瑞卡）<br>Spring Cloud Eureka自我保护模式深入剖析<br>Spring Cloud Eureka心跳检测方式详解<br>Spring Cloud Eureka重要执行流程源码深入讲解<br>Spring Cloud Eureka整体架构详解<br>Spring Cloud Ribbon客户端负载均衡详解<br>Spring Cloud Ribbon负载均衡规则详解<br>LoadBalancerClient、IRule与IPing组件详解<br>Spring Cloud Ribbon实现负载均衡的原理详解<br>Spring Cloud Feign使用详解<br>Spring Cloud Feign重要注解的使用与功能详解<br>Spring Cloud Feign底层网络通信框架的选取规则详解<br>Spring Cloud Feign执行流程剖析<br>Spring Cloud Hystrix使用方式详解<br>Spring Cloud Hystrix原理详解<br>Spring Cloud Hystrix Fallback机制详解<br>Spring Cloud Zuul使用方式详解<br>Spring Cloud Zuul转发与过滤器规则详解<br>Spring Cloud Zuul核心源码深入剖析<br>Spring Cloud Zuul执行流程深入剖析<br>Spring Cloud Config使用方式详解<br>Spring Cloud Config对于Git仓库的支援详解<br>Spring Cloud Config资源文件Web接口剖析<br>Spring Cloud Sleuth使用方式详解与演示<br>分布式链路追踪系统原理剖析<br>Spring Cloud Sleuth分布式链路追踪系统深入剖析<br>Spring Cloud Sleuth重要核心概念详解<br>Spring Cloud Sleuth底层执行流程深入剖析<br>微服务使用最佳实践<br>微服务的架构风格原理深入剖析<br>微服务开发中常见的重要问题深入详解</p>
<p>Spring Cloud Config:配置工具，支持使用Git存储配置内容，可以使用它实现应用配置的外部化存储，并支持客户端配置信息刷新，加密/解密配置内容等<br>Spring Cloud Netflix:核心组件，对于多个Netflix OSS开源套件进行整合。<br>Eureka:服务治理组件，包含服务注册中心，服务注册与发现机制的实现（目前闭源，无需要IP和域名才可以）<br>Hystrix: 容错管理组件，实现断路器模式，帮助服务以来中出现的延迟和为故障提供强大的容错能力<br>Ribbon:客户端负载均衡的服务调用组件(不需要Nginx负载均衡)。<br>Feign:基于Ribbon和Hystrix的声明式服务调用组件<br>Zuul:网关组件，提供智能路由，访问过滤等功能<br>Archaius:外部化配置组件<br>Spring Cloud Bus:事件，消息总线，用于传播集群中的状态变化或事件，以触发后续的处理，比如用来动态刷新配置等<br>Spring Cloud Cluster：针对ZooKeeper,Redis,Hazelcast,Consul的选举算法和通用状态模式的实现<br>Spring Cloud Cloudfoundry:与Pivotal Cloudfoundry的整合支持<br>Spring Cloud Consul: 服务发现与配置管理工具<br>Spring Cloud Stream:通过Redis, Rabbit或者Kafka实现的消费微服务，可以通过简单的声明式来发送和接收消息<br>Spring Cloud AWS : 用于建华整合Amazon Web Service的组件<br>Spring Cloud Security：安全工具包，提供在Zuul代理中对OAuth2客户端请求的中继器<br>Spring Cloud Sleuth : Spring Cloud应用的分布式跟踪实现，if 可以完美整合Zipkin:<br>Spring Cloud Zookeeper:基于ZooKeeper的服务发现与配置管理组件<br>Spring Cloud Starters:Spring Cloud的基础组件，它是基于Spring Boot 风格项目的基础依赖模块<br>Spring Cloud CLI:用于在Groovy中快速创建Spring Cloud 应用的Spring Boot CLI插件</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1spring%E5%A4%A7%E7%BA%B2%E4%BB%A5%E5%8F%8A%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E/" data-id="ck7xfhux30002o4vl0swj35bn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/18/Tomcat%20%E4%B8%93%E9%A2%98/">Tomcat 专题</a>
          </li>
        
          <li>
            <a href="/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/">精通Spring Boot与Cloud</a>
          </li>
        
          <li>
            <a href="/2020/03/18/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2020/03/18/Windows%E4%B8%8BCmder%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/">Windows下Cmder的配置与使用</a>
          </li>
        
          <li>
            <a href="/2020/03/18/jar%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83/">jar文件规范</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 xiaohua<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">tags</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>