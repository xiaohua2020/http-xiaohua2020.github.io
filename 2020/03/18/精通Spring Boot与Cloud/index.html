<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>精通Spring Boot与Cloud | xiaohua&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Spring_Boot_Loader源码深入解析源代码位于：spring-boot-loader-2.1.3.RELEASE.jar中。 类层次结构：  1、Launcher类详解12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:type" content="article">
<meta property="og:title" content="精通Spring Boot与Cloud">
<meta property="og:url" content="http://yoursite.com/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/index.html">
<meta property="og:site_name" content="xiaohua&#39;blog">
<meta property="og:description" content="Spring_Boot_Loader源码深入解析源代码位于：spring-boot-loader-2.1.3.RELEASE.jar中。 类层次结构：  1、Launcher类详解12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5Cdiagram.png">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C6.JPG">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C7.JPG">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C8.JPG">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C9.JPG">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C10.JPG">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C11.JPG">
<meta property="og:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C12.png">
<meta property="article:published_time" content="2020-03-18T11:34:11.724Z">
<meta property="article:modified_time" content="2020-03-18T02:58:26.984Z">
<meta property="article:author" content="xiaohua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="e:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5Cdiagram.png">
  
    <link rel="alternate" href="/atom.xml" title="xiaohua&#39;blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xiaohua&#39;blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-精通Spring Boot与Cloud" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/" class="article-date">
  <time datetime="2020-03-18T11:34:11.724Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      精通Spring Boot与Cloud
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spring-Boot-Loader源码深入解析"><a href="#Spring-Boot-Loader源码深入解析" class="headerlink" title="Spring_Boot_Loader源码深入解析"></a>Spring_Boot_Loader源码深入解析</h2><p>源代码位于：spring-boot-loader-2.1.3.RELEASE.jar中。</p>
<p>类层次结构：</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5Cdiagram.png" alt=""></p>
<h3 id="1、Launcher类详解"><a href="#1、Launcher类详解" class="headerlink" title="1、Launcher类详解"></a>1、Launcher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.security.CodeSource;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.ExplodedArchive;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.JarFileArchive;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个父类，针对于启动器的，它是可以启动一个应用的，这个应用是带有完全配置好的类路径，是由一</span></span><br><span class="line"><span class="comment">// 个或多个归档文件支撑的（这是一个用于启动应用的基类，这个基类它是针对于一个或多个归档文件使用的）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for launchers that can start an application with a fully configured</span></span><br><span class="line"><span class="comment"> * classpath backed by one or more &#123;<span class="doctag">@link</span> Archive&#125;s.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Launcher会加载这个应用，这个方法是一个初始的入口点，它应该被当前类的一个子类的public 		</span></span><br><span class="line">    <span class="comment">// static void main(String[] args)方法调用</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Launch the application. This method is the initial entry point that should be</span></span><br><span class="line"><span class="comment">	 * called by a subclass &#123;<span class="doctag">@code</span> public static void main(String[] args)&#125; method.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the application fails to launch</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 注册Url的协议处理器，位于JarFile类当中</span></span><br><span class="line">		JarFile.registerUrlProtocolHandler();</span><br><span class="line">		<span class="comment">// 很重要！你过去所深入学习的一些知识点，在未来的某一个时刻一定会被用到</span></span><br><span class="line">        <span class="comment">// 创建类加载器，符合条件的归档文件传入</span></span><br><span class="line">        <span class="comment">// getClassPathArchives()返回List&lt;Archive&gt;集合，list当中的每一个Archive对象，</span></span><br><span class="line">        <span class="comment">// 要么是classes目录，要么是lib目录下所有的jar文件的路径</span></span><br><span class="line">        ClassLoader classLoader = createClassLoader(getClassPathArchives());</span><br><span class="line">        <span class="comment">// 第一个参数：args命令行传入的参数</span></span><br><span class="line">        <span class="comment">// 第二个参数：getMainClass()方法调用，本身是一个抽象的方法，需要看具体的</span></span><br><span class="line">        <span class="comment">// 实现ExecutableArchiveLauncher类（即主类或启动类对应的字符串）</span></span><br><span class="line">        <span class="comment">// 第三个参数：classLoader类加载器</span></span><br><span class="line">		launch(args, getMainClass(), classLoader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个类加载器针对于所指定的归档文件</span></span><br><span class="line">    <span class="comment">// createClassLoader这个方法会创建一个新的类加载器，这个类加载器就是用来加载classes目录下的</span></span><br><span class="line">    <span class="comment">// class文件与lib目录下的jar文件信息</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a classloader for the specified archives.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> archives the archives</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the classloader cannot be created</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(List&lt;Archive&gt; archives)</span> <span class="keyword">throws</span> Exception </span>&#123;	     	<span class="comment">// 根据所传入的集合创建新的集合，这个新创建集合的大小就是所传入集合的大小</span></span><br><span class="line">		List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;(archives.size());</span><br><span class="line">        <span class="comment">// 遍历集合所传入的每一个对象，然后将每一个对象的url添加至新的集合当中</span></span><br><span class="line">		<span class="keyword">for</span> (Archive archive : archives) &#123;</span><br><span class="line">            <span class="comment">// archive.getUrl() 对应着jar文件在磁盘上的完整的绝对路径</span></span><br><span class="line">			urls.add(archive.getUrl());</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// urls.toArray(new URL[0])转换为数组</span></span><br><span class="line">		<span class="keyword">return</span> createClassLoader(urls.toArray(<span class="keyword">new</span> URL[<span class="number">0</span>]));</span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="comment">// 创建一个针对于指定的url的类加载器</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a classloader for the specified URLs.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> urls the URLs</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the classloader cannot be created</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(URL[] urls)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// Spring Boot loader提供的全新类加载器</span></span><br><span class="line">        <span class="comment">// 在创建一个类加载器的时候，一定要指定它的父类加载器是什么</span></span><br><span class="line">        <span class="comment">// 第一个参数：urls被加载的jar文件的绝路径</span></span><br><span class="line">        <span class="comment">// 第二个参数：父类加载器（应用或系统类加载器），getClass()返回当前类Launcher的实例，</span></span><br><span class="line">        <span class="comment">// 然后获取它的类加载器，即应用或系统类加载器</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LaunchedURLClassLoader(urls, getClass().getClassLoader());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 针对给定存档文件和完全配置的类加载器启动应用程序</span></span><br><span class="line">    <span class="comment">// 第一个参数：接收到传递的参数</span></span><br><span class="line">    <span class="comment">// 第二个参数：准备要运行的主类</span></span><br><span class="line">    <span class="comment">// 第三个参数：类加载器</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Launch the application given the archive file and a fully configured classloader.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mainClass the main class to run</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> classLoader the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the launch fails</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String[] args, String mainClass, ClassLoader classLoader)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到当前线程，然后设置上下文类加载器，默认情况下，上下文类加载器是AppClassLoader，</span></span><br><span class="line">        <span class="comment">// 通过这种方式把当前线程上下文类加载器由默认的AppClassLoader换成SpringBoot自己定义</span></span><br><span class="line">        <span class="comment">// 的类加载器LauncherURLClassLoader</span></span><br><span class="line">		Thread.currentThread().setContextClassLoader(classLoader);</span><br><span class="line">        <span class="comment">// 创建主方法运行器</span></span><br><span class="line">		createMainMethodRunner(mainClass, args, classLoader).run();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建MainMethodRunner用于启动或加载应用</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create the &#123;<span class="doctag">@code</span> MainMethodRunner&#125; used to launch the application.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mainClass the main class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> classLoader the classloader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the main method runner</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> MainMethodRunner <span class="title">createMainMethodRunner</span><span class="params">(String mainClass, String[] args, ClassLoader classLoader)</span> </span>&#123; <span class="comment">// classLoader未使用到 </span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MainMethodRunner(mainClass, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回应该被加载的主类</span></span><br><span class="line">    <span class="comment">// 返回main-class的名称</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the main class that should be launched.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the name of the main class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the main class cannot be obtained</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getMainClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这是一个抽象方法，返回一个归档文件，它用于构建类路径</span></span><br><span class="line">    <span class="comment">// 找具体的子类ExecutableArchiveLauncher的实现</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the archives that will be used to construct the class path.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the class path archives</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if the class path archives cannot be obtained</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Archive&gt; <span class="title">getClassPathArchives</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 用来定位我们当前被执行的那个jar文件，</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Archive <span class="title">createArchive</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ProtectionDomain protectionDomain = getClass().getProtectionDomain();</span><br><span class="line">		CodeSource codeSource = protectionDomain.getCodeSource();</span><br><span class="line">		URI location = (codeSource != <span class="keyword">null</span>) ? codeSource.getLocation().toURI() : <span class="keyword">null</span>;</span><br><span class="line">		String path = (location != <span class="keyword">null</span>) ? location.getSchemeSpecificPart() : <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to determine code source archive"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 创建File对象，File对象本身就是被执行的jar文件，实际上就表示</span></span><br><span class="line">        <span class="comment">// springboot_lecture-1.0.jar完整的绝对路径</span></span><br><span class="line">		File root = <span class="keyword">new</span> File(path); </span><br><span class="line">		<span class="keyword">if</span> (!root.exists()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to determine code source archive from "</span> + root);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (root.isDirectory() ? <span class="keyword">new</span> ExplodedArchive(root) : <span class="keyword">new</span> JarFileArchive(root));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、ExecutableArchiveLauncher类详解"><a href="#2、ExecutableArchiveLauncher类详解" class="headerlink" title="2、ExecutableArchiveLauncher类详解"></a>2、ExecutableArchiveLauncher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可执行的归档启动器的父类，它的子类有两个：</span></span><br><span class="line"><span class="comment">// JarLauncher</span></span><br><span class="line"><span class="comment">// WarLauncher当我们对SpringBoot工程打的不是jar包而是war包的时候就会使用WarLauncher启动器</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for executable archive &#123;<span class="doctag">@link</span> Launcher&#125;s.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutableArchiveLauncher</span> <span class="keyword">extends</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Archive archive;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ExecutableArchiveLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">this</span>.archive = createArchive();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="title">ExecutableArchiveLauncher</span><span class="params">(Archive archive)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.archive = archive;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Archive <span class="title">getArchive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.archive;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// MANIFEST.MF文件内容：</span></span><br><span class="line">   <span class="comment">// Manifest-Version: 1.0</span></span><br><span class="line">   <span class="comment">// Start-Class: com.shengsiyuan.boot.MyApplication</span></span><br><span class="line">   <span class="comment">// Spring-Boot-Classes: BOOT-INF/classes/</span></span><br><span class="line">   <span class="comment">// Spring-Boot-Lib: BOOT-INF/lib/</span></span><br><span class="line">   <span class="comment">// Spring-Boot-Version: 2.2.5.RELEASE</span></span><br><span class="line">   <span class="comment">// Main-Class: org.springframework.boot.loader.JarLauncher</span></span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> String <span class="title">getMainClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Manifest manifest = <span class="keyword">this</span>.archive.getManifest();</span><br><span class="line">      String mainClass = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (manifest != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="comment">// 获取Start-Class的所有属性值（当前项目或工程的启动类）的字符串</span></span><br><span class="line">         mainClass = manifest.getMainAttributes().getValue(<span class="string">"Start-Class"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (mainClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No 'Start-Class' manifest entry specified in "</span> + <span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 返回Start-Class的字符串</span></span><br><span class="line">      <span class="keyword">return</span> mainClass;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> List&lt;Archive&gt; <span class="title">getClassPathArchives</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// 得到一个List&lt;Archive&gt;集合，			   	    	 	//this.archive.getNestedArchives(this::isNestedArchive)</span></span><br><span class="line">       <span class="comment">// 这行代码返回的是什么？</span></span><br><span class="line">      List&lt;Archive&gt; archives = <span class="keyword">new</span> ArrayList&lt;&gt;</span><br><span class="line">          <span class="comment">// 获取嵌套的Archives</span></span><br><span class="line">          <span class="comment">// 通过this::isNestedArchive方法引用判断当前给定的的entry是不是一个符合条件的</span></span><br><span class="line">          <span class="comment">// WEB-INF开头或者是lib目录开头的，如果是的话就加到List&lt;Archive&gt;集合当中</span></span><br><span class="line">          (<span class="keyword">this</span>.archive.getNestedArchives(<span class="keyword">this</span>::isNestedArchive));</span><br><span class="line">      <span class="comment">// 通过上面的代码会得到一个结论：它会将BOOT-INF下面的classes目录，lib目录里面所有的jar文		</span></span><br><span class="line">      <span class="comment">// 件都放置在List&lt;Archive&gt;集合当中</span></span><br><span class="line">       </span><br><span class="line">      <span class="comment">// 调用postProcessClassPathArchives()方法</span></span><br><span class="line">      postProcessClassPathArchives(archives);</span><br><span class="line">      <span class="comment">// 符合条件的archives返回（classes与lib目录）</span></span><br><span class="line">      <span class="keyword">return</span> archives;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确定是否指定JarEntry是一个嵌套的条目，应该被添加至类路径下，这个方法是针对于一个</span></span><br><span class="line">    <span class="comment">// entry只会被调用一次</span></span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Determine if the specified &#123;<span class="doctag">@link</span> JarEntry&#125; is a nested item that should be added</span></span><br><span class="line"><span class="comment">    * to the classpath. The method is called once for each entry.</span></span><br><span class="line"><span class="comment">    // entry就是这个jar文件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> entry the jar entry </span></span><br><span class="line"><span class="comment">    // 如果entry是一个嵌套的条目（jar文件或者目录）</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the entry is a nested item (jar or folder)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isNestedArchive</span><span class="params">(Archive.Entry entry)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 在使用归档项之前调用它们。可以实现添加和删除条目</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called to post-process archive entries before they are used. Implementations can</span></span><br><span class="line"><span class="comment">    * add and remove entries.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> archives the archives</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception if the post processing fails</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessClassPathArchives</span><span class="params">(List&lt;Archive&gt; archives)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、JarLauncher类详解"><a href="#3、JarLauncher类详解" class="headerlink" title="3、JarLauncher类详解"></a>3、JarLauncher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个启动器，针对于用于jar的归档文件，这个launcher假设依赖的jar位于一个/BOOT-INF/lib目录</span></span><br><span class="line"><span class="comment">// 下，另外又假设应用类是被包含在/BOOT-INF/classes目录下。</span></span><br><span class="line">├─BOOT-INF</span><br><span class="line">│  ├─classes</span><br><span class="line">│  │  └─com</span><br><span class="line">│  │      └─shengsiyuan</span><br><span class="line">│  │          └─boot</span><br><span class="line">│  │              ├─config</span><br><span class="line">│  │              ├─controller</span><br><span class="line">│  │              └─domain</span><br><span class="line">│  └─lib</span><br><span class="line">├─META-INF</span><br><span class="line">└─org</span><br><span class="line">    └─springframework</span><br><span class="line">        └─boot</span><br><span class="line">            └─loader</span><br><span class="line">                ├─archive</span><br><span class="line">                ├─data</span><br><span class="line">                ├─jar</span><br><span class="line">                └─util</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Launcher&#125; for JAR based archives. This launcher assumes that dependency jars are</span></span><br><span class="line"><span class="comment"> * included inside a &#123;<span class="doctag">@code</span> /BOOT-INF/lib&#125; directory and that application classes are</span></span><br><span class="line"><span class="comment"> * included inside a &#123;<span class="doctag">@code</span> /BOOT-INF/classes&#125; directory.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span>    </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JarLauncher</span> <span class="keyword">extends</span> <span class="title">ExecutableArchiveLauncher</span> </span>&#123; </span><br><span class="line">    <span class="comment">// JarLauncher继承可执行的归档的启动器</span></span><br><span class="line">	<span class="comment">// 定义两个静态字符串并且是final的常量</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String BOOT_INF_CLASSES = <span class="string">"BOOT-INF/classes/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String BOOT_INF_LIB = <span class="string">"BOOT-INF/lib/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空的构造方法，没有分析的必要</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JarLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">JarLauncher</span><span class="params">(Archive archive)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(archive);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// jar文件规范：</span></span><br><span class="line">    <span class="comment">// 1、对于一个jar文件来说，被指定为Main-Class（入口）类的一个具体类，这个类连同它的包结构，</span></span><br><span class="line">    <span class="comment">// 一定是位于这个jar文件的顶层目录，而不能位于其他的目录里面</span></span><br><span class="line">    <span class="comment">// 2、jar文件是不能被嵌套的（不能在jar文件里面嵌套jar文件）</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 这就是整个isNestedArchive方法的判断执行的逻辑</span></span><br><span class="line">    <span class="comment">// entry指的是一个目录或一个jar文件，判断这个entry是目录或jar文件</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isNestedArchive</span><span class="params">(Archive.Entry entry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断给定的entry是目录</span></span><br><span class="line">		<span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">            <span class="comment">// entry的名称等于BOOT-INF/classes/就返回true</span></span><br><span class="line">			<span class="keyword">return</span> entry.getName().equals(BOOT_INF_CLASSES);</span><br><span class="line">		&#125; <span class="comment">// 不是目录，是一个文件，判断是不是以BOOT-INF/lib/开头的</span></span><br><span class="line">		<span class="keyword">return</span> entry.getName().startsWith(BOOT_INF_LIB);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 位于springboot_lecture-1.0\META-INF\MANIFEST.MF中内容如下：</span></span><br><span class="line">    <span class="comment">// Manifest-Version: 1.0</span></span><br><span class="line">	<span class="comment">// Start-Class: com.shengsiyuan.boot.MyApplication</span></span><br><span class="line">	<span class="comment">// Spring-Boot-Classes: BOOT-INF/classes/</span></span><br><span class="line">	<span class="comment">// Spring-Boot-Lib: BOOT-INF/lib/</span></span><br><span class="line">	<span class="comment">// Spring-Boot-Version: 2.2.5.RELEASE 版本</span></span><br><span class="line">	<span class="comment">// Main-Class: org.springframework.boot.loader.JarLauncher，这个类一定包含main方法，	 // 作为程序的入口</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 真正启动的入口，JarLauncher创建实例后，调用它的launch方法，将命令行参数传递进去，		// launch方法显然是调用父类Launcher类</span></span><br><span class="line">		<span class="keyword">new</span> JarLauncher().launch(args); </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、WarLauncher类详解"><a href="#4、WarLauncher类详解" class="headerlink" title="4、WarLauncher类详解"></a>4、WarLauncher类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.archive.Archive;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个针对于war的归档文件的启动器，这个启动器是针对于标准war的归档文件，支持依赖位于</span></span><br><span class="line"><span class="comment">// WEB-INF/lib目录下，同时还位于WEB-INF/lib-provided目录，然后类是位于WEB-INF/classes目录下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Launcher&#125; for WAR based archives. This launcher for standard WAR archives.</span></span><br><span class="line"><span class="comment"> * Supports dependencies in &#123;<span class="doctag">@code</span> WEB-INF/lib&#125; as well as &#123;<span class="doctag">@code</span> WEB-INF/lib-provided&#125;,</span></span><br><span class="line"><span class="comment"> * classes are loaded from &#123;<span class="doctag">@code</span> WEB-INF/classes&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WarLauncher</span> <span class="keyword">extends</span> <span class="title">ExecutableArchiveLauncher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF = <span class="string">"WEB-INF/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF_CLASSES = WEB_INF + <span class="string">"classes/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF_LIB = WEB_INF + <span class="string">"lib/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_INF_LIB_PROVIDED = WEB_INF + <span class="string">"lib-provided/"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">WarLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">WarLauncher</span><span class="params">(Archive archive)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(archive);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNestedArchive</span><span class="params">(Archive.Entry entry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">			<span class="keyword">return</span> entry.getName().equals(WEB_INF_CLASSES);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> entry.getName().startsWith(WEB_INF_LIB) || entry.getName().startsWith(WEB_INF_LIB_PROVIDED);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> WarLauncher().launch(args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、JarFile类详解"><a href="#5、JarFile类详解" class="headerlink" title="5、JarFile类详解"></a>5、JarFile类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader.jar;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandlerFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.data.RandomAccessData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.data.RandomAccessDataFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extended variant of &#123;<span class="doctag">@link</span> java.util.jar.JarFile&#125; that behaves in the same way but</span></span><br><span class="line"><span class="comment"> * offers the following additional functionality.</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;A nested &#123;<span class="doctag">@link</span> JarFile&#125; can be &#123;<span class="doctag">@link</span> #getNestedJarFile(ZipEntry) obtained&#125; based</span></span><br><span class="line"><span class="comment"> * on any directory entry.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;A nested &#123;<span class="doctag">@link</span> JarFile&#125; can be &#123;<span class="doctag">@link</span> #getNestedJarFile(ZipEntry) obtained&#125; for</span></span><br><span class="line"><span class="comment"> * embedded JAR files (as long as their entry is not compressed).&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JarFile</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">jar</span>.<span class="title">JarFile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MANIFEST_NAME = <span class="string">"META-INF/MANIFEST.MF"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROTOCOL_HANDLER = <span class="string">"java.protocol.handler.pkgs"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HANDLERS_PACKAGE = <span class="string">"org.springframework.boot.loader"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AsciiBytes META_INF = <span class="keyword">new</span> AsciiBytes(<span class="string">"META-INF/"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AsciiBytes SIGNATURE_FILE_EXTENSION = <span class="keyword">new</span> AsciiBytes(<span class="string">".SF"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RandomAccessDataFile rootFile;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String pathFromRoot;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RandomAccessData data;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> JarFileType type;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> URL url;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String urlString;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> JarFileEntries entries;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Supplier&lt;Manifest&gt; manifestSupplier;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SoftReference&lt;Manifest&gt; manifest;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> signed;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String comment;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> JarFile&#125; backed by the specified file.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> file the root jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JarFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(<span class="keyword">new</span> RandomAccessDataFile(file));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> JarFile&#125; backed by the specified file.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> file the root jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	JarFile(RandomAccessDataFile file) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="keyword">this</span>(file, <span class="string">""</span>, file, JarFileType.DIRECT);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Private constructor used to create a new &#123;<span class="doctag">@link</span> JarFile&#125; either directly or from a</span></span><br><span class="line"><span class="comment">	 * nested entry.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> rootFile the root jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> pathFromRoot the name of this file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> data the underlying data</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> type the type of the jar file</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">JarFile</span><span class="params">(RandomAccessDataFile rootFile, String pathFromRoot, RandomAccessData data, JarFileType type)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(rootFile, pathFromRoot, data, <span class="keyword">null</span>, type, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">JarFile</span><span class="params">(RandomAccessDataFile rootFile, String pathFromRoot, RandomAccessData data, JarEntryFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">			JarFileType type, Supplier&lt;Manifest&gt; manifestSupplier)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(rootFile.getFile());</span><br><span class="line">		<span class="keyword">this</span>.rootFile = rootFile;</span><br><span class="line">		<span class="keyword">this</span>.pathFromRoot = pathFromRoot;</span><br><span class="line">		CentralDirectoryParser parser = <span class="keyword">new</span> CentralDirectoryParser();</span><br><span class="line">		<span class="keyword">this</span>.entries = parser.addVisitor(<span class="keyword">new</span> JarFileEntries(<span class="keyword">this</span>, filter));</span><br><span class="line">		<span class="keyword">this</span>.type = type;</span><br><span class="line">		parser.addVisitor(centralDirectoryVisitor());</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.data = parser.parse(data, filter == <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.manifestSupplier = (manifestSupplier != <span class="keyword">null</span>) ? manifestSupplier : () -&gt; &#123;</span><br><span class="line">			<span class="keyword">try</span> (InputStream inputStream = getInputStream(MANIFEST_NAME)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> Manifest(inputStream);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> CentralDirectoryVisitor <span class="title">centralDirectoryVisitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> CentralDirectoryVisitor() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitStart</span><span class="params">(CentralDirectoryEndRecord endRecord, RandomAccessData centralDirectoryData)</span> </span>&#123;</span><br><span class="line">				JarFile.<span class="keyword">this</span>.comment = endRecord.getComment();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFileHeader</span><span class="params">(CentralDirectoryFileHeader fileHeader, <span class="keyword">int</span> dataOffset)</span> </span>&#123;</span><br><span class="line">				AsciiBytes name = fileHeader.getName();</span><br><span class="line">				<span class="keyword">if</span> (name.startsWith(META_INF) &amp;&amp; name.endsWith(SIGNATURE_FILE_EXTENSION)) &#123;</span><br><span class="line">					JarFile.<span class="keyword">this</span>.signed = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> RandomAccessDataFile <span class="title">getRootJarFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.rootFile;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">RandomAccessData <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Manifest <span class="title">getManifest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		Manifest manifest = (<span class="keyword">this</span>.manifest != <span class="keyword">null</span>) ? <span class="keyword">this</span>.manifest.get() : <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (manifest == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				manifest = <span class="keyword">this</span>.manifestSupplier.get();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IOException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.manifest = <span class="keyword">new</span> SoftReference&lt;&gt;(manifest);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> manifest;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Enumeration&lt;java.util.jar.JarEntry&gt; entries() &#123;</span><br><span class="line">		<span class="keyword">final</span> Iterator&lt;JarEntry&gt; iterator = <span class="keyword">this</span>.entries.iterator();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Enumeration&lt;java.util.jar.JarEntry&gt;() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> iterator.hasNext();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> java.util.jar.<span class="function">JarEntry <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> iterator.next();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JarEntry <span class="title">getJarEntry</span><span class="params">(CharSequence name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JarEntry <span class="title">getJarEntry</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (JarEntry) getEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsEntry</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.containsEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ZipEntry <span class="title">getEntry</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getEntry(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> InputStream <span class="title">getInputStream</span><span class="params">(ZipEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> JarEntry) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.entries.getInputStream((JarEntry) entry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getInputStream((entry != <span class="keyword">null</span>) ? entry.getName() : <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InputStream <span class="title">getInputStream</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getInputStream(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a nested &#123;<span class="doctag">@link</span> JarFile&#125; loaded from the specified entry.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> entry the zip entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> JarFile&#125; for the entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the nested jar file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> JarFile <span class="title">getNestedJarFile</span><span class="params">(ZipEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getNestedJarFile((JarEntry) entry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a nested &#123;<span class="doctag">@link</span> JarFile&#125; loaded from the specified entry.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> entry the zip entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> JarFile&#125; for the entry</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the nested jar file cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> JarFile <span class="title">getNestedJarFile</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> createJarFileFromEntry(entry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unable to open nested jar file '"</span> + entry.getName() + <span class="string">"'"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> JarFile <span class="title">createJarFileFromEntry</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">			<span class="keyword">return</span> createJarFileFromDirectoryEntry(entry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> createJarFileFromFileEntry(entry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> JarFile <span class="title">createJarFileFromDirectoryEntry</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		AsciiBytes name = entry.getAsciiBytesName();</span><br><span class="line">		JarEntryFilter filter = (candidate) -&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span> (candidate.startsWith(name) &amp;&amp; !candidate.equals(name)) &#123;</span><br><span class="line">				<span class="keyword">return</span> candidate.substring(name.length());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JarFile(<span class="keyword">this</span>.rootFile, <span class="keyword">this</span>.pathFromRoot + <span class="string">"!/"</span> + entry.getName().substring(<span class="number">0</span>, name.length() - <span class="number">1</span>),</span><br><span class="line">				<span class="keyword">this</span>.data, filter, JarFileType.NESTED_DIRECTORY, <span class="keyword">this</span>.manifestSupplier);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> JarFile <span class="title">createJarFileFromFileEntry</span><span class="params">(JarEntry entry)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry.getMethod() != ZipEntry.STORED) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">					<span class="string">"Unable to open nested entry '"</span> + entry.getName() + <span class="string">"'. It has been compressed and nested "</span></span><br><span class="line">							+ <span class="string">"jar files must be stored without compression. Please check the "</span></span><br><span class="line">							+ <span class="string">"mechanism used to create your executable jar file"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		RandomAccessData entryData = <span class="keyword">this</span>.entries.getEntryData(entry.getName());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JarFile(<span class="keyword">this</span>.rootFile, <span class="keyword">this</span>.pathFromRoot + <span class="string">"!/"</span> + entry.getName(), entryData,</span><br><span class="line">				JarFileType.NESTED_JAR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getComment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.comment;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.entries.getSize();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.close();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.type == JarFileType.DIRECT) &#123;</span><br><span class="line">			<span class="keyword">this</span>.rootFile.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getUrlString</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.urlString == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.urlString = getUrl().toString();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.urlString;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return a URL that can be used to access this JAR file. <span class="doctag">NOTE:</span> the specified URL</span></span><br><span class="line"><span class="comment">	 * cannot be serialized and or cloned.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the URL</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> MalformedURLException if the URL is malformed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> URL <span class="title">getUrl</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.url == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Handler handler = <span class="keyword">new</span> Handler(<span class="keyword">this</span>);</span><br><span class="line">			String file = <span class="keyword">this</span>.rootFile.getFile().toURI() + <span class="keyword">this</span>.pathFromRoot + <span class="string">"!/"</span>;</span><br><span class="line">			file = file.replace(<span class="string">"file:////"</span>, <span class="string">"file://"</span>); <span class="comment">// Fix UNC paths</span></span><br><span class="line">			<span class="keyword">this</span>.url = <span class="keyword">new</span> URL(<span class="string">"jar"</span>, <span class="string">""</span>, -<span class="number">1</span>, file, handler);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.url;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getName();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.rootFile.getFile() + <span class="keyword">this</span>.pathFromRoot;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isSigned</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.signed;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setupEntryCertificates</span><span class="params">(JarEntry entry)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Fallback to JarInputStream to obtain certificates, not fast but hopefully not</span></span><br><span class="line">		<span class="comment">// happening that often.</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> (JarInputStream inputStream = <span class="keyword">new</span> JarInputStream(getData().getInputStream())) &#123;</span><br><span class="line">				java.util.jar.JarEntry certEntry = inputStream.getNextJarEntry();</span><br><span class="line">				<span class="keyword">while</span> (certEntry != <span class="keyword">null</span>) &#123;</span><br><span class="line">					inputStream.closeEntry();</span><br><span class="line">					<span class="keyword">if</span> (entry.getName().equals(certEntry.getName())) &#123;</span><br><span class="line">						setCertificates(entry, certEntry);</span><br><span class="line">					&#125;</span><br><span class="line">					setCertificates(getJarEntry(certEntry.getName()), certEntry);</span><br><span class="line">					certEntry = inputStream.getNextJarEntry();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCertificates</span><span class="params">(JarEntry entry, java.util.jar.JarEntry certEntry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">			entry.setCertificates(certEntry);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.entries.clearCache();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">getPathFromRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.pathFromRoot;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">JarFileType <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册一个java.protocol.handler.pkgs属性这样URLStreamHandler就可以被定位处理jar文件</span></span><br><span class="line">    <span class="comment">// 的url</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Register a &#123;<span class="doctag">@literal</span> 'java.protocol.handler.pkgs'&#125; property so that a</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> URLStreamHandler&#125; will be located to deal with jar URLs.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerUrlProtocolHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String handlers = System.getProperty(PROTOCOL_HANDLER, <span class="string">""</span>);</span><br><span class="line">		System.setProperty(PROTOCOL_HANDLER,</span><br><span class="line">				(<span class="string">""</span>.equals(handlers) ? HANDLERS_PACKAGE : handlers + <span class="string">"|"</span> + HANDLERS_PACKAGE));</span><br><span class="line">		resetCachedUrlHandlers();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Reset any cached handlers just in case a jar protocol has already been used. We</span></span><br><span class="line"><span class="comment">	 * reset the handler by trying to set a null &#123;<span class="doctag">@link</span> URLStreamHandlerFactory&#125; which</span></span><br><span class="line"><span class="comment">	 * should have no effect other than clearing the handlers cache.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resetCachedUrlHandlers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			URL.setURLStreamHandlerFactory(<span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Error ex) &#123;</span><br><span class="line">			<span class="comment">// Ignore</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The type of a &#123;<span class="doctag">@link</span> JarFile&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">enum</span> JarFileType &#123;</span><br><span class="line"></span><br><span class="line">		DIRECT, NESTED_DIRECTORY, NESTED_JAR</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、Archive类详解"><a href="#6、Archive类详解" class="headerlink" title="6、Archive类详解"></a>6、Archive类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader.archive;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.Launcher;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An archive that can be launched by the &#123;<span class="doctag">@link</span> Launcher&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> JarFileArchive</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Archive</span> <span class="keyword">extends</span> <span class="title">Iterable</span>&lt;<span class="title">Archive</span>.<span class="title">Entry</span>&gt;, <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a URL that can be used to load the archive.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the archive URL</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> MalformedURLException if the URL is malformed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">URL <span class="title">getUrl</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the manifest of the archive.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the manifest</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the manifest cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">Manifest <span class="title">getManifest</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回与所指定的过滤器相匹配的归档文件，具体的实现</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns nested &#123;<span class="doctag">@link</span> Archive&#125;s for entries that match the specified filter.</span></span><br><span class="line"><span class="comment">	 // 用于限制entries的过滤器</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> filter the filter used to limit entries </span></span><br><span class="line"><span class="comment">	 // 返回被嵌套的归档文件</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> nested archives </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if nested archives cannot be read</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">List&lt;Archive&gt; <span class="title">getNestedArchives</span><span class="params">(EntryFilter filter)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Closes the &#123;<span class="doctag">@code</span> Archive&#125;, releasing any open resources.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception if an error occurs during close processing</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.2.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Represents a single entry in the archive.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">interface</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Returns &#123;<span class="doctag">@code</span> true&#125; if the entry represents a directory.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@return</span> if the entry is a directory</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function"><span class="keyword">boolean</span> <span class="title">isDirectory</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Returns the name of the entry.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@return</span> the name of the entry</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Strategy interface to filter &#123;<span class="doctag">@link</span> Entry Entries&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">interface</span> <span class="title">EntryFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Apply the jar entry filter.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> entry the entry to filter</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the filter matches</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Entry entry)</span></span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7、JarFileArchive类重要方法详解"><a href="#7、JarFileArchive类重要方法详解" class="headerlink" title="7、JarFileArchive类重要方法详解"></a>7、JarFileArchive类重要方法详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入一个过滤器，这个过滤器是一个EntryFilter类型的</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Archive&gt; <span class="title">getNestedArchives</span><span class="params">(EntryFilter filter)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	List&lt;Archive&gt; nestedArchives = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	<span class="keyword">for</span> (Entry entry : <span class="keyword">this</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (filter.matches(entry)) &#123;</span><br><span class="line">			nestedArchives.add(getNestedArchive(entry));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Collections.unmodifiableList(nestedArchives);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8、LaunchedURLClassLoader类详解"><a href="#8、LaunchedURLClassLoader类详解" class="headerlink" title="8、LaunchedURLClassLoader类详解"></a>8、LaunchedURLClassLoader类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.JarURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.security.AccessController;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivilegedExceptionAction;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.loader.jar.Handler;</span><br><span class="line"><span class="comment">// 类加载器于被Launcher所使用，它的父类是URLClassLoader</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ClassLoader&#125; used by the &#123;<span class="doctag">@link</span> Launcher&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LaunchedURLClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		ClassLoader.registerAsParallelCapable();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 创建一个新的LaunchedURLClassLoader的实例</span></span><br><span class="line">    <span class="comment">// 第一个参数：urls指定好绝对路径从什么地方加载类和资源</span></span><br><span class="line">    <span class="comment">// 第二个参数：parent父类加载器用于委托</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> LaunchedURLClassLoader&#125; instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LaunchedURLClassLoader</span><span class="params">(URL[] urls, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(urls, parent);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> URL <span class="title">findResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">super</span>.findResource(name);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> UseFastConnectionExceptionsEnumeration(<span class="keyword">super</span>.findResources(name));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">		Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				definePackageIfNecessary(name);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">				<span class="comment">// Tolerate race condition due to being parallel capable</span></span><br><span class="line">				<span class="keyword">if</span> (getPackage(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">// This should never happen as the IllegalArgumentException indicates</span></span><br><span class="line">					<span class="comment">// that the package has already been defined and, therefore,</span></span><br><span class="line">					<span class="comment">// getPackage(name) should not return null.</span></span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Package "</span> + name + <span class="string">" has already been defined but it could not be found"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name, resolve);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Define a package before a &#123;<span class="doctag">@code</span> findClass&#125; call is made. This is necessary to</span></span><br><span class="line"><span class="comment">	 * ensure that the appropriate manifest for nested JARs is associated with the</span></span><br><span class="line"><span class="comment">	 * package.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> className the class name being found</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">definePackageIfNecessary</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> lastDot = className.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">		<span class="keyword">if</span> (lastDot &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			String packageName = className.substring(<span class="number">0</span>, lastDot);</span><br><span class="line">			<span class="keyword">if</span> (getPackage(packageName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					definePackage(className, packageName);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">					<span class="comment">// Tolerate race condition due to being parallel capable</span></span><br><span class="line">					<span class="keyword">if</span> (getPackage(packageName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="comment">// This should never happen as the IllegalArgumentException</span></span><br><span class="line">						<span class="comment">// indicates that the package has already been defined and,</span></span><br><span class="line">						<span class="comment">// therefore, getPackage(name) should not have returned null.</span></span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(</span><br><span class="line">								<span class="string">"Package "</span> + packageName + <span class="string">" has already been defined but it could not be found"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">definePackage</span><span class="params">(String className, String packageName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">				String packageEntryName = packageName.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">"/"</span>;</span><br><span class="line">				String classEntryName = className.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">".class"</span>;</span><br><span class="line">				<span class="keyword">for</span> (URL url : getURLs()) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						URLConnection connection = url.openConnection();</span><br><span class="line">						<span class="keyword">if</span> (connection <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">							JarFile jarFile = ((JarURLConnection) connection).getJarFile();</span><br><span class="line">							<span class="keyword">if</span> (jarFile.getEntry(classEntryName) != <span class="keyword">null</span> &amp;&amp; jarFile.getEntry(packageEntryName) != <span class="keyword">null</span></span><br><span class="line">									&amp;&amp; jarFile.getManifest() != <span class="keyword">null</span>) &#123;</span><br><span class="line">								definePackage(packageName, jarFile.getManifest(), url);</span><br><span class="line">								<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">						<span class="comment">// Ignore</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;, AccessController.getContext());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (java.security.PrivilegedActionException ex) &#123;</span><br><span class="line">			<span class="comment">// Ignore</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Clear URL caches.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (URL url : getURLs()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				URLConnection connection = url.openConnection();</span><br><span class="line">				<span class="keyword">if</span> (connection <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">					clearCache(connection);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">				<span class="comment">// Ignore</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">(URLConnection connection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		Object jarFile = ((JarURLConnection) connection).getJarFile();</span><br><span class="line">		<span class="keyword">if</span> (jarFile <span class="keyword">instanceof</span> org.springframework.boot.loader.jar.JarFile) &#123;</span><br><span class="line">			((org.springframework.boot.loader.jar.JarFile) jarFile).clearCache();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UseFastConnectionExceptionsEnumeration</span> <span class="keyword">implements</span> <span class="title">Enumeration</span>&lt;<span class="title">URL</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Enumeration&lt;URL&gt; delegate;</span><br><span class="line"></span><br><span class="line">		UseFastConnectionExceptionsEnumeration(Enumeration&lt;URL&gt; delegate) &#123;</span><br><span class="line">			<span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>.delegate.hasMoreElements();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> URL <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			Handler.setUseFastConnectionExceptions(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>.delegate.nextElement();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				Handler.setUseFastConnectionExceptions(<span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9、URLClassLoader类详解"><a href="#9、URLClassLoader类详解" class="headerlink" title="9、URLClassLoader类详解"></a>9、URLClassLoader类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Closeable;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FilePermission;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.AccessControlContext;</span><br><span class="line"><span class="keyword">import</span> java.security.AccessController;</span><br><span class="line"><span class="keyword">import</span> java.security.CodeSigner;</span><br><span class="line"><span class="keyword">import</span> java.security.CodeSource;</span><br><span class="line"><span class="keyword">import</span> java.security.Permission;</span><br><span class="line"><span class="keyword">import</span> java.security.PermissionCollection;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivilegedAction;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivilegedExceptionAction;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.NoSuchElementException;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.WeakHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Attributes;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Attributes.Name;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.Manifest;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Resource;</span><br><span class="line"><span class="keyword">import</span> sun.misc.URLClassPath;</span><br><span class="line"><span class="keyword">import</span> sun.net.www.ParseUtil;</span><br><span class="line"><span class="keyword">import</span> sun.security.util.SecurityConstants;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个类加载器用于加载类和资源，从一个url搜索路径指向jar文件或目录。任何url只要以/结尾的</span></span><br><span class="line"><span class="comment">// 都会被指定引用的目录，否则这个url就会被认为指向的是jar文件，根据需要被打开</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class loader is used to load classes and resources from a search</span></span><br><span class="line"><span class="comment"> * path of URLs referring to both JAR files and directories. Any URL that</span></span><br><span class="line"><span class="comment"> * ends with a '/' is assumed to refer to a directory. Otherwise, the URL</span></span><br><span class="line"><span class="comment"> * is assumed to refer to a JAR file which will be opened as needed.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The AccessControlContext of the thread that created the instance of</span></span><br><span class="line"><span class="comment"> * URLClassLoader will be used when subsequently loading classes and</span></span><br><span class="line"><span class="comment"> * resources.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The classes that are loaded are by default granted permission only to</span></span><br><span class="line"><span class="comment"> * access the URLs specified when the URLClassLoader was created.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  David Connelly</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>   1.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLClassLoader</span> <span class="keyword">extends</span> <span class="title">SecureClassLoader</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* The search path for classes and resources */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URLClassPath ucp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The context to be used when loading classes and resources */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessControlContext acc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new URLClassLoader for the given URLs. The URLs will be</span></span><br><span class="line"><span class="comment">     * searched in the order specified for classes and resources after first</span></span><br><span class="line"><span class="comment">     * searching in the specified parent class loader. Any URL that ends with</span></span><br><span class="line"><span class="comment">     * a '/' is assumed to refer to a directory. Otherwise, the URL is assumed</span></span><br><span class="line"><span class="comment">     * to refer to a JAR file which will be downloaded and opened as needed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If there is a security manager, this method first</span></span><br><span class="line"><span class="comment">     * calls the security manager's &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method</span></span><br><span class="line"><span class="comment">     * to ensure creation of a class loader is allowed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  SecurityException  if a security manager exists and its</span></span><br><span class="line"><span class="comment">     *             &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method doesn't allow</span></span><br><span class="line"><span class="comment">     *             creation of a class loader.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SecurityManager#checkCreateClassLoader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    URLClassLoader(URL[] urls, ClassLoader parent,</span><br><span class="line">                   AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = acc;</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new URLClassLoader for the specified URLs using the</span></span><br><span class="line"><span class="comment">     * default delegation parent &#123;<span class="doctag">@code</span> ClassLoader&#125;. The URLs will</span></span><br><span class="line"><span class="comment">     * be searched in the order specified for classes and resources after</span></span><br><span class="line"><span class="comment">     * first searching in the parent class loader. Any URL that ends with</span></span><br><span class="line"><span class="comment">     * a '/' is assumed to refer to a directory. Otherwise, the URL is</span></span><br><span class="line"><span class="comment">     * assumed to refer to a JAR file which will be downloaded and opened</span></span><br><span class="line"><span class="comment">     * as needed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If there is a security manager, this method first</span></span><br><span class="line"><span class="comment">     * calls the security manager's &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method</span></span><br><span class="line"><span class="comment">     * to ensure creation of a class loader is allowed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  SecurityException  if a security manager exists and its</span></span><br><span class="line"><span class="comment">     *             &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method doesn't allow</span></span><br><span class="line"><span class="comment">     *             creation of a class loader.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SecurityManager#checkCreateClassLoader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    URLClassLoader(URL[] urls, AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = acc;</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new URLClassLoader for the specified URLs, parent</span></span><br><span class="line"><span class="comment">     * class loader, and URLStreamHandlerFactory. The parent argument</span></span><br><span class="line"><span class="comment">     * will be used as the parent class loader for delegation. The</span></span><br><span class="line"><span class="comment">     * factory argument will be used as the stream handler factory to</span></span><br><span class="line"><span class="comment">     * obtain protocol handlers when creating new jar URLs.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If there is a security manager, this method first</span></span><br><span class="line"><span class="comment">     * calls the security manager's &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method</span></span><br><span class="line"><span class="comment">     * to ensure creation of a class loader is allowed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs from which to load classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> factory the URLStreamHandlerFactory to use when creating URLs</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  SecurityException  if a security manager exists and its</span></span><br><span class="line"><span class="comment">     *             &#123;<span class="doctag">@code</span> checkCreateClassLoader&#125; method doesn't allow</span></span><br><span class="line"><span class="comment">     *             creation of a class loader.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SecurityManager#checkCreateClassLoader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls, ClassLoader parent,</span></span></span><br><span class="line"><span class="function"><span class="params">                          URLStreamHandlerFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, factory, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* A map (used as a set) to keep track of closeable local resources</span></span><br><span class="line"><span class="comment">     * (either JarFiles or FileInputStreams). We don't care about</span></span><br><span class="line"><span class="comment">     * Http resources since they don't need to be closed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If the resource is coming from a jar file</span></span><br><span class="line"><span class="comment">     * we keep a (weak) reference to the JarFile object which can</span></span><br><span class="line"><span class="comment">     * be closed if URLClassLoader.close() called. Due to jar file</span></span><br><span class="line"><span class="comment">     * caching there will typically be only one JarFile object</span></span><br><span class="line"><span class="comment">     * per underlying jar file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * For file resources, which is probably a less common situation</span></span><br><span class="line"><span class="comment">     * we have to keep a weak reference to each stream.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WeakHashMap&lt;Closeable,Void&gt;</span><br><span class="line">        closeables = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an input stream for reading the specified resource.</span></span><br><span class="line"><span class="comment">     * If this loader is closed, then any resources opened by this method</span></span><br><span class="line"><span class="comment">     * will be closed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; The search order is described in the documentation for &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * #getResource(String)&#125;.  &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  name</span></span><br><span class="line"><span class="comment">     *         The resource name</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  An input stream for reading the resource, or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">     *          if the resource could not be found</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span>  1.7</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getResourceAsStream</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        URL url = getResource(name);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            URLConnection urlc = url.openConnection();</span><br><span class="line">            InputStream is = urlc.getInputStream();</span><br><span class="line">            <span class="keyword">if</span> (urlc <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">                JarURLConnection juc = (JarURLConnection)urlc;</span><br><span class="line">                JarFile jar = juc.getJarFile();</span><br><span class="line">                <span class="keyword">synchronized</span> (closeables) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!closeables.containsKey(jar)) &#123;</span><br><span class="line">                        closeables.put(jar, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (urlc <span class="keyword">instanceof</span> sun.net.www.protocol.file.FileURLConnection) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (closeables) &#123;</span><br><span class="line">                    closeables.put(is, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> is;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Closes this URLClassLoader, so that it can no longer be used to load</span></span><br><span class="line"><span class="comment">    * new classes or resources that are defined by this loader.</span></span><br><span class="line"><span class="comment">    * Classes and resources defined by any of this loader's parents in the</span></span><br><span class="line"><span class="comment">    * delegation hierarchy are still accessible. Also, any classes or resources</span></span><br><span class="line"><span class="comment">    * that are already loaded, are still accessible.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * In the case of jar: and file: URLs, it also closes any files</span></span><br><span class="line"><span class="comment">    * that were opened by it. If another thread is loading a</span></span><br><span class="line"><span class="comment">    * class when the &#123;<span class="doctag">@code</span> close&#125; method is invoked, then the result of</span></span><br><span class="line"><span class="comment">    * that load is undefined.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * The method makes a best effort attempt to close all opened files,</span></span><br><span class="line"><span class="comment">    * by catching &#123;<span class="doctag">@link</span> IOException&#125;s internally. Unchecked exceptions</span></span><br><span class="line"><span class="comment">    * and errors are not caught. Calling close on an already closed</span></span><br><span class="line"><span class="comment">    * loader has no effect.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@exception</span> IOException if closing any file opened by this class loader</span></span><br><span class="line"><span class="comment">    * resulted in an IOException. Any such exceptions are caught internally.</span></span><br><span class="line"><span class="comment">    * If only one is caught, then it is re-thrown. If more than one exception</span></span><br><span class="line"><span class="comment">    * is caught, then the second and following exceptions are added</span></span><br><span class="line"><span class="comment">    * as suppressed exceptions of the first one caught, which is then re-thrown.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@exception</span> SecurityException if a security manager is set, and it denies</span></span><br><span class="line"><span class="comment">    *   &#123;<span class="doctag">@link</span> RuntimePermission&#125;&#123;<span class="doctag">@code</span> ("closeClassLoader")&#125;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@since</span> 1.7</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkPermission(<span class="keyword">new</span> RuntimePermission(<span class="string">"closeClassLoader"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;IOException&gt; errors = ucp.closeLoaders();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// now close any remaining streams.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (closeables) &#123;</span><br><span class="line">            Set&lt;Closeable&gt; keys = closeables.keySet();</span><br><span class="line">            <span class="keyword">for</span> (Closeable c : keys) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    c.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioex) &#123;</span><br><span class="line">                    errors.add(ioex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            closeables.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (errors.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        IOException firstex = errors.remove(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Suppress any remaining exceptions</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (IOException error: errors) &#123;</span><br><span class="line">            firstex.addSuppressed(error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> firstex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Appends the specified URL to the list of URLs to search for</span></span><br><span class="line"><span class="comment">     * classes and resources.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the URL specified is &#123;<span class="doctag">@code</span> null&#125; or is already in the</span></span><br><span class="line"><span class="comment">     * list of URLs, or if this loader is closed, then invoking this</span></span><br><span class="line"><span class="comment">     * method has no effect.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url the URL to be added to the search path of URLs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addURL</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">        ucp.addURL(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the search path of URLs for loading classes and resources.</span></span><br><span class="line"><span class="comment">     * This includes the original list of URLs specified to the constructor,</span></span><br><span class="line"><span class="comment">     * along with any URLs subsequently appended by the addURL() method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the search path of URLs for loading classes and resources.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> URL[] getURLs() &#123;</span><br><span class="line">        <span class="keyword">return</span> ucp.getURLs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds and loads the class with the specified name from the URL search</span></span><br><span class="line"><span class="comment">     * path. Any URLs referring to JAR files are loaded and opened as needed</span></span><br><span class="line"><span class="comment">     * until the class is found.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the resulting class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> ClassNotFoundException if the class could not be found,</span></span><br><span class="line"><span class="comment">     *            or if the loader is closed.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> NullPointerException if &#123;<span class="doctag">@code</span> name&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(<span class="keyword">final</span> String name)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> PrivilegedExceptionAction&lt;Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">                    <span class="keyword">public</span> Class&lt;?&gt; run() <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">".class"</span>);</span><br><span class="line">                        Resource res = ucp.getResource(path, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (res != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> defineClass(name, res);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException pae) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (ClassNotFoundException) pae.getException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Retrieve the package using the specified package name.</span></span><br><span class="line"><span class="comment">     * If non-null, verify the package using the specified code</span></span><br><span class="line"><span class="comment">     * source and manifest.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Package <span class="title">getAndVerifyPackage</span><span class="params">(String pkgname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Manifest man, URL url)</span> </span>&#123;</span><br><span class="line">        Package pkg = getPackage(pkgname);</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Package found, so check package sealing.</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.isSealed()) &#123;</span><br><span class="line">                <span class="comment">// Verify that code source URL is the same.</span></span><br><span class="line">                <span class="keyword">if</span> (!pkg.isSealed(url)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"sealing violation: package "</span> + pkgname + <span class="string">" is sealed"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Make sure we are not attempting to seal the package</span></span><br><span class="line">                <span class="comment">// at this code source URL.</span></span><br><span class="line">                <span class="keyword">if</span> ((man != <span class="keyword">null</span>) &amp;&amp; isSealed(pkgname, man)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"sealing violation: can't seal package "</span> + pkgname +</span><br><span class="line">                        <span class="string">": already loaded"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Also called by VM to define Package for classes loaded from the CDS</span></span><br><span class="line">    <span class="comment">// archive</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">definePackageInternal</span><span class="params">(String pkgname, Manifest man, URL url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getAndVerifyPackage(pkgname, man, url) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (man != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    definePackage(pkgname, man, url);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    definePackage(pkgname, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException iae) &#123;</span><br><span class="line">                <span class="comment">// parallel-capable class loaders: re-verify in case of a</span></span><br><span class="line">                <span class="comment">// race condition</span></span><br><span class="line">                <span class="keyword">if</span> (getAndVerifyPackage(pkgname, man, url) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Should never happen</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Cannot find package "</span> +</span><br><span class="line">                                             pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Defines a Class using the class bytes obtained from the specified</span></span><br><span class="line"><span class="comment">     * Resource. The resulting Class must be resolved before it can be</span></span><br><span class="line"><span class="comment">     * used.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; defineClass(String name, Resource res) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">        <span class="keyword">int</span> i = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">        URL url = res.getCodeSourceURL();</span><br><span class="line">        <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">            String pkgname = name.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="comment">// Check if package already loaded.</span></span><br><span class="line">            Manifest man = res.getManifest();</span><br><span class="line">            definePackageInternal(pkgname, man, url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Now read the class bytes and define the class</span></span><br><span class="line">        java.nio.ByteBuffer bb = res.getByteBuffer();</span><br><span class="line">        <span class="keyword">if</span> (bb != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Use (direct) ByteBuffer:</span></span><br><span class="line">            CodeSigner[] signers = res.getCodeSigners();</span><br><span class="line">            CodeSource cs = <span class="keyword">new</span> CodeSource(url, signers);</span><br><span class="line">            sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, bb, cs);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] b = res.getBytes();</span><br><span class="line">            <span class="comment">// must read certificates AFTER reading bytes.</span></span><br><span class="line">            CodeSigner[] signers = res.getCodeSigners();</span><br><span class="line">            CodeSource cs = <span class="keyword">new</span> CodeSource(url, signers);</span><br><span class="line">            sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length, cs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Defines a new package by name in this ClassLoader. The attributes</span></span><br><span class="line"><span class="comment">     * contained in the specified Manifest will be used to obtain package</span></span><br><span class="line"><span class="comment">     * version and sealing information. For sealed packages, the additional</span></span><br><span class="line"><span class="comment">     * URL specifies the code source URL from which the package was loaded.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name  the package name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> man   the Manifest containing package version and sealing</span></span><br><span class="line"><span class="comment">     *              information</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url   the code source url for the package, or null if none</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>   IllegalArgumentException if the package name duplicates</span></span><br><span class="line"><span class="comment">     *              an existing package either in this class loader or one</span></span><br><span class="line"><span class="comment">     *              of its ancestors</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the newly defined Package object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Package <span class="title">definePackage</span><span class="params">(String name, Manifest man, URL url)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">"/"</span>);</span><br><span class="line">        String specTitle = <span class="keyword">null</span>, specVersion = <span class="keyword">null</span>, specVendor = <span class="keyword">null</span>;</span><br><span class="line">        String implTitle = <span class="keyword">null</span>, implVersion = <span class="keyword">null</span>, implVendor = <span class="keyword">null</span>;</span><br><span class="line">        String sealed = <span class="keyword">null</span>;</span><br><span class="line">        URL sealBase = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        Attributes attr = man.getAttributes(path);</span><br><span class="line">        <span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            specTitle   = attr.getValue(Name.SPECIFICATION_TITLE);</span><br><span class="line">            specVersion = attr.getValue(Name.SPECIFICATION_VERSION);</span><br><span class="line">            specVendor  = attr.getValue(Name.SPECIFICATION_VENDOR);</span><br><span class="line">            implTitle   = attr.getValue(Name.IMPLEMENTATION_TITLE);</span><br><span class="line">            implVersion = attr.getValue(Name.IMPLEMENTATION_VERSION);</span><br><span class="line">            implVendor  = attr.getValue(Name.IMPLEMENTATION_VENDOR);</span><br><span class="line">            sealed      = attr.getValue(Name.SEALED);</span><br><span class="line">        &#125;</span><br><span class="line">        attr = man.getMainAttributes();</span><br><span class="line">        <span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (specTitle == <span class="keyword">null</span>) &#123;</span><br><span class="line">                specTitle = attr.getValue(Name.SPECIFICATION_TITLE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (specVersion == <span class="keyword">null</span>) &#123;</span><br><span class="line">                specVersion = attr.getValue(Name.SPECIFICATION_VERSION);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (specVendor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                specVendor = attr.getValue(Name.SPECIFICATION_VENDOR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (implTitle == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implTitle = attr.getValue(Name.IMPLEMENTATION_TITLE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (implVersion == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implVersion = attr.getValue(Name.IMPLEMENTATION_VERSION);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (implVendor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implVendor = attr.getValue(Name.IMPLEMENTATION_VENDOR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sealed == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sealed = attr.getValue(Name.SEALED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"true"</span>.equalsIgnoreCase(sealed)) &#123;</span><br><span class="line">            sealBase = url;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> definePackage(name, specTitle, specVersion, specVendor,</span><br><span class="line">                             implTitle, implVersion, implVendor, sealBase);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Returns true if the specified package name is sealed according to the</span></span><br><span class="line"><span class="comment">     * given manifest.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSealed</span><span class="params">(String name, Manifest man)</span> </span>&#123;</span><br><span class="line">        String path = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">"/"</span>);</span><br><span class="line">        Attributes attr = man.getAttributes(path);</span><br><span class="line">        String sealed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sealed = attr.getValue(Name.SEALED);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sealed == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((attr = man.getMainAttributes()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sealed = attr.getValue(Name.SEALED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"true"</span>.equalsIgnoreCase(sealed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds the resource with the specified name on the URL search path.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the resource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> URL&#125; for the resource, or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">     * if the resource could not be found, or if the loader is closed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">findResource</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The same restriction to finding classes applies to resources</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        URL url = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;URL&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URL <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> ucp.findResource(name, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, acc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> url != <span class="keyword">null</span> ? ucp.checkURL(url) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an Enumeration of URLs representing all of the resources</span></span><br><span class="line"><span class="comment">     * on the URL search path having the specified name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the resource name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> IOException if an I/O exception occurs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an &#123;<span class="doctag">@code</span> Enumeration&#125; of &#123;<span class="doctag">@code</span> URL&#125;s</span></span><br><span class="line"><span class="comment">     *         If the loader is closed, the Enumeration will be empty.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(<span class="keyword">final</span> String name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Enumeration&lt;URL&gt; e = ucp.findResources(name, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Enumeration&lt;URL&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> URL url = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    URL u = AccessController.doPrivileged(</span><br><span class="line">                        <span class="keyword">new</span> PrivilegedAction&lt;URL&gt;() &#123;</span><br><span class="line">                            <span class="function"><span class="keyword">public</span> URL <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span> (!e.hasMoreElements())</span><br><span class="line">                                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                                <span class="keyword">return</span> e.nextElement();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, acc);</span><br><span class="line">                    <span class="keyword">if</span> (u == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    url = ucp.checkURL(u);</span><br><span class="line">                &#125; <span class="keyword">while</span> (url == <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">return</span> url != <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> URL <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!next()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">                &#125;</span><br><span class="line">                URL u = url;</span><br><span class="line">                url = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> u;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the permissions for the given codesource object.</span></span><br><span class="line"><span class="comment">     * The implementation of this method first calls super.getPermissions</span></span><br><span class="line"><span class="comment">     * and then adds permissions based on the URL of the codesource.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the protocol of this URL is "jar", then the permission granted</span></span><br><span class="line"><span class="comment">     * is based on the permission that is required by the URL of the Jar</span></span><br><span class="line"><span class="comment">     * file.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the protocol is "file" and there is an authority component, then</span></span><br><span class="line"><span class="comment">     * permission to connect to and accept connections from that authority</span></span><br><span class="line"><span class="comment">     * may be granted. If the protocol is "file"</span></span><br><span class="line"><span class="comment">     * and the path specifies a file, then permission to read that</span></span><br><span class="line"><span class="comment">     * file is granted. If protocol is "file" and the path is</span></span><br><span class="line"><span class="comment">     * a directory, permission is granted to read all files</span></span><br><span class="line"><span class="comment">     * and (recursively) all files and subdirectories contained in</span></span><br><span class="line"><span class="comment">     * that directory.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the protocol is not "file", then permission</span></span><br><span class="line"><span class="comment">     * to connect to and accept connections from the URL's host is granted.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> codesource the codesource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> NullPointerException if &#123;<span class="doctag">@code</span> codesource&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the permissions granted to the codesource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PermissionCollection <span class="title">getPermissions</span><span class="params">(CodeSource codesource)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        PermissionCollection perms = <span class="keyword">super</span>.getPermissions(codesource);</span><br><span class="line"></span><br><span class="line">        URL url = codesource.getLocation();</span><br><span class="line"></span><br><span class="line">        Permission p;</span><br><span class="line">        URLConnection urlConnection;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            urlConnection = url.openConnection();</span><br><span class="line">            p = urlConnection.getPermission();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException ioe) &#123;</span><br><span class="line">            p = <span class="keyword">null</span>;</span><br><span class="line">            urlConnection = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p <span class="keyword">instanceof</span> FilePermission) &#123;</span><br><span class="line">            <span class="comment">// if the permission has a separator char on the end,</span></span><br><span class="line">            <span class="comment">// it means the codebase is a directory, and we need</span></span><br><span class="line">            <span class="comment">// to add an additional permission to read recursively</span></span><br><span class="line">            String path = p.getName();</span><br><span class="line">            <span class="keyword">if</span> (path.endsWith(File.separator)) &#123;</span><br><span class="line">                path += <span class="string">"-"</span>;</span><br><span class="line">                p = <span class="keyword">new</span> FilePermission(path, SecurityConstants.FILE_READ_ACTION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((p == <span class="keyword">null</span>) &amp;&amp; (url.getProtocol().equals(<span class="string">"file"</span>))) &#123;</span><br><span class="line">            String path = url.getFile().replace(<span class="string">'/'</span>, File.separatorChar);</span><br><span class="line">            path = ParseUtil.decode(path);</span><br><span class="line">            <span class="keyword">if</span> (path.endsWith(File.separator))</span><br><span class="line">                path += <span class="string">"-"</span>;</span><br><span class="line">            p =  <span class="keyword">new</span> FilePermission(path, SecurityConstants.FILE_READ_ACTION);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Not loading from a 'file:' URL so we want to give the class</span></span><br><span class="line"><span class="comment">             * permission to connect to and accept from the remote host</span></span><br><span class="line"><span class="comment">             * after we've made sure the host is the correct one and is valid.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            URL locUrl = url;</span><br><span class="line">            <span class="keyword">if</span> (urlConnection <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">                locUrl = ((JarURLConnection)urlConnection).getJarFileURL();</span><br><span class="line">            &#125;</span><br><span class="line">            String host = locUrl.getHost();</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="keyword">null</span> &amp;&amp; (host.length() &gt; <span class="number">0</span>))</span><br><span class="line">                p = <span class="keyword">new</span> SocketPermission(host,</span><br><span class="line">                                         SecurityConstants.SOCKET_CONNECT_ACCEPT_ACTION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// make sure the person that created this class loader</span></span><br><span class="line">        <span class="comment">// would have this permission</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</span><br><span class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Permission fp = p;</span><br><span class="line">                AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> SecurityException </span>&#123;</span><br><span class="line">                        sm.checkPermission(fp);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">            &#125;</span><br><span class="line">            perms.add(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> perms;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance of URLClassLoader for the specified</span></span><br><span class="line"><span class="comment">     * URLs and parent class loader. If a security manager is</span></span><br><span class="line"><span class="comment">     * installed, the &#123;<span class="doctag">@code</span> loadClass&#125; method of the URLClassLoader</span></span><br><span class="line"><span class="comment">     * returned by this method will invoke the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> SecurityManager.checkPackageAccess&#125; method before</span></span><br><span class="line"><span class="comment">     * loading the class.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs to search for classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent the parent class loader for delegation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the resulting class loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URLClassLoader <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> URL[] urls,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">final</span> ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Save the caller's context</span></span><br><span class="line">        <span class="keyword">final</span> AccessControlContext acc = AccessController.getContext();</span><br><span class="line">        <span class="comment">// Need a privileged block to create the class loader</span></span><br><span class="line">        URLClassLoader ucl = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;URLClassLoader&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URLClassLoader <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> FactoryURLClassLoader(urls, parent, acc);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">return</span> ucl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance of URLClassLoader for the specified</span></span><br><span class="line"><span class="comment">     * URLs and default parent class loader. If a security manager is</span></span><br><span class="line"><span class="comment">     * installed, the &#123;<span class="doctag">@code</span> loadClass&#125; method of the URLClassLoader</span></span><br><span class="line"><span class="comment">     * returned by this method will invoke the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> SecurityManager.checkPackageAccess&#125; before</span></span><br><span class="line"><span class="comment">     * loading the class.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs to search for classes and resources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  NullPointerException if &#123;<span class="doctag">@code</span> urls&#125; is &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the resulting class loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URLClassLoader <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> URL[] urls)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Save the caller's context</span></span><br><span class="line">        <span class="keyword">final</span> AccessControlContext acc = AccessController.getContext();</span><br><span class="line">        <span class="comment">// Need a privileged block to create the class loader</span></span><br><span class="line">        URLClassLoader ucl = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;URLClassLoader&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URLClassLoader <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> FactoryURLClassLoader(urls, acc);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">return</span> ucl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        sun.misc.SharedSecrets.setJavaNetAccess (</span><br><span class="line">            <span class="keyword">new</span> sun.misc.JavaNetAccess() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> URLClassPath <span class="title">getURLClassPath</span> <span class="params">(URLClassLoader u)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> u.ucp;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getOriginalHostName</span><span class="params">(InetAddress ia)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> ia.holder.getOriginalHostName();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        ClassLoader.registerAsParallelCapable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryURLClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ClassLoader.registerAsParallelCapable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FactoryURLClassLoader(URL[] urls, ClassLoader parent,</span><br><span class="line">                          AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>(urls, parent, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FactoryURLClassLoader(URL[] urls, AccessControlContext acc) &#123;</span><br><span class="line">        <span class="keyword">super</span>(urls, acc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// First check if we have permission to access the package. This</span></span><br><span class="line">        <span class="comment">// should go away once we've added support for exported packages.</span></span><br><span class="line">        SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">                sm.checkPackageAccess(name.substring(<span class="number">0</span>, i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name, resolve);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10、MainMethodRunner类详解"><a href="#10、MainMethodRunner类详解" class="headerlink" title="10、MainMethodRunner类详解"></a>10、MainMethodRunner类详解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是一个辅助类，被Launcher使用用来调用main方法，包含main方法的类是使用线线程上下文类加载器加载的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Utility class that is used by &#123;<span class="doctag">@link</span> Launcher&#125;s to call a main method. The class</span></span><br><span class="line"><span class="comment"> * containing the main method is loaded using the thread context class loader.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainMethodRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String mainClassName;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个MainMethodRunner的实例</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> MainMethodRunner&#125; instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mainClass the main class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args incoming arguments</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MainMethodRunner</span><span class="params">(String mainClass, String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.mainClassName = mainClass;</span><br><span class="line">        <span class="comment">// 如果args不为空克隆一份</span></span><br><span class="line">		<span class="keyword">this</span>.args = (args != <span class="keyword">null</span>) ? args.clone() : <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 获取线程上下文类加载器（LauncherURLClassLoader）,通过LauncherURLClassLoader类加载器</span></span><br><span class="line">    <span class="comment">// 加载this.mainClassName实际上就是Start-Class: com.shengsiyuan.boot.MyApplication</span></span><br><span class="line">    <span class="comment">// 加载到虚拟机当中，形成mainClass对象</span></span><br><span class="line">		Class&lt;?&gt; mainClass = Thread.currentThread().getContextClassLoader().loadClass(<span class="keyword">this</span>.mainClassName);</span><br><span class="line">		<span class="comment">// 反射，通过包含了main方法的那个class对象的this.getDeclaredMethod()方法，获取到方法名，和方		// 法参数就能定位到main方法，通过mainMethod调用目标方法</span></span><br><span class="line">        Method mainMethod = mainClass.getDeclaredMethod(<span class="string">"main"</span>, String[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 第一个参数：被调用那个方法所在的对象，这里传null的原因在于main方法是一个静态方法，原则上静态方		  // 法是不归属于当前这个类的，只是把当前这个类作为寄存的一个场所而已</span></span><br><span class="line">        <span class="comment">// 第二个参数：被调用方法接收的参数</span></span><br><span class="line">        <span class="comment">// 当这个main方法真正执行完毕后，真正的就开始启动并且执行</span></span><br><span class="line">        <span class="comment">// 为什么这里会传入null？静态方法本身是不属于这个类的，而是属于这个类所对应的class对象，因此可以传		   // 入null</span></span><br><span class="line">        mainMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; <span class="keyword">this</span>.args &#125;);   </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：为什么SpringBoot要求提供main方法？原因在于SpringBoot应用除了要以jar包的形式java -jar的形式运行之外，也可以在右键运行，如果这个方法是一个main方法的话，显然就可以一个java的形式运行当前这个程序，如果这个方法是一个test方法，是不能运行的，这样就没法在程序或ide中右键用run的方式运行程序入口，SpringBoot之所以要求应用的入口放置一个main方法当中，是基于（既可以以ide运行的方式，也可以通过打jar包的形式运行，两种方式既然不同）。</p>
<h2 id="JDWP远程调试详解"><a href="#JDWP远程调试详解" class="headerlink" title="JDWP远程调试详解"></a>JDWP远程调试详解</h2><h3 id="1、相同的程序，不同的类加载器"><a href="#1、相同的程序，不同的类加载器" class="headerlink" title="1、相同的程序，不同的类加载器"></a>1、相同的程序，不同的类加载器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shengsiyuan.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 输出当前加载MyApplication类的类加载器</span></span><br><span class="line">        <span class="comment">// 问题1：当以命令行的形式或者以控制台的方式运行程序，这行代码输出的内容是什么？</span></span><br><span class="line">        <span class="comment">// 问题2：当把这个程序打成一个jar包，然后用java -jar的形式运行所打的这个jar包</span></span><br><span class="line">        <span class="comment">// 来启动这个应用，这行代码又会输出什么？两次结果是否是一样的？</span></span><br><span class="line">        <span class="comment">// 本质上都是运行这个程序</span></span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们使用以命令行的形式或者以控制台的方式运行程序，使用的是应用类加载器加载当前类的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun.misc.Launcher$AppClassLoader<span class="meta">@b</span>4aac2</span><br></pre></td></tr></table></figure>

<p>当我们以java -jar的形式运行当前程序，使用的类加载器是Spring所提供的LaunchedURLClassLoader类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">D:\Codings\springboot_lecture&gt;gradle bootJar</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in <span class="number">6</span>s</span><br><span class="line"><span class="number">3</span> actionable tasks: <span class="number">1</span> executed, <span class="number">2</span> up-to-date</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;java -jar springboot_lecture-1.0.jar</span><br><span class="line">org.springframework.boot.loader.LaunchedURLClassLoader@197848c</span><br></pre></td></tr></table></figure>

<p>相同的程序运行的形态不一样，输出的类加载器也不一样。</p>
<h3 id="2、JDWP"><a href="#2、JDWP" class="headerlink" title="2、JDWP"></a>2、JDWP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JDWP 是 Java Debug Wire Protocol 的缩写，Java调试协议，它定义了调试器（debugger）和被调试的 Java 虚拟机（target vm）之间的通信协议。</span><br><span class="line"></span><br><span class="line">详情参见：https:<span class="comment">//www.ibm.com/developerworks/cn/java/j-lo-jpda3/index.html</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">   -agentlib:&lt;libname&gt;[=&lt;选项&gt;]</span><br><span class="line">             加载本机代理库 &lt;libname&gt;, 例如 -agentlib:hprof</span><br><span class="line">             另请参阅 -agentlib:jdwp=help 和 -agentlib:hprof=help</span><br><span class="line">   C:\Users\Administrator&gt;java -agentlib:jdwp=help</span><br><span class="line">                  Java Debugger JDWP Agent Library</span><br><span class="line">                  --------------------------------</span><br><span class="line"></span><br><span class="line">     (see http:<span class="comment">//java.sun.com/products/jpda for more information)</span></span><br><span class="line"></span><br><span class="line">   jdwp usage: java -agentlib:jdwp=[help]|[&lt;option&gt;=&lt;value&gt;, ...]</span><br><span class="line"></span><br><span class="line">   Option Name and Value            Description                       Default</span><br><span class="line">   ---------------------            -----------                       -------</span><br><span class="line">   suspend=y|n                      wait on startup?                  y</span><br><span class="line">   transport=&lt;name&gt;                 transport spec                    none</span><br><span class="line">   address=&lt;listen/attach address&gt;  transport spec                    <span class="string">""</span></span><br><span class="line">   server=y|n                       listen <span class="keyword">for</span> debugger?              n</span><br><span class="line">   launch=&lt;command line&gt;            run debugger on event             none</span><br><span class="line">   onthrow=&lt;exception name&gt;         debug on <span class="keyword">throw</span>                    none</span><br><span class="line">   onuncaught=y|n                   debug on any uncaught?            n</span><br><span class="line">   timeout=&lt;timeout value&gt;          <span class="keyword">for</span> listen/attach in milliseconds n</span><br><span class="line">   mutf8=y|n                        output modified utf-<span class="number">8</span>             n</span><br><span class="line">   quiet=y|n </span><br><span class="line">      </span><br><span class="line">   Examples</span><br><span class="line">--------</span><br><span class="line"> - Using sockets connect to a debugger at a specific address:</span><br><span class="line">   java -agentlib:jdwp=transport=dt_socket,address=localhost:<span class="number">8080</span></span><br><span class="line"> - Using sockets listen <span class="keyword">for</span> a debugger to attach:</span><br><span class="line">   java -agentlib:jdwp=transport=dt_socket,server=y,suspend=y</span><br><span class="line">      </span><br><span class="line">   具体说明：</span><br><span class="line">   suspend=y|n暂停挂起                wait on startup是否启动的时候等待）  是</span><br><span class="line">   transport=&lt;name&gt;                 transport spec传输规范             none</span><br><span class="line">   address=&lt;listen/attach address&gt;  transport spec传输规范             <span class="string">""</span></span><br><span class="line">   server=y|n                       listen <span class="keyword">for</span> debugger是否监听调试器    否</span><br></pre></td></tr></table></figure>

<p>JDWP最佳实践</p>
<p>找到spring-boot-loader-2.1.3.RELEASE.jar中的JarLauncher.java，在main方法上加上断点</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C6.JPG" alt=""></p>
<p>命令行中输入以下命令，效果如下图</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">Desktop</span>&gt;<span class="title">java</span> -<span class="title">agentlib:jdwp</span>=<span class="title">transport</span>=<span class="title">dt_socket</span>,<span class="title">server</span>=<span class="title">y</span>,<span class="title">suspend</span>=<span class="title">y</span>,<span class="title">address</span>=50</span></span><br><span class="line"><span class="function">50 -<span class="title">jar</span> <span class="title">springboot_lecture</span>-1.0.<span class="title">jar</span></span></span><br><span class="line"><span class="function"><span class="title">Listening</span> <span class="title">for</span> <span class="title">transport</span> <span class="title">dt_socket</span> <span class="title">at</span> <span class="title">address</span>: 5050</span></span><br></pre></td></tr></table></figure>

<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C7.JPG" alt=""></p>
<p>IDEA中配置，操作步骤如下：</p>
<p>Edit Configuration-&gt;点击左上角+号-&gt;选择Rmote</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C8.JPG" alt=""></p>
<p>点击OK，回到IDEA，选择MyDebug，点击右边Debug按钮</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C9.JPG" alt=""></p>
<p>此时，我们就可以在IDEA以传统的方式进行代码调试</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C10.JPG" alt=""></p>
<p>命令中此时正在监听</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C11.JPG" alt=""></p>
<h2 id="调试spring-boot-loader的启动与加载全流程"><a href="#调试spring-boot-loader的启动与加载全流程" class="headerlink" title="调试spring-boot-loader的启动与加载全流程"></a>调试spring-boot-loader的启动与加载全流程</h2><h2 id="SpringBootApplication注解深度解析"><a href="#SpringBootApplication注解深度解析" class="headerlink" title="@SpringBootApplication注解深度解析"></a>@SpringBootApplication注解深度解析</h2><p>Spring Boot启动流程（Spring Boot底层源码分析） </p>
<p>MyApplication.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/api"</span>, produces = MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyConfigBean myConfigBean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;myConfig.myObject.myName&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String myName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;myConfig.myObject.myAge&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> myAge;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/person"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">getPerson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setId(<span class="number">1</span>);</span><br><span class="line">        person.setName(<span class="string">"张三"</span>);</span><br><span class="line">        person.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">this</span>.myName);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.myAge);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"---"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(myConfigBean.getMyName());</span><br><span class="line">        System.out.println(myConfigBean.getMyAge());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>右键运行这段代码，这是每个初学Spring Boot的人都会去做的一件事情，但是有没有想过，当我们去启动main方法的时候，这个应用就算已经正常的启动了，用户可以通过浏览器去输入我们在Controller里面所自定义的某一个Controller上面相关的url，相应的方法就会执行，控制器就已经发挥作用了，MyApplication是我们程序的入口类，MyApplication实际上与MyController之间从源码上并没有任何直接的关联关系，但是当我们在IDEA右键运行的时候，用户就可以通过事先所预置的url，就能成功的去访问Controller里面特定的执行方法，看起来是一个停神奇的事情，这也会给很多Spring Boot初学者带来一种错觉，会认为Spring Boot就是这么简单，我们使用起来把一些注解配置好，程序就可以正常的去启动。 如果按照这种方式理解没有任何问题，有没有更深层次的思考，它们是怎么就能关联起来？</p>
<p>如果把@SpringBootApplication注解注释掉呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.ApplicationContextException: Unable to start web server; nested exception is org.springframework.context.ApplicationContextException: Unable to start ServletWebServerApplicationContext due to missing ServletWebServerFactory bean.</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:<span class="number">156</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:<span class="number">544</span>) ~[spring-context-<span class="number">5.2</span><span class="number">.4</span>.RELEASE.jar:<span class="number">5.2</span><span class="number">.4</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:<span class="number">141</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:<span class="number">747</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:<span class="number">397</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:<span class="number">315</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:<span class="number">1226</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.SpringApplication.run(SpringApplication.java:<span class="number">1215</span>) [spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at com.shengsiyuan.boot.MyApplication.main(MyApplication.java:<span class="number">45</span>) [main/:na]</span><br><span class="line">Caused by: org.springframework.context.ApplicationContextException: Unable to start ServletWebServerApplicationContext due to missing ServletWebServerFactory bean.</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.getWebServerFactory(ServletWebServerApplicationContext.java:<span class="number">203</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.createWebServer(ServletWebServerApplicationContext.java:<span class="number">179</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:<span class="number">153</span>) ~[spring-boot-<span class="number">2.2</span><span class="number">.5</span>.RELEASE.jar:<span class="number">2.2</span><span class="number">.5</span>.RELEASE]</span><br><span class="line">	... <span class="number">8</span> common frames omitted</span><br></pre></td></tr></table></figure>

<p>根本原因在于缺少ServletWebServerFactory bean对象，导致程序异常退出。</p>
<p>@SpringBootApplication注解对于整个Spring Boot或Spring Cloud的技术体系来说是特别的重要（整个Spring Boot或Spring Cloud一整套微服务技术栈，本质上就是围绕着一系列的注解来展开的，注解在整个微服务的框架当中，扮演着特别重要的作用）。</p>
<h3 id="1、Spring-Boot启动过程分析"><a href="#1、Spring-Boot启动过程分析" class="headerlink" title="1、Spring Boot启动过程分析"></a>1、Spring Boot启动过程分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>首先看这行代码，代码执行流程是，通过SpringApplication这个类的run方法（静态方法），第一个参数是传入当前main方法所在类的class对象，第二个参数是把main方法字符串数组这个参数传递进去，整个应用就已经启动了 ，在实际应用当中，这种场景非常多，但这种应用场景只是一种非常简便的，给开发人员提供一种默认的各种设置简便的启动方式，对于Spring Boot来说，里面的配置信息实际都可能通过两种方式去改变的。</p>
<p>第一种方式：通过配置文件的（yml、properties）的形式</p>
<p>第二种方式：通过程序编码的方式</p>
<p>两种方式各有各的优势，没有谁好谁不好的区分</p>
<p>注释掉SpringApplication.run(MyApplication.class, args);这行代码，可以按照分步的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shengsiyuan.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.Banner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    JDWP：Java Debug Wire Protocol，Java调试协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        <span class="comment">// SpringApplication.run(MyApplication.class, args);</span></span><br><span class="line">        SpringApplication springApplication = <span class="keyword">new</span> SpringApplication(MyApplication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        springApplication.setBannerMode(Banner.Mode.OFF);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> new SpringApplication()的一个对象，参数就是当前这个类的class对象，这样就生成一个SpringApplication的一个实例，这个实例一旦生成好以后，就可以在程序中以编码的形式改变或修改它默认的很多配置，当我们去调用set的时候，里面有很多各种各样的set方法，我们可以找到setBannerMode()方法，设置好Banner的一种模式，</p>
<p><img src="E:%5C%E6%88%91%E7%9A%84%E6%96%87%E6%A1%A3%5C%E7%B2%BE%E9%80%9ASpringBoot%E4%B8%8ECloud%5Cimages%5C12.png" alt=""></p>
<p>Banner.Mode源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * An enumeration of possible values for configuring the Banner.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">enum</span> Mode &#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Disable printing of the banner.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		OFF,</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Print the banner to System.out.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		CONSOLE,</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Print the banner to the log file.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		LOG</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>Banner.Mode是一个枚举，有三个可选的对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OFF：不打印banner</span><br><span class="line"></span><br><span class="line">CONSOLE：将banner打印至标准输出控制台（这是系统默认的）</span><br><span class="line"></span><br><span class="line">LOG：打印至日志文件中</span><br></pre></td></tr></table></figure>

<p>选择OFF即不打印Banner的信息，当设置好Banner的信息后就可启动springApplication，调用springApplication的run方法。</p>
<p>springApplication.run(args)中的run方法不是一个静态方法，而是一个实例方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Run the Spring application, creating and refreshing a new</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> ApplicationContext&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the application arguments (usually passed from a Java main method)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a running &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">		StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">		stopWatch.start();</span><br><span class="line">		ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">		Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		configureHeadlessProperty();</span><br><span class="line">		SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">		listeners.starting();</span><br><span class="line">		...中间省略</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>SpringApplication.run(MyApplication.class, args)中的run方法是一个静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Static helper that can be used to run a &#123;<span class="doctag">@link</span> SpringApplication&#125; from the</span></span><br><span class="line"><span class="comment">	 * specified source using default settings.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> primarySource the primary source to load</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args the application arguments (usually passed from a Java main method)</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the running &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class&lt;?&gt; primarySource, String... args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> run(<span class="keyword">new</span> Class&lt;?&gt;[] &#123; primarySource &#125;, args);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>注意：SpringApplication.run(MyApplication.class, args);中的run方法与springApplication.run(args);中的run方法不是同一个run方法，本质上完成的功能是一样的。 </p>
<p>此时代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(MyApplication<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        <span class="comment">// SpringApplication.run(MyApplication.class, args);</span></span><br><span class="line">        SpringApplication springApplication = <span class="keyword">new</span> SpringApplication(MyApplication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        springApplication.setBannerMode(Banner.Mode.OFF);</span><br><span class="line">        springApplication.run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>右键运行示例代码，输出日志信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; Task :compileJava UP-TO-DATE</span><br><span class="line">&gt; Task :processResources UP-TO-DATE</span><br><span class="line">&gt; Task :classes UP-TO-DATE</span><br><span class="line"></span><br><span class="line">&gt; Task :MyApplication.main()</span><br><span class="line">sun.misc.Launcher$AppClassLoader@<span class="number">1</span>d16e93</span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">23</span>:<span class="number">05</span>:<span class="number">24.710</span>  INFO <span class="number">12348</span> --- [           main] com.shengsiyuan.boot.MyApplication       : Starting MyApplication on GKF4FAXCIZLZ3HL with PID <span class="number">12348</span> (D:\Codings\springboot_lecture\build\classes\java\main started by Administrator in D:\Codings\springboot_lecture)</span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">23</span>:<span class="number">05</span>:<span class="number">24.717</span>  INFO <span class="number">12348</span> --- [           main] com.shengsiyuan.boot.MyApplication       : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">23</span>:<span class="number">05</span>:<span class="number">26.662</span>  INFO <span class="number">12348</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 9090 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.680  INFO 12348 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.681  INFO 12348 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.31]</span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.924  INFO 12348 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2020-03-17 23:05:26.925  INFO 12348 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 2124 ms</span></span><br><span class="line"><span class="function">2020-03-17 23:05:27.209  INFO 12348 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2020-03-17 23:05:27.640  INFO 12348 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 9090 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2020-03-17 23:05:27.644  INFO 12348 --- [           main] com.shengsiyuan.boot.MyApplication       : Started MyApplication in 3.982 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">4.6</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>此时并没有打印出banner的信息，说明配置已经是生效的。</p>
<h3 id="2、-SpringBootApplication深入解析"><a href="#2、-SpringBootApplication深入解析" class="headerlink" title="2、@SpringBootApplication深入解析"></a>2、@SpringBootApplication深入解析</h3><p>标识着一个配置类声明了一个或多个@Bean方法并且还会触发自动配置和组件扫描两个功能，这是一个很便捷的注解，它等价于或相当于同时声明了@Configuration，@EnableAutoConfiguration，@ComponentScan。</p>
<h3 id="3、-SpringBootConfiguration深入解析"><a href="#3、-SpringBootConfiguration深入解析" class="headerlink" title="3、@SpringBootConfiguration深入解析"></a>3、@SpringBootConfiguration深入解析</h3><p>标识着一个类提供了Spring Boot应用的@Configuration(表示当前类是一个配置类)，可以用作一个替代方案，<br>对于Spring标准的@Configuration注解，这样的话配置就能自动的探寻到或被发现。<br>应用应该只包含一个@SpringBootConfiguration，大多数的一些惯常的Spring Boot应用都会从@SpringBootConfiguration中继承过来。</p>
<h3 id="4、-Configuration深入解析"><a href="#4、-Configuration深入解析" class="headerlink" title="4、@Configuration深入解析"></a>4、@Configuration深入解析</h3><p>用于标识一个类声明了一个或多个@Bean方法，并且可以被Spring容器进行处理生成bean的定义以及服务的请求<br>针对于一些在运行期的时候的bean，示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"> 	<span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// instantiate, configure and return bean ... 实例化，配置与返回这个bean</span></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="启动-Configuration类"><a href="#启动-Configuration类" class="headerlink" title="启动@Configuration类"></a>启动@Configuration类</h5><h6 id="通过AnnotationConfigApplicationContext方式"><a href="#通过AnnotationConfigApplicationContext方式" class="headerlink" title="通过AnnotationConfigApplicationContext方式"></a>通过AnnotationConfigApplicationContext方式</h6><p> @Configuration类通常是通过AnnotationConfigApplicationContext或者它web相关变种<br> AnnotationConfigWebApplicationContext启动的，对于前者一种简单的示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">   ctx.register(AppConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">   ctx.refresh();</span><br><span class="line">   MyBean myBean = ctx.getBean(MyBean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">   <span class="comment">// use myBean ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 非常经典示例，首先创建一个AnnotationConfigApplicationContext的对象，然后将AppConfig配置类注册</span></span><br><span class="line"><span class="comment">// 到AnnotationConfigApplicationContext应用上下文上，注册完以后刷新，就可以从上下文当中把里面特定的</span></span><br><span class="line"><span class="comment">// 方法的bean信息获取到，最后就可以使用bean。</span></span><br></pre></td></tr></table></figure>

<h6 id="通过Spring-60-bean-62-XML方式"><a href="#通过Spring-60-bean-62-XML方式" class="headerlink" title="通过Spring&#60;bean&#62;XML方式"></a>通过Spring&#60;bean&#62;XML方式</h6><p>作为直接针对注解configapplicationcontext注册@Configuration类的替代方案，@Configuration类可以在Spring XML文件中声明为普通的<bean>定义:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.acme.AppConfig"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在上面的示例当中，&#60;context:annotation-config/&#62;是必需的，为了方便启用ConfigurationClassPostProcessor和其他与注解相关的后置处理器，它们可以使得@Configuration类的处理成为可能。</p>
<h6 id="通过组件扫描方式"><a href="#通过组件扫描方式" class="headerlink" title="通过组件扫描方式"></a>通过组件扫描方式</h6><p>@Configuration使用@Component进行元注解，因此@Configuration类是可以进行组件扫描的(通常使用Spring XML的&#60;context:component-scan/&#62;的元素)，并且因此也可以充分利用@Autowired/@Inject像任何常规的@Component一样。特别是，如存在单个的构方法，自动装配语义会透明地应用于该构造函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> SomeBean someBean;</span><br><span class="line"> </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">AppConfig</span><span class="params">(SomeBean someBean)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.someBean = someBean;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// @Bean definition using "SomeBean"</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>@Configuration类不仅可以使用组件扫描的方式来启动，而且本身还可以使用@ComponentScan注解来配置组件扫描:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"com.acme.app.services"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">// various @Bean definitions ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有关详细信息，请参见@ComponentScan javadocs。</p>
<h5 id="与外部的值搭配使用"><a href="#与外部的值搭配使用" class="headerlink" title="与外部的值搭配使用"></a>与外部的值搭配使用</h5><h6 id="使用环境API"><a href="#使用环境API" class="headerlink" title="使用环境API"></a>使用环境API</h6><p>外部的值是可以通过注入 spring的org.springframework.core.env.Environment注入到 @Configuration类里面使用，例如，使用@Autowired注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">      <span class="meta">@Autowired</span> Environment env;</span><br><span class="line"> </span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          MyBean myBean = <span class="keyword">new</span> MyBean();</span><br><span class="line">          myBean.setName(env.getProperty(<span class="string">"bean.name"</span>));</span><br><span class="line">          <span class="keyword">return</span> myBean;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>通过Environment解析的属性位于一个或多个“property source”对象中，而且@Configuration类还可以贡献属性源到环境对象中，使用@PropertySource注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@PropertySource</span>(<span class="string">"classpath:/com/acme/app.properties"</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Inject</span> Environment env;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> MyBean(env.getProperty(<span class="string">"bean.name"</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>有关更多细节，请参见环境和@PropertySource javadocs。</p>
<h6 id="使用-Value注解"><a href="#使用-Value注解" class="headerlink" title="使用@Value注解"></a>使用@Value注解</h6><p>外部值可以使用@Value注解注入到@Configuration类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:/com/acme/app.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;bean.name&#125;"</span>) String beanName;</span><br><span class="line">  </span><br><span class="line">     <span class="meta">@Bean</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     	<span class="keyword">return</span> <span class="keyword">new</span> MyBean(beanName);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式通常与Spring的PropertySourcesPlaceholderConfigurer搭配一起使用,可以自动启用XML配置通过&lt;context:property-placeholder / &gt;或@Configuration类中显式地通过一个专门的静态@Bean方法(见“关于beanfactorypostprocessor-returning@Bean方法的说明)。但是请注意，只有在需要自定义配置(如占位符语法等)时，才需要通过静态@Bean方法显式注册PropertySourcesPlaceholderConfigurer。具体地说，如果没有bean后处理器(例如PropertySourcesPlaceholderConfigurer)为ApplicationContext注册了嵌入式值解析器，Spring将注册一个默认的嵌入式值解析器，它将对环境中注册的属性源解析占位符。请参阅下面关于使用@ImportResource用Spring XML组合@Configuration类的部分;参见@Value javadocs;有关使用诸如PropertySourcesPlaceholderConfigurer之类的BeanFactoryPostProcessor类型的详细信息，请参阅@Bean javadocs。</p>
<h5 id="组合-Configuration类"><a href="#组合-Configuration类" class="headerlink" title="组合@Configuration类"></a>组合@Configuration类</h5><h6 id="使用-Import注解"><a href="#使用-Import注解" class="headerlink" title="使用@Import注解"></a>使用@Import注解</h6><p>@Configuration类是可以使用@Import注解进行组合，类似于Spring XML文件中的<import>标签。由于@Configuration对象是在容器中作为Spring bean来管理的，因此被导入的配置一定可以被注入——例如，通过构造器注入:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// instantiate, configure and return DataSource</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(DatabaseConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseConfig dataConfig;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppConfig</span><span class="params">(DatabaseConfig dataConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dataConfig = dataConfig;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// reference the dataSource() bean method</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean(dataConfig.dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在AppConfig和被导入的DatabaseConfig都可以通过在Spring上下文中注册AppConfig来启动:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> AnnotationConfigApplicationContext(AppConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<h6 id="使用-Profile注解"><a href="#使用-Profile注解" class="headerlink" title="使用@Profile注解"></a>使用@Profile注解</h6><p>@Configuration类可以被@Profile注解所标记，用来表示它们被处理当一个给定profile或多个profiles被激活的时候才处理它们:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"development"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedDatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// instantiate, configure and return embedded DataSource</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"production"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductionDatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// instantiate, configure and return production DataSource</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者，您也可以在@Bean方法级别声明配置文件条件——例如，对于同一个配置类中的可选bean变体:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDatabaseConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</span><br><span class="line">       <span class="meta">@Profile</span>(<span class="string">"development"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">public</span> DataSource <span class="title">embeddedDatabase</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</span><br><span class="line">       <span class="meta">@Profile</span>(<span class="string">"production"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">public</span> DataSource <span class="title">productionDatabase</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>参见@Profile和org.springframework.core.env。环境javadocs以获得更多细节。</p>
<h6 id="使用Spring-XML中-ImportResource注解"><a href="#使用Spring-XML中-ImportResource注解" class="headerlink" title="使用Spring XML中@ImportResource注解"></a>使用Spring XML中@ImportResource注解</h6><p>如上所述，@Configuration类可以被声明作为Spring XML文件中的常规Spring <bean>定义。还可以使用@ImportResource注解将Spring XML配置文件导入@Configuration类。可以注入从XML导入的Bean定义——例如，使用@Inject注释:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">   <span class="meta">@ImportResource</span>(<span class="string">"classpath:/com/acme/database-config.xml"</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Inject</span> DataSource dataSource; <span class="comment">// from XML</span></span><br><span class="line">  </span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="comment">// inject the XML-defined dataSource bean</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> MyBean(<span class="keyword">this</span>.dataSource);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h6 id="使用嵌套的-Configuration类"><a href="#使用嵌套的-Configuration类" class="headerlink" title="使用嵌套的@Configuration类"></a>使用嵌套的@Configuration类</h6><p>@Configuration类可以相互嵌套，如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Inject</span> DataSource dataSource;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseConfig</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function">DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedDatabaseBuilder().build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当启动这种情况的时候，只有AppConfig需要注册到应用上下文中。对于一个嵌套的@Configuration类来说，DatabaseConfig将会被自动的注册。这样就避免了使用@Import注解的需要，当这种AppConfig与DatabaseConfig之间的关系已经是比较隐式很清晰的。</p>
<p>还请注意，嵌套的@Configuration类可以用于很好的影响@Profile注解去提供相同的bean的两种选择，对于外层的@Configuration来说。</p>
<h5 id="延迟初始化配置"><a href="#延迟初始化配置" class="headerlink" title="延迟初始化配置"></a>延迟初始化配置</h5>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/" data-id="ck7xcdrqh0005q0vlbrfv8z6g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/03/18/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/18/%E7%B2%BE%E9%80%9ASpring%20Boot%E4%B8%8ECloud/">精通Spring Boot与Cloud</a>
          </li>
        
          <li>
            <a href="/2020/03/18/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2020/03/18/Windows%E4%B8%8BCmder%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/">Windows下Cmder的配置与使用</a>
          </li>
        
          <li>
            <a href="/2020/03/18/jar%E6%96%87%E4%BB%B6%E8%A7%84%E8%8C%83/">jar文件规范</a>
          </li>
        
          <li>
            <a href="/2020/03/18/Solr%20schema.xml%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/">Solr schema.xml配置详解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 xiaohua<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>